<!DOCTYPE html>
<html lang="zh-CN" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG Forwarder Pro</title>
    
    <!-- 1. å­—ä½“: Inter -->
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    
    <!-- 2. Tailwind CSS æ ¸å¿ƒ (å…³é”®ä¿®å¤ï¼šä½¿ç”¨ onload å›è°ƒ) -->
    <script src="https://cdn.tailwindcss.com" onload="initTailwind()"></script>
    
    <script>
        // åªæœ‰å½“ Tailwind è„šæœ¬åŠ è½½å®Œæˆåï¼Œè¿™ä¸ªå‡½æ•°æ‰ä¼šè¢«è°ƒç”¨
        function initTailwind() {
            if (typeof tailwind === 'undefined') {
                console.error("Tailwind CSS åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯è¢«æµè§ˆå™¨æ’ä»¶æ‹¦æˆªã€‚");
                return;
            }
            
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        fontFamily: { sans: ['Inter', 'sans-serif'] },
                        colors: {
                            gray: {
                                750: '#2d3748',
                                850: '#1f2937',
                                900: '#111827',
                                950: '#030712',
                            }
                        }
                    }
                }
            };
            console.log("Tailwind é…ç½®å·²åº”ç”¨");
        }
    </script>

    <!-- 3. è‡ªå®šä¹‰æ ·å¼ -->
    <style type="text/tailwindcss">
        [x-cloak] { display: none !important; }
        
        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { @apply bg-gray-300 dark:bg-gray-700 rounded-full; }
        
        /* æ»‘å— */
        input[type=range] { 
            -webkit-appearance: none; appearance: none; background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            @apply bg-blue-600 cursor-pointer shadow-sm mt-[-6px];
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; 
            @apply bg-gray-200 dark:bg-gray-700 rounded-full;
        }

        /* ç»„ä»¶ç±» */
        .form-input, .form-textarea {
            @apply w-full px-4 py-2.5 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm transition-all placeholder-gray-400 dark:placeholder-gray-500;
        }
        
        .card {
            @apply bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm transition-all duration-200;
        }
        .card-hover {
            @apply hover:shadow-md hover:border-gray-300 dark:hover:border-gray-600;
        }
    </style>
</head>

<body 
    x-data="app()" 
    x-init="initApp()" 
    class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 transition-colors duration-300 min-h-screen flex flex-col selection:bg-blue-500 selection:text-white"
    :class="{ 'dark': theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) }"
>

    <!-- Toast é€šçŸ¥ -->
    <div class="fixed top-6 right-6 z-50 space-y-3 pointer-events-none">
        <template x-for="toast in toasts" :key="toast.id">
            <div 
                x-show="toast.visible"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-x-8"
                x-transition:enter-end="opacity-100 translate-x-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-x-0"
                x-transition:leave-end="opacity-0 translate-x-8"
                class="pointer-events-auto w-80 bg-white dark:bg-gray-800 shadow-xl rounded-xl border border-gray-100 dark:border-gray-700 overflow-hidden"
            >
                <div class="p-4 flex items-start gap-3">
                    <div class="flex-shrink-0 mt-0.5">
                        <svg x-show="toast.type === 'success'" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <svg x-show="toast.type === 'error'" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100" x-text="toast.title"></h3>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400 leading-relaxed" x-text="toast.message"></p>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- ç™»å½•é®ç½© -->
    <div x-show="!authenticated" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/70 backdrop-blur-md p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-sm border border-gray-200 dark:border-gray-700" @click.outside="$refs.pwd.focus()">
            <div class="text-center mb-8">
                <div class="w-14 h-14 bg-blue-50 dark:bg-blue-900/20 rounded-2xl flex items-center justify-center mx-auto mb-5 text-blue-600 dark:text-blue-400 ring-1 ring-blue-100 dark:ring-blue-800">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">èº«ä»½éªŒè¯</h2>
                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">è¯·è¾“å…¥ <code>config.yaml</code> ä¸­è®¾ç½®çš„å¯†ç </p>
            </div>
            <form @submit.prevent="login">
                <div class="space-y-4">
                    <input x-ref="pwd" type="password" x-model="password" class="form-input px-5 py-3 text-base text-center tracking-widest" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    <button type="submit" :disabled="loading" class="w-full py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg shadow-blue-500/30 transition-all active:scale-[0.98] disabled:opacity-70 disabled:cursor-not-allowed flex justify-center items-center">
                        <span x-show="!loading">è§£é”é¢æ¿</span>
                        <svg x-show="loading" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div x-show="authenticated" x-cloak class="flex-grow flex flex-col">
        
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="sticky top-0 z-40 bg-white/80 dark:bg-gray-950/80 backdrop-blur-xl border-b border-gray-200 dark:border-gray-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <!-- Logo -->
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-blue-500/20">TG</div>
                        <span class="font-bold text-xl tracking-tight hidden sm:block">Forwarder</span>
                    </div>
                    
                    <!-- æ¡Œé¢ Tab (å±…ä¸­) -->
                    <div class="hidden md:flex space-x-1 bg-gray-100/50 dark:bg-gray-800/50 p-1.5 rounded-xl border border-gray-200/50 dark:border-gray-700/50 absolute left-1/2 transform -translate-x-1/2">
                        <template x-for="tab in tabs" :key="tab.id">
                            <button 
                                @click="currentTab = tab.id" 
                                :class="currentTab === tab.id ? 'bg-white dark:bg-gray-700 shadow-sm text-blue-600 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-200/50 dark:hover:bg-gray-700/50'"
                                class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all duration-200"
                                x-text="tab.name"
                            ></button>
                        </template>
                    </div>

                    <!-- å³ä¾§å·¥å…·æ  -->
                    <div class="flex items-center gap-3">
                        <button x-show="needsReload" @click="showToast('æç¤º', 'é…ç½®å·²ä¿å­˜ï¼Œè¯·åœ¨ Telegram ä¸­å‘é€ /reload ç”Ÿæ•ˆ', 'success')" class="hidden sm:flex items-center gap-1.5 text-xs bg-yellow-50 dark:bg-yellow-900/20 text-yellow-600 dark:text-yellow-400 px-3 py-1.5 rounded-full font-bold border border-yellow-100 dark:border-yellow-800/50 animate-pulse hover:animate-none transition-colors cursor-pointer">
                            <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                            é…ç½®å·²æ›´æ”¹
                        </button>
                        <button @click="toggleTheme" class="p-2 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <span x-show="theme === 'light'">â˜€ï¸</span>
                            <span x-show="theme === 'dark'">ğŸŒ™</span>
                            <span x-show="theme === 'system'">ğŸ’»</span>
                        </button>
                    </div>
                </div>
            </div>
            <!-- ç§»åŠ¨ç«¯ Tab -->
            <div class="md:hidden border-t border-gray-200 dark:border-gray-800 overflow-x-auto scrollbar-hide">
                <div class="flex px-4 py-1 space-x-2 min-w-max">
                    <template x-for="tab in tabs" :key="tab.id">
                        <button @click="currentTab = tab.id" :class="currentTab === tab.id ? 'text-blue-600 dark:text-blue-400 border-b-2 border-blue-600 dark:border-blue-400' : 'text-gray-500 dark:text-gray-400 border-b-2 border-transparent'" class="text-sm font-medium py-3 px-2 transition-colors" x-text="tab.name"></button>
                    </template>
                </div>
            </div>
        </nav>

        <!-- å†…å®¹åŒºåŸŸ -->
        <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Loading -->
            <div x-show="loadingData" class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-pulse">
                <div class="h-32 bg-gray-200 dark:bg-gray-800 rounded-xl"></div>
                <div class="h-32 bg-gray-200 dark:bg-gray-800 rounded-xl"></div>
                <div class="h-32 bg-gray-200 dark:bg-gray-800 rounded-xl"></div>
            </div>

            <!-- Tab 1: çŠ¶æ€ -->
            <div x-show="currentTab === 'status' && !loadingData" x-transition.opacity.duration.300ms class="space-y-8">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="card p-5 flex flex-col justify-between card-hover"><dt class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">å»é‡å“ˆå¸Œ</dt><dd class="mt-2 text-2xl font-bold text-gray-900 dark:text-white" x-text="stats.dedup_hashes || 0"></dd></div>
                    <div class="card p-5 flex flex-col justify-between card-hover"><dt class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">é¢‘é“è¿›åº¦</dt><dd class="mt-2 text-2xl font-bold text-indigo-600 dark:text-indigo-400" x-text="stats.forward_progress_channels || 0"></dd></div>
                    <div class="card p-5 flex flex-col justify-between card-hover"><dt class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">å¤±æ•ˆé“¾æ¥</dt><dd class="mt-2 text-2xl font-bold text-red-600 dark:text-red-400" x-text="stats.invalid_links || 0"></dd></div>
                    <div class="card p-5 flex flex-col justify-between card-hover"><dt class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">æ´»è·ƒç›‘æ§æº</dt><dd class="mt-2 text-2xl font-bold text-blue-600 dark:text-blue-400" x-text="stats.sources || 0"></dd></div>
                    <div class="card p-5 flex flex-col justify-between card-hover"><dt class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">åˆ†å‘è§„åˆ™</dt><dd class="mt-2 text-2xl font-bold text-emerald-600 dark:text-emerald-400" x-text="stats.distribution_rules || 0"></dd></div>
                    <div class="card p-5 flex flex-col justify-between card-hover"><dt class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">é»‘ / ç™½åå•</dt><dd class="mt-2 text-2xl font-bold text-gray-700 dark:text-gray-300"><span x-text="(stats.blacklist_substring + stats.blacklist_word + stats.blacklist_file + stats.blacklist_regex) || 0"></span><span class="text-gray-300 dark:text-gray-600 mx-1">/</span><span x-text="stats.whitelist_keywords || 0"></span></dd></div>
                </div>
                <div class="card p-8">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2"><svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>æ•°æ®åº“ç»´æŠ¤</h3>
                    <div class="max-w-2xl"><div class="flex justify-between mb-4"><label class="text-sm font-medium text-gray-700 dark:text-gray-300">å»é‡è®°å½•ä¿ç•™æ—¶é—´</label><div class="px-3 py-1 rounded bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-xs font-bold font-mono" x-text="settings.dedup_retention_days + ' å¤©'"></div></div><input type="range" min="1" max="30" x-model="settings.dedup_retention_days" @change="saveSettings" class="w-full mb-4"><div class="text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 p-3 rounded-lg border border-gray-100 dark:border-gray-700"><p>ğŸ’¡ å»ºè®®ä¿ç•™ 30 å¤©ã€‚å‡å°‘å¤©æ•°å¯ä»¥æ˜¾è‘—é™ä½ <code>forwarder.sqlite</code> æ•°æ®åº“çš„ä½“ç§¯ã€‚è®¾ç½®å°†åœ¨æ¯å¤©å‡Œæ™¨ 4:05 (UTC) çš„ç»´æŠ¤ä»»åŠ¡ä¸­è‡ªåŠ¨åº”ç”¨ã€‚</p></div></div>
                </div>
            </div>

            <!-- Tab 2: ç›‘æ§æº -->
            <div x-show="currentTab === 'sources' && !loadingData" class="space-y-6">
                <div class="card p-6 flex flex-col sm:flex-row gap-4 justify-between items-end sm:items-center">
                    <div><h3 class="text-lg font-bold">ç›‘æ§æºåˆ—è¡¨</h3><p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Bot å°†ç›‘å¬è¿™äº›é¢‘é“/ç¾¤ç»„çš„æ¶ˆæ¯å¹¶è¿›è¡Œè½¬å‘ã€‚</p></div>
                    <div class="flex w-full sm:w-auto gap-2"><input x-model="newSource" @keyup.enter="addSource" type="text" placeholder="é¢‘é“ID / @username / é“¾æ¥" class="form-input flex-1 sm:w-64"><button @click="addSource" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition-colors shadow-sm whitespace-nowrap">æ·»åŠ æº</button></div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="source in rules.sources" :key="source.identifier">
                        <div class="card p-4 flex flex-col justify-between hover:border-blue-300 dark:hover:border-blue-700 transition-colors group relative">
                            <div>
                                <div class="flex items-start justify-between"><span class="font-mono font-bold text-gray-800 dark:text-gray-200 text-sm break-all pr-8" x-text="source.identifier"></span><div class="flex-shrink-0"><span x-show="source.resolved_id" class="text-[10px] px-1.5 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded font-bold">æ­£å¸¸</span><span x-show="!source.resolved_id" class="text-[10px] px-1.5 py-0.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 rounded font-bold animate-pulse">å¾…è§£æ</span></div></div>
                                <div class="mt-3 text-xs text-gray-500 dark:text-gray-400 font-mono bg-gray-50 dark:bg-gray-900/50 p-2 rounded border border-gray-100 dark:border-gray-700/50 truncate"><span class="select-all" x-text="source.resolved_id || 'ç­‰å¾… Reload...'"></span></div>
                            </div>
                            <button @click="removeSource(source.identifier)" class="absolute top-3 right-3 text-gray-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    </template>
                    <div x-show="rules.sources.length === 0" class="col-span-full text-center py-12 bg-white dark:bg-gray-800 rounded-xl border border-dashed border-gray-300 dark:border-gray-700"><p class="text-gray-500 dark:text-gray-400">æš‚æ— ç›‘æ§æºï¼Œè¯·åœ¨ä¸Šæ–¹æ·»åŠ ã€‚</p></div>
                </div>
            </div>

            <!-- Tab 3: è§„åˆ™ -->
            <div x-show="currentTab === 'rules' && !loadingData" class="space-y-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-6">æ·»åŠ è½¬å‘è§„åˆ™</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1.5">è§„åˆ™åç§° <span class="text-red-500">*</span></label><input x-model="newRule.name" type="text" placeholder="å¦‚: æ¬è¿è§†é¢‘" class="form-input"></div><div><label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1.5">ç›®æ ‡ ID <span class="text-red-500">*</span></label><input x-model="newRule.target" type="text" placeholder="-100... æˆ– @channel" class="form-input"></div><div><label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1.5">Topic ID (å¯é€‰)</label><input x-model="newRule.topic" type="number" placeholder="å¦‚: 1" class="form-input"></div></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1.5">å¿…é¡»åŒ…å« (All Keywords)</label><textarea x-model="newRule.keywords" rows="3" placeholder="æ¯è¡Œä¸€ä¸ª" class="form-textarea text-xs"></textarea></div><div><label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1.5">ä»»ä¸€åŒ…å« (Any Keywords)</label><textarea x-model="newRule.any_keywords" rows="3" placeholder="æ¯è¡Œä¸€ä¸ª" class="form-textarea text-xs"></textarea></div><div><label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1.5">æ–‡ä»¶åæ­£åˆ™ (Regex)</label><textarea x-model="newRule.files" rows="3" placeholder="å¦‚ *.apk" class="form-textarea text-xs"></textarea></div><div><label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1.5">MIME ç±»å‹</label><textarea x-model="newRule.types" rows="3" placeholder="å¦‚ video/mp4" class="form-textarea text-xs"></textarea></div></div>
                        <div class="flex justify-end pt-2"><button @click="addRule" class="bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 px-6 py-2 rounded-lg font-bold text-sm hover:opacity-90 transition-opacity shadow-lg">ä¿å­˜è§„åˆ™</button></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <template x-for="rule in rules.distribution_rules" :key="rule.name">
                        <div class="card p-5 flex flex-col justify-between relative group hover:border-blue-300 dark:hover:border-blue-700">
                            <div>
                                <div class="flex justify-between items-start mb-2"><h4 class="font-bold text-base text-gray-900 dark:text-gray-100" x-text="rule.name"></h4></div>
                                <div class="flex flex-wrap gap-2 mb-4"><span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 border border-blue-100 dark:border-blue-800"><span class="mr-1 opacity-70">TO:</span><span x-text="rule.target_identifier"></span></span><span x-show="rule.topic_id" class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 border border-purple-100 dark:border-purple-800"><span class="mr-1 opacity-70">TOPIC:</span><span x-text="rule.topic_id"></span></span></div>
                                <div class="space-y-2 text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-900/50 p-3 rounded-lg border border-gray-100 dark:border-gray-700/50">
                                    <div x-show="rule.all_keywords?.length" class="flex gap-2"><span class="font-mono font-bold text-gray-400 w-8">ALL:</span> <span x-text="rule.all_keywords.join(', ')"></span></div>
                                    <div x-show="rule.any_keywords?.length" class="flex gap-2"><span class="font-mono font-bold text-gray-400 w-8">ANY:</span> <span x-text="rule.any_keywords.join(', ')"></span></div>
                                    <div x-show="rule.file_name_patterns?.length" class="flex gap-2"><span class="font-mono font-bold text-gray-400 w-8">FILE:</span> <span x-text="rule.file_name_patterns.join(', ')"></span></div>
                                    <div x-show="!rule.all_keywords?.length && !rule.any_keywords?.length && !rule.file_name_patterns?.length" class="italic opacity-50">æ— è¿‡æ»¤æ¡ä»¶ (å…¨éƒ¨è½¬å‘)</div>
                                </div>
                            </div>
                            <button @click="removeRule(rule.name)" class="absolute top-4 right-4 text-red-400 hover:text-red-600 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/40 px-3 py-1 rounded-md text-xs font-medium transition-all opacity-0 group-hover:opacity-100">åˆ é™¤</button>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Tab 4: é»‘åå• -->
            <div x-show="currentTab === 'blacklist' && !loadingData">
                 <div class="card p-6">
                    <div class="flex justify-between items-center mb-6"><div><h3 class="text-lg font-bold">å¹¿å‘Šè¿‡æ»¤ (é»‘åå•)</h3><p class="text-sm text-gray-500 dark:text-gray-400 mt-1">å‘½ä¸­ä»»ä¸€æ¡ä»¶çš„**æ¶ˆæ¯**å°†è¢«ä¸¢å¼ƒã€‚</p></div><button @click="saveBlacklist" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm">ä¿å­˜æ›´æ”¹</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">åŒ…å«å…³é”®è¯ (ä¸­æ–‡/å­ä¸²)</label><textarea x-model="blacklist.substring" rows="6" class="form-textarea font-mono text-sm" placeholder="å¦‚: å‘è´¢, èµŒåœº (æ¯è¡Œä¸€ä¸ª)"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">åŒ…å«å…³é”®è¯ (è‹±æ–‡/å…¨è¯)</label><textarea x-model="blacklist.word" rows="6" class="form-textarea font-mono text-sm" placeholder="å¦‚: ad, promo (æ¯è¡Œä¸€ä¸ª)"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">æ–‡ä»¶ååŒ…å« (å­ä¸²)</label><textarea x-model="blacklist.files" rows="6" class="form-textarea font-mono text-sm" placeholder="å¦‚: èŠ’æœVPN (æ¯è¡Œä¸€ä¸ª)"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">æ­£åˆ™åŒ¹é… (Regex)</label><textarea x-model="blacklist.regex" rows="6" class="form-textarea font-mono text-sm" placeholder="Python æ­£åˆ™è¡¨è¾¾å¼ (æ¯è¡Œä¸€ä¸ª)"></textarea></div>
                    </div>
                 </div>
            </div>

            <!-- Tab 5: ç™½åå• -->
            <div x-show="currentTab === 'whitelist' && !loadingData">
                <div class="card p-6 border-yellow-200 dark:border-yellow-800/30">
                   <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold flex items-center gap-2">âœ¨ ç™½åå•æ¨¡å¼<span x-show="whitelist.enable" class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">å·²å¯ç”¨</span></h3><button @click="saveWhitelist" class="bg-yellow-600 hover:bg-yellow-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm">ä¿å­˜æ›´æ”¹</button></div>
                   <div class="mb-6 bg-yellow-50 dark:bg-yellow-900/10 p-4 rounded-xl border border-yellow-100 dark:border-yellow-800/30"><label class="flex items-center cursor-pointer"><input type="checkbox" x-model="whitelist.enable" class="w-5 h-5 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500"><span class="ml-3 font-bold text-gray-900 dark:text-gray-100">å¯ç”¨ç™½åå•</span></label><p class="mt-2 text-sm text-yellow-800 dark:text-yellow-400 ml-8 leading-relaxed">âš ï¸ <strong>è­¦å‘Šï¼š</strong> å¯ç”¨åï¼Œ<strong>åªæœ‰</strong>åŒ…å«ä¸‹æ–¹å…³é”®è¯çš„æ¶ˆæ¯æ‰ä¼šè¢«è½¬å‘ã€‚å…¶ä»–æ‰€æœ‰æ¶ˆæ¯ï¼ˆåŒ…æ‹¬æ— æ–‡æœ¬çš„å›¾ç‰‡/è§†é¢‘ï¼‰éƒ½å°†è¢«ç›´æ¥ä¸¢å¼ƒï¼ç™½åå•ä¼˜å…ˆçº§é«˜äºé»‘åå•ã€‚</p></div>
                   <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ç™½åå•å…³é”®è¯ (æ¯è¡Œä¸€ä¸ª)</label><textarea x-model="whitelist.keywords" rows="10" class="form-textarea font-mono text-sm border-yellow-200 dark:border-gray-700 focus:ring-yellow-500" placeholder="é‡è¦é€šçŸ¥&#10;#MyTag"></textarea></div>
                </div>
           </div>
        </main>
    </div>

    <!-- 5. æ ¸å¿ƒé€»è¾‘è„šæœ¬ (Alpine.js ä¹‹å‰) -->
    <script>
        function app() {
            return {
                authenticated: false,
                password: '',
                loading: false,
                loadingData: false,
                theme: localStorage.getItem('theme') || 'system',
                currentTab: 'status',
                needsReload: false,
                
                stats: {}, settings: { dedup_retention_days: 30 },
                rules: { sources: [], distribution_rules: [], ad_filter: {}, whitelist: {} },
                
                blacklist: { substring: '', word: '', files: '', regex: '' },
                whitelist: { enable: false, keywords: '' },
                newSource: '', newRule: { name: '', target: '', topic: '', keywords: '', any_keywords: '', files: '', types: '' },
                toasts: [],
                
                tabs: [{id: 'status', name: 'ğŸ“Š çŠ¶æ€æ¦‚è§ˆ'}, {id: 'sources', name: 'ğŸ“¡ ç›‘æ§æº'}, {id: 'rules', name: 'ğŸ”€ è½¬å‘è§„åˆ™'}, {id: 'blacklist', name: 'ğŸ›¡ï¸ é»‘åå•'}, {id: 'whitelist', name: 'âœ¨ ç™½åå•'}],

                async initApp() {
                    const savedPwd = localStorage.getItem('tgf_pwd');
                    if (savedPwd) { this.password = savedPwd; await this.login(); }
                },
                async login() {
                    if(!this.password) return this.showToast('æç¤º', 'è¯·è¾“å…¥å¯†ç ', 'error');
                    this.loading = true;
                    try {
                        const headers = { 'Authorization': 'Basic ' + btoa('admin:' + this.password) };
                        const res = await fetch('/api/rules', { headers });
                        if (!res.ok) throw new Error(res.status === 401 ? 'å¯†ç é”™è¯¯' : 'è¿æ¥å¤±è´¥');
                        this.authenticated = true; localStorage.setItem('tgf_pwd', this.password);
                        await this.fetchAllData(); this.showToast('æ¬¢è¿', 'ç™»å½•æˆåŠŸ', 'success');
                    } catch (e) { this.password = ''; localStorage.removeItem('tgf_pwd'); this.showToast('é”™è¯¯', e.message, 'error'); } finally { this.loading = false; }
                },
                async api(url, method = 'GET', body = null) {
                    const headers = { 'Authorization': 'Basic ' + btoa('admin:' + this.password), 'Content-Type': 'application/json' };
                    const opts = { method, headers }; if (body) opts.body = JSON.stringify(body);
                    const res = await fetch(url, opts);
                    if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.detail || `è¯·æ±‚å¤±è´¥ (${res.status})`); }
                    return res.json();
                },
                async fetchAllData() {
                    this.loadingData = true;
                    try {
                        const [rules, stats, settings] = await Promise.all([this.api('/api/rules'), this.api('/api/stats'), this.api('/api/settings/dedup')]);
                        this.rules = rules; this.stats = stats; this.settings = settings;
                        this.blacklist.substring = arrayToText(rules.ad_filter?.keywords_substring);
                        this.blacklist.word = arrayToText(rules.ad_filter?.keywords_word);
                        this.blacklist.files = arrayToText(rules.ad_filter?.file_name_keywords);
                        this.blacklist.regex = arrayToText(rules.ad_filter?.patterns);
                        this.whitelist.enable = !!rules.whitelist?.enable;
                        this.whitelist.keywords = arrayToText(rules.whitelist?.keywords);
                    } catch (e) { this.showToast('æ•°æ®åŠ è½½å¤±è´¥', e.message, 'error'); } finally { this.loadingData = false; }
                },
                // Actions
                async saveSettings() { try { await this.api('/api/settings/dedup', 'POST', { days: parseInt(this.settings.dedup_retention_days) }); this.showToast('ä¿å­˜æˆåŠŸ', 'æ•°æ®åº“è®¾ç½®å·²æ›´æ–°'); } catch(e) { this.showToast('ä¿å­˜å¤±è´¥', e.message, 'error'); } },
                async addSource() { if (!this.newSource) return; try { await this.api('/api/sources/add', 'POST', { identifier: this.newSource }); this.rules.sources.push({ identifier: this.newSource, resolved_id: null }); this.newSource = ''; this.needsReload = true; this.showToast('æ·»åŠ æˆåŠŸ', 'è¯·è®°å¾— Reload'); } catch(e) { this.showToast('æ·»åŠ å¤±è´¥', e.message, 'error'); } },
                async removeSource(id) { if (!confirm(`ç¡®å®šè¦åˆ é™¤æº "${id}" å—ï¼Ÿ`)) return; try { await this.api('/api/sources/remove', 'POST', { identifier: id }); this.rules.sources = this.rules.sources.filter(s => s.identifier !== id); this.needsReload = true; this.showToast('åˆ é™¤æˆåŠŸ', 'æºå·²ç§»é™¤'); } catch(e) { this.showToast('åˆ é™¤å¤±è´¥', e.message, 'error'); } },
                async addRule() {
                    if(!this.newRule.name || !this.newRule.target) return this.showToast('æç¤º', 'è§„åˆ™åç§°å’Œç›®æ ‡IDå¿…å¡«', 'error');
                    const payload = { name: this.newRule.name, target_identifier: this.newRule.target, topic_id: this.newRule.topic ? parseInt(this.newRule.topic) : null, all_keywords: textToArray(this.newRule.keywords), any_keywords: textToArray(this.newRule.any_keywords), file_name_patterns: textToArray(this.newRule.files), file_types: textToArray(this.newRule.types) };
                    try { await this.api('/api/rules/add', 'POST', payload); this.rules.distribution_rules.push(payload); this.newRule = { name: '', target: '', topic: '', keywords: '', any_keywords: '', files: '', types: '' }; this.needsReload = true; this.showToast('æ·»åŠ æˆåŠŸ', 'è½¬å‘è§„åˆ™å·²ä¿å­˜'); } catch(e) { this.showToast('æ·»åŠ å¤±è´¥', e.message, 'error'); }
                },
                async removeRule(name) { if(!confirm(`åˆ é™¤è§„åˆ™ "${name}"?`)) return; try { await this.api('/api/rules/remove', 'POST', { name }); this.rules.distribution_rules = this.rules.distribution_rules.filter(r => r.name !== name); this.needsReload = true; this.showToast('åˆ é™¤æˆåŠŸ', 'è§„åˆ™å·²ç§»é™¤'); } catch(e) { this.showToast('åˆ é™¤å¤±è´¥', e.message, 'error'); } },
                async saveBlacklist() { try { const payload = { enable: true, keywords_substring: textToArray(this.blacklist.substring), keywords_word: textToArray(this.blacklist.word), file_name_keywords: textToArray(this.blacklist.files), patterns: textToArray(this.blacklist.regex) }; await this.api('/api/blacklist/update', 'POST', payload); this.needsReload = true; this.showToast('ä¿å­˜æˆåŠŸ', 'é»‘åå•å·²æ›´æ–°'); } catch(e) { this.showToast('ä¿å­˜å¤±è´¥', e.message, 'error'); } },
                async saveWhitelist() { try { const payload = { enable: this.whitelist.enable, keywords: textToArray(this.whitelist.keywords) }; await this.api('/api/whitelist/update', 'POST', payload); this.needsReload = true; this.showToast('ä¿å­˜æˆåŠŸ', 'ç™½åå•å·²æ›´æ–°'); } catch(e) { this.showToast('ä¿å­˜å¤±è´¥', e.message, 'error'); } },
                toggleTheme() { const modes = ['light', 'dark', 'system']; this.theme = modes[(modes.indexOf(this.theme) + 1) % modes.length]; localStorage.setItem('theme', this.theme); },
                showToast(title, message, type = 'success') { const id = Date.now(); this.toasts.push({ id, title, message, type, visible: true }); setTimeout(() => { const t = this.toasts.find(t => t.id === id); if(t) t.visible = false; }, 3000); }
            }
        }
    </script>

    <!-- 6. Alpine.js (å¿…é¡»æ”¾åœ¨ body çš„æœ€å) -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js"></script>

</body>
</html>
