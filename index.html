<!DOCTYPE html>
<html lang="zh-CN" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG ç»ˆæè½¬å‘å™¨</title>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        *, ::before, ::after { box-sizing: border-box; }
        :root {
            --bg-body: #fafafa; --bg-card: #ffffff; --bg-input: #ffffff; --border-color: #e4e4e7;
            --text-primary: #18181b; --text-secondary: #71717a; --text-muted: #a1a1aa;
            --accent-color: #2563eb; --accent-hover: #1d4ed8;
            --success-bg: #dcfce7; --success-text: #15803d;
            --warning-bg: #fef3c7; --warning-text: #b45309;
            --error-bg: #fee2e2; --error-text: #b91c1c;
            
            /* é«˜å¯¹æ¯”åº¦ Badges (æ—¥é—´) */
            --badge-blue-bg: #eff6ff; --badge-blue-text: #1e40af;
            --badge-purple-bg: #f3e8ff; --badge-purple-text: #6b21a8;
            --badge-yellow-bg: #fefce8; --badge-yellow-text: #854d0e;
            --badge-pink-bg: #fce7f3; --badge-pink-text: #9d174d;
            --badge-gray-bg: #f3f4f6; --badge-gray-text: #374151;
        }
        .dark {
            --bg-body: #09090b; --bg-card: #18181b; --bg-input: #18181b; --border-color: #27272a;
            --text-primary: #f4f4f5; --text-secondary: #a1a1aa; --text-muted: #52525b;
            --accent-color: #3b82f6; --accent-hover: #60a5fa;
            --success-bg: #14532d; --success-text: #4ade80;
            --warning-bg: #451a03; --warning-text: #fbbf24;
            --error-bg: #7f1d1d; --error-text: #f87171;
            
            /* é«˜å¯¹æ¯”åº¦ Badges (å¤œé—´ - ç¡®ä¿æ–‡å­—æ¸…æ™°) */
            --badge-blue-bg: #172554; --badge-blue-text: #93c5fd;
            --badge-purple-bg: #3b0764; --badge-purple-text: #d8b4fe;
            --badge-yellow-bg: #422006; --badge-yellow-text: #fde047;
            --badge-pink-bg: #500724; --badge-pink-text: #f472b6;
            --badge-gray-bg: #27272a; --badge-gray-text: #e5e7eb; /* ç›®æ ‡IDç”¨è¿™ä¸ªï¼Œç¡®ä¿äº®ç™½æ–‡å­— */
        }
        [x-cloak] { display: none !important; }
        body { background-color: var(--bg-body); color: var(--text-primary); font-family: 'Inter', sans-serif; transition: 0.3s; }
        
        .app-card { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: border-color 0.2s; }
        .app-input, .form-textarea { width: 100%; padding: 0.6rem 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-primary); outline: none; transition: 0.2s; }
        .app-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        .app-btn { background-color: var(--accent-color); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .app-btn:hover { opacity: 0.9; }
        
        .badge { padding: 0.15rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; font-family: monospace; display: inline-block; margin-right: 0.25rem; margin-bottom: 0.25rem;}
        .badge-blue { background-color: var(--badge-blue-bg); color: var(--badge-blue-text); }
        .badge-purple { background-color: var(--badge-purple-bg); color: var(--badge-purple-text); }
        .badge-yellow { background-color: var(--badge-yellow-bg); color: var(--badge-yellow-text); }
        .badge-pink { background-color: var(--badge-pink-bg); color: var(--badge-pink-text); }
        .badge-gray { background-color: var(--badge-gray-bg); color: var(--badge-gray-text); }
        
        .label-text { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem; display: block; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        
        .dark .bg-white { background-color: var(--bg-card) !important; }
        .dark .text-gray-500 { color: var(--text-secondary) !important; }
        .dark .text-gray-900 { color: var(--text-primary) !important; }
        .gap-4 { gap: 1rem; } .gap-6 { gap: 1.5rem; }
        .bg-blue-600 { background-color: var(--accent-color) !important; }
        .text-blue-600 { color: var(--accent-color) !important; }
        .login-overlay, .modal-overlay { background-color: rgba(0,0,0,0.75); backdrop-filter: blur(4px); }

        /* æ‹–æ‹½æ ·å¼ */
        .draggable-source { cursor: move; }
        .dragging { opacity: 0.5; border: 2px dashed var(--accent-color); }
        .drag-over { border-top: 2px solid var(--accent-color); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.5/cdn.min.js" defer></script>
    <script>
        const SafeStorage = { getItem(k) { try { return localStorage.getItem(k); } catch(e) { return null; } }, setItem(k, v) { try { localStorage.setItem(k, v); } catch(e) {} }, removeItem(k) { try { localStorage.removeItem(k); } catch(e) {} } };
        function app() {
            return {
                authenticated: false, password: '', loading: false, loadingData: false,
                theme: SafeStorage.getItem('theme') || 'system', currentTab: 'status',
                stats: {}, rules: { sources: [], distribution_rules: [] },
                settings: { dedup_retention_days: 30, forwarding_mode: 'copy', forward_new_only: true, mark_as_read: false, mark_target_as_read: false, default_target: '', default_topic_id: null },
                blacklist: { substring: '', word: '', file: '', regex: '' }, whitelist: { keywords: '' },
                content_filter: { enable: true, meaningless_words: [], min_meaningful_length: 5 },
                replacements: {}, replacements_list: [],
                
                // æ‹–æ‹½æ’åºçŠ¶æ€
                draggingIndex: null, orderChanged: false,
                
                // ç¼–è¾‘æ¨¡æ€æ¡†
                showEditModal: false,
                editRuleData: { name: '', target: '', topic: '', all_kw: '', any_kw: '', files: '', original_name: '' },
                
                newSource: '', newRule: { name: '', target: '', topic: '', all_kw: '', any_kw: '', files: '' }, toasts: [],
                tabs: [
                    { id: 'status', name: 'ğŸ“Š çŠ¶æ€æ¦‚è§ˆ' }, { id: 'sources', name: 'ğŸ“¡ ç›‘æ§æº' }, 
                    { id: 'rules', name: 'ğŸ”€ è½¬å‘è§„åˆ™' }, { id: 'filter_replace', name: 'ğŸ§¹ è¿‡æ»¤ä¸æ›¿æ¢' },
                    { id: 'blacklist', name: 'â›” é»‘åå•' }, { id: 'whitelist', name: 'âœ… ç™½åå•' },
                    { id: 'settings', name: 'âš™ï¸ è®¾ç½®' }
                ],
                arrayToText(arr) { return (arr || []).join('\n'); },
                textToArray(text) { if (!text) return []; return text.split('\n').map(s => s.trim()).filter(Boolean); },

                async initApp() { const saved = SafeStorage.getItem('tgf_pwd'); if (saved) { this.password = saved; await this.login(); } },
                async login() { this.loading = true; try { const headers = { 'Authorization': 'Basic ' + btoa('admin:' + this.password) }; const res = await fetch('/api/rules', { headers }); if (res.status === 401) throw new Error('å¯†ç é”™è¯¯'); if (!res.ok) throw new Error(`è¿æ¥å¤±è´¥ (${res.status})`); this.authenticated = true; SafeStorage.setItem('tgf_pwd', this.password); await this.fetchAllData(); this.showToast('ç™»å½•æˆåŠŸ'); } catch (e) { if (e.message === 'å¯†ç é”™è¯¯') { this.password = ''; SafeStorage.removeItem('tgf_pwd'); } this.showToast('ç™»å½•å¤±è´¥', e.message, 'error'); } finally { this.loading = false; } },
                async api(url, method = 'GET', body = null) { const headers = { 'Authorization': 'Basic ' + btoa('admin:' + this.password), 'Content-Type': 'application/json' }; const opts = { method, headers }; if (body) opts.body = JSON.stringify(body); const res = await fetch(url, opts); if (!res.ok) throw new Error(`API Error: ${res.status}`); return await res.json(); },
                
                async fetchAllData() {
                    this.loadingData = true;
                    try {
                        const [rules, stats, sysSettings, bl, wl, cf, rep] = await Promise.all([
                            this.api('/api/rules'), this.api('/api/stats'), this.api('/api/settings'),
                            this.api('/api/blacklist'), this.api('/api/whitelist'),
                            this.api('/api/content_filter'), this.api('/api/replacements')
                        ]);
                        this.rules = rules; this.stats = stats; this.settings = sysSettings;
                        this.blacklist.substring = this.arrayToText(bl.keywords_substring);
                        this.blacklist.word = this.arrayToText(bl.keywords_word);
                        this.blacklist.file = this.arrayToText(bl.file_name_keywords);
                        this.blacklist.regex = this.arrayToText(bl.patterns);
                        this.whitelist.keywords = this.arrayToText(wl.keywords);
                        this.content_filter = cf; this.content_filter.meaningless_text = this.arrayToText(cf.meaningless_words);
                        this.replacements = rep; this.replacements_list = Object.entries(rep).map(([k,v]) => ({key:k, val:v}));
                        this.orderChanged = false; // é‡ç½®æ’åºçŠ¶æ€
                    } catch (e) { this.showToast('æ•°æ®åŠ è½½å¤±è´¥', e.message, 'error'); } 
                    finally { this.loadingData = false; }
                },
                
                // æç¤ºé‡è½½
                promptReload(msg) { this.showToast(msg, 'è¯·å‘é€ /reload ä»¥ç”Ÿæ•ˆ', 'success'); },

                async saveSettings() { try { await this.api('/api/settings/update', 'POST', this.settings); this.promptReload('ç³»ç»Ÿè®¾ç½®å·²ä¿å­˜'); } catch(e) { this.showToast('ä¿å­˜å¤±è´¥', e.message, 'error'); } },
                async saveDefaultTarget() { try { await this.api('/api/settings/update', 'POST', this.settings); this.promptReload('é»˜è®¤ç›®æ ‡å·²æ›´æ–°'); } catch(e) { this.showToast('ä¿å­˜å¤±è´¥', e.message, 'error'); } },
                
                async addSource() { try { await this.api('/api/sources/add', 'POST', { identifier: this.newSource }); this.newSource = ''; this.promptReload('ç›‘æ§æºå·²æ·»åŠ '); await this.fetchAllData(); } catch(e) { this.showToast('æ·»åŠ å¤±è´¥', e.message, 'error'); } },
                async removeSource(id) { if (!confirm('åˆ é™¤?')) return; try { await this.api('/api/sources/remove', 'POST', { identifier: id }); this.promptReload('å·²åˆ é™¤'); await this.fetchAllData(); } catch(e) {} },
                
                async addRule() {
                    if(!this.newRule.name || !this.newRule.target) return this.showToast('è§„åˆ™åå’Œç›®æ ‡IDå¿…å¡«', '', 'error');
                    const payload = this.buildRulePayload(this.newRule);
                    try { await this.api('/api/rules/add', 'POST', payload); this.newRule = {name:'', target:'', topic:'', all_kw:'', any_kw:'', files:''}; this.promptReload('è§„åˆ™å·²æ·»åŠ '); await this.fetchAllData(); } catch(e) { this.showToast('æ·»åŠ å¤±è´¥', e.message, 'error'); }
                },
                
                async saveEditedRule() {
                    if(!this.editRuleData.name || !this.editRuleData.target) return this.showToast('è§„åˆ™åå’Œç›®æ ‡IDå¿…å¡«', '', 'error');
                    const payload = this.buildRulePayload(this.editRuleData);
                    try { 
                        // ä¼ é€’ name_to_replace ä»¥æ”¯æŒæ”¹å (æˆ–è€…è¦†ç›–åŸå)
                        const url = `/api/rules/update_single?name_to_replace=${encodeURIComponent(this.editRuleData.original_name)}`;
                        await this.api(url, 'POST', payload); 
                        this.showEditModal = false; 
                        this.promptReload('è§„åˆ™å·²æ›´æ–°'); 
                        await this.fetchAllData(); 
                    } catch(e) { this.showToast('æ›´æ–°å¤±è´¥', e.message, 'error'); }
                },
                
                buildRulePayload(data) {
                    return {
                        name: data.name, target_identifier: data.target, topic_id: data.topic ? parseInt(data.topic) : null,
                        all_keywords: this.textToArray(data.all_kw), any_keywords: this.textToArray(data.any_kw), file_name_patterns: this.textToArray(data.files)
                    };
                },
                
                openEditModal(rule) {
                    this.editRuleData = {
                        name: rule.name, original_name: rule.name,
                        target: rule.target_identifier, topic: rule.topic_id,
                        all_kw: this.arrayToText(rule.all_keywords), any_kw: this.arrayToText(rule.any_keywords), files: this.arrayToText(rule.file_name_patterns)
                    };
                    this.showEditModal = true;
                },

                async removeRule(name) { if(!confirm('åˆ é™¤?')) return; try { await this.api('/api/rules/remove', 'POST', { name }); this.promptReload('å·²åˆ é™¤'); await this.fetchAllData(); } catch(e) {} },
                
                // æ‹–æ‹½æ’åºé€»è¾‘
                dragStart(e, idx) { this.draggingIndex = idx; e.dataTransfer.effectAllowed = 'move'; },
                dragOver(e) { e.preventDefault(); },
                drop(e, dropIdx) {
                    const dragIdx = this.draggingIndex;
                    if (dragIdx === null || dragIdx === dropIdx) return;
                    // ç§»åŠ¨æ•°ç»„å…ƒç´ 
                    const item = this.rules.distribution_rules.splice(dragIdx, 1)[0];
                    this.rules.distribution_rules.splice(dropIdx, 0, item);
                    this.draggingIndex = null;
                    this.orderChanged = true;
                },
                async saveOrder() {
                    try {
                        const names = this.rules.distribution_rules.map(r => r.name);
                        await this.api('/api/rules/reorder', 'POST', {names});
                        this.promptReload('é¡ºåºå·²ä¿å­˜');
                        this.orderChanged = false;
                    } catch(e) { this.showToast('æ’åºä¿å­˜å¤±è´¥', e.message, 'error'); }
                },

                async saveBlacklist() { try { const payload = { enable: true, keywords_substring: this.textToArray(this.blacklist.substring), keywords_word: this.textToArray(this.blacklist.word), file_name_keywords: this.textToArray(this.blacklist.file), patterns: this.textToArray(this.blacklist.regex) }; await this.api('/api/blacklist/update', 'POST', payload); this.promptReload('é»‘åå•å·²æ›´æ–°'); } catch(e) { this.showToast('ä¿å­˜å¤±è´¥', '', 'error'); } },
                async saveWhitelist() { try { await this.api('/api/whitelist/update', 'POST', { enable: true, keywords: this.textToArray(this.whitelist.keywords) }); this.promptReload('ç™½åå•å·²æ›´æ–°'); } catch(e) {} },
                async saveContentFilter() { try { const payload = { enable: this.content_filter.enable, min_meaningful_length: parseInt(this.content_filter.min_meaningful_length), meaningless_words: this.textToArray(this.content_filter.meaningless_text) }; await this.api('/api/content_filter/update', 'POST', payload); this.promptReload('å†…å®¹è¿‡æ»¤å·²æ›´æ–°'); } catch(e) { this.showToast('ä¿å­˜å¤±è´¥', '', 'error'); } },
                async saveReplacements() { try { const repMap = {}; this.replacements_list.forEach(i => { if(i.key) repMap[i.key] = i.val; }); await this.api('/api/replacements/update', 'POST', repMap); this.promptReload('æ›¿æ¢è§„åˆ™å·²æ›´æ–°'); await this.fetchAllData(); } catch(e) { this.showToast('ä¿å­˜å¤±è´¥', '', 'error'); } },
                addRepRow() { this.replacements_list.push({key:'', val:''}); },
                removeRepRow(idx) { this.replacements_list.splice(idx, 1); },

                toggleTheme() { const n = ['light','dark','system']; this.theme = n[(n.indexOf(this.theme)+1)%3]; SafeStorage.setItem('theme', this.theme); },
                showToast(t, m='', type='success') { const id = Date.now(); this.toasts.push({id, title:t, message:m, type, visible:true}); setTimeout(()=>this.toasts.find(x=>x.id===id).visible=false, 3000); },
                getAvatar(name) { return (name || '?').substring(0, 2).toUpperCase(); }
            }
        }
    </script>
</head>
<body x-data="app()" x-init="initApp()" :class="{ 'dark': theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) }">

    <div class="fixed top-4 right-4 z-50 pointer-events-none space-y-2">
        <template x-for="t in toasts" :key="t.id"><div x-show="t.visible" x-transition class="pointer-events-auto app-card p-4 flex items-center gap-3 border-l-4" :class="t.type==='success'?'border-green-500':'border-red-500'"><div :class="t.type==='success'?'text-green-500':'text-red-500'">â—</div><div><div class="font-bold text-sm" x-text="t.title"></div><div class="text-xs text-secondary" x-text="t.message"></div></div></div></template>
    </div>

    <div x-show="!authenticated" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center login-overlay">
        <div class="app-card p-8 w-full max-w-sm text-center mx-4">
            <div class="w-12 h-12 bg-blue-100 dark:bg-zinc-800 text-blue-600 rounded-xl flex items-center justify-center mx-auto mb-4">ğŸ”’</div>
            <h2 class="text-xl font-bold mb-6">å®‰å…¨éªŒè¯</h2>
            <form @submit.prevent="login">
                <input type="password" x-model="password" class="app-input mb-4" placeholder="è®¿é—®å¯†ç " required>
                <button type="submit" :disabled="loading" class="app-btn w-full h-10"><span x-show="!loading">è§£é”</span><span x-show="loading">...</span></button>
            </form>
        </div>
    </div>

    <div x-show="authenticated" x-cloak class="flex-grow flex flex-col">
        <nav class="sticky top-0 z-40 backdrop-blur-md border-b" style="background-color: rgba(var(--bg-body), 0.8); border-color: var(--border-color);">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3"><div class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center font-bold">TG</div><span class="font-bold text-lg hidden md:block">Forwarder</span></div>
                <div class="hidden md:flex gap-1 p-1 rounded-xl" style="background-color: var(--border-color);"><template x-for="tab in tabs" :key="tab.id"><button @click="currentTab=tab.id" :class="currentTab===tab.id?'app-card shadow-sm bg-white dark:bg-zinc-800':'text-secondary hover:text-primary'" class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all" x-text="tab.name"></button></template></div>
                <div class="flex items-center gap-3"><button @click="toggleTheme" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-zinc-800 text-secondary"><span x-show="theme==='light'">â˜€ï¸</span><span x-show="theme==='dark'">ğŸŒ™</span><span x-show="theme==='system'">ğŸ’»</span></button></div>
            </div>
        </nav>
        <div class="md:hidden border-b overflow-x-auto flex px-4 gap-4" style="border-color: var(--border-color);"><template x-for="tab in tabs" :key="tab.id"><button @click="currentTab=tab.id" :class="currentTab===tab.id?'border-b-2 border-blue-500 text-blue-500':'text-secondary'" class="whitespace-nowrap text-sm py-3 font-medium" x-text="tab.name"></button></template></div>

        <main class="flex-grow max-w-7xl mx-auto w-full px-4 py-8 space-y-6">
            <!-- çŠ¶æ€ (ä¿®å¤6é¡¹) -->
            <div x-show="currentTab==='status'&&!loadingData" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="app-card p-6"><dt class="text-xs font-bold text-secondary uppercase">æ•°æ®åº“å»é‡</dt><dd class="mt-2 text-3xl font-bold" x-text="stats.dedup_hashes||0"></dd></div>
                <div class="app-card p-6"><dt class="text-xs font-bold text-secondary uppercase">æ´»è·ƒç›‘æ§æº</dt><dd class="mt-2 text-3xl font-bold text-blue-600" x-text="stats.sources||0"></dd></div>
                <div class="app-card p-6"><dt class="text-xs font-bold text-secondary uppercase">åˆ†å‘è§„åˆ™</dt><dd class="mt-2 text-3xl font-bold text-purple-600" x-text="stats.distribution_rules||0"></dd></div>
                <div class="app-card p-6"><dt class="text-xs font-bold text-secondary uppercase">æ´»è·ƒæ›¿æ¢è§„åˆ™</dt><dd class="mt-2 text-3xl font-bold text-pink-500" x-text="stats.replacements_count||0"></dd></div>
                <div class="app-card p-6"><dt class="text-xs font-bold text-secondary uppercase">é»‘/ç™½åå•è¯æ¡</dt><dd class="mt-2 text-3xl font-bold text-secondary" x-text="(stats.blacklist_substring||0)+(stats.whitelist_keywords||0)"></dd></div>
                <div class="app-card p-6"><dt class="text-xs font-bold text-secondary uppercase">å¤±æ•ˆé“¾æ¥</dt><dd class="mt-2 text-3xl font-bold text-yellow-600" x-text="stats.invalid_links||0"></dd></div>
            </div>

            <!-- è®¾ç½® -->
            <div x-show="currentTab==='settings'&&!loadingData" class="app-card p-6 max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-6 pb-4 border-b" style="border-color: var(--border-color);">
                    <h3 class="text-lg font-bold">ç³»ç»Ÿæ ¸å¿ƒè®¾ç½®</h3>
                    <button @click="saveSettings" class="app-btn">ä¿å­˜è®¾ç½®</button>
                </div>
                <div class="space-y-6">
                    <div><label class="block text-sm font-bold text-secondary mb-2">è½¬å‘æ¨¡å¼</label><div class="flex gap-4"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" value="copy" x-model="settings.forwarding_mode" class="w-4 h-4"><span>å¤åˆ¶ (Copy)</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" value="forward" x-model="settings.forwarding_mode" class="w-4 h-4"><span>è½¬å‘ (Forward)</span></label></div></div>
                    <div><label class="block text-sm font-bold text-secondary mb-2">è®°å½•ä¿ç•™å¤©æ•°</label><div class="flex items-center gap-4"><input type="range" min="1" max="60" x-model="settings.dedup_retention_days" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"><span class="font-mono font-bold text-blue-600 w-12 text-right" x-text="settings.dedup_retention_days+'å¤©'"></span></div></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-zinc-800 transition" style="border-color: var(--border-color);"><span class="text-sm font-medium">åªå¤„ç†æ–°æ¶ˆæ¯</span><input type="checkbox" x-model="settings.forward_new_only" class="w-5 h-5"></label>
                        <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-zinc-800 transition" style="border-color: var(--border-color);"><span class="text-sm font-medium">æºé¢‘é“å·²è¯»</span><input type="checkbox" x-model="settings.mark_as_read" class="w-5 h-5"></label>
                        <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-zinc-800 transition" style="border-color: var(--border-color);"><span class="text-sm font-medium">ç›®æ ‡é¢‘é“å·²è¯»</span><input type="checkbox" x-model="settings.mark_target_as_read" class="w-5 h-5"></label>
                    </div>
                </div>
            </div>

            <!-- ç›‘æ§æº (ç¾åŒ–ç‰ˆ) -->
            <div x-show="currentTab==='sources'&&!loadingData">
                <div class="app-card p-6 mb-6 flex gap-2"><input x-model="newSource" @keyup.enter="addSource" placeholder="@Channel æˆ– Link" class="app-input md:w-64"><button @click="addSource" class="app-btn">æ·»åŠ æº</button></div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="s in rules.sources" :key="s.identifier">
                        <div class="app-card p-4 flex items-center gap-4 group relative hover:border-blue-500 transition-colors">
                            <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400 flex items-center justify-center font-bold text-lg shrink-0 select-none" x-text="getAvatar(s.identifier)"></div>
                            <div class="overflow-hidden flex-1">
                                <div class="font-bold text-sm truncate" x-text="s.identifier"></div>
                                <div class="flex items-center gap-2 mt-1">
                                    <div class="text-xs font-mono text-secondary truncate" x-text="'ID: ' + (s.resolved_id || 'Pending...')"></div>
                                    <span x-show="!s.resolved_id" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span>
                                </div>
                            </div>
                            <button @click="removeSource(s.identifier)" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-1 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- è¿‡æ»¤ä¸æ›¿æ¢ -->
            <div x-show="currentTab==='filter_replace'&&!loadingData" class="space-y-6">
                <div class="app-card p-6">
                    <div class="flex justify-between items-center mb-4 border-b pb-4" style="border-color: var(--border-color);">
                        <div class="flex items-center gap-3"><h3 class="font-bold">å†…å®¹è´¨é‡è¿‡æ»¤</h3><label class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" class="sr-only" x-model="content_filter.enable"><div class="w-10 h-6 bg-gray-200 rounded-full shadow-inner transition" :class="content_filter.enable?'bg-blue-500':'bg-gray-200'"></div><div class="dot absolute w-4 h-4 bg-white rounded-full shadow left-1 top-1 transition" :class="content_filter.enable?'transform translate-x-4':''"></div></div></label></div>
                        <button @click="saveContentFilter" class="app-btn">ä¿å­˜é…ç½®</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><label class="block text-sm font-bold text-secondary mb-2">æœ€å°æœ‰æ•ˆé•¿åº¦</label><input type="number" x-model="content_filter.min_meaningful_length" class="app-input"><p class="text-xs text-muted mt-1">å°‘äºæ­¤å­—æ•°å°†ä¸¢å¼ƒ</p></div>
                        <div class="col-span-2"><label class="block text-sm font-bold text-secondary mb-2">æ— æ„ä¹‰è¯æ±‡</label><textarea x-model="content_filter.meaningless_text" rows="3" class="app-input font-mono text-sm"></textarea></div>
                    </div>
                </div>
                <div class="app-card p-6">
                    <div class="flex justify-between items-center mb-4 border-b pb-4" style="border-color: var(--border-color);"><h3 class="font-bold">æ–‡æœ¬æ›¿æ¢</h3><button @click="saveReplacements" class="app-btn">ä¿å­˜è§„åˆ™</button></div>
                    <div class="space-y-2"><template x-for="(item, idx) in replacements_list" :key="idx"><div class="grid grid-cols-12 gap-2 items-center"><div class="col-span-5"><input x-model="item.key" class="app-input py-1" placeholder="åŸæ–‡æœ¬"></div><div class="col-span-6"><input x-model="item.val" class="app-input py-1" placeholder="æ–°æ–‡æœ¬"></div><div class="col-span-1 text-center"><button @click="removeRepRow(idx)" class="text-red-500 hover:bg-red-50 p-1 rounded">Ã—</button></div></div></template><button @click="addRepRow" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-secondary hover:border-blue-500 hover:text-blue-500 transition mt-2 text-sm font-bold">+ æ·»åŠ </button></div>
                </div>
            </div>

            <!-- è§„åˆ™ (é»˜è®¤ç›®æ ‡ã€æ‹–æ‹½ã€æ’åºã€ç¼–è¾‘) -->
            <div x-show="currentTab==='rules'&&!loadingData" class="space-y-6">
                <!-- é»˜è®¤ç›®æ ‡ -->
                <div class="app-card p-4 border-l-4 border-yellow-500 bg-yellow-50 dark:bg-yellow-900/10 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <span class="text-xs font-bold uppercase text-yellow-600 dark:text-yellow-400 tracking-wider">Fallback</span>
                        <div class="font-bold text-yellow-800 dark:text-yellow-200">é»˜è®¤è½¬å‘ç›®æ ‡ (æœªå‘½ä¸­è§„åˆ™æ—¶)</div>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <input x-model="settings.default_target" placeholder="é»˜è®¤ç›®æ ‡ ID (-100...)" class="app-input border-yellow-200 dark:border-yellow-700 bg-white dark:bg-zinc-900">
                        <input x-model="settings.default_topic_id" type="number" placeholder="Topic" class="app-input w-24 border-yellow-200 dark:border-yellow-700 bg-white dark:bg-zinc-900">
                        <button @click="saveDefaultTarget" class="app-btn bg-yellow-600 hover:bg-yellow-700 text-white">ä¿å­˜</button>
                    </div>
                </div>

                <!-- æ·»åŠ è§„åˆ™ -->
                <div class="app-card p-6">
                    <h3 class="text-lg font-bold mb-4">æ·»åŠ åˆ†å‘è§„åˆ™</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"><input x-model="newRule.name" placeholder="è§„åˆ™åç§°" class="app-input"><input x-model="newRule.target" placeholder="ç›®æ ‡ ID (-100...)" class="app-input"><input x-model="newRule.topic" type="number" placeholder="Topic (å¯é€‰)" class="app-input"></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"><textarea x-model="newRule.all_kw" rows="3" placeholder="[AND] å¿…é¡»åŒ…å«æ‰€æœ‰" class="app-input"></textarea><textarea x-model="newRule.any_kw" rows="3" placeholder="[OR] åŒ…å«ä»»ä¸€" class="app-input"></textarea><textarea x-model="newRule.files" rows="3" placeholder="æ–‡ä»¶å (*.apk)" class="app-input"></textarea></div>
                    <div class="flex justify-end"><button @click="addRule" class="app-btn">ä¿å­˜è§„åˆ™</button></div>
                </div>

                <!-- è§„åˆ™åˆ—è¡¨ (æ‹–æ‹½æ’åº) -->
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-secondary">è§„åˆ™åˆ—è¡¨ (æ‹–æ‹½æ’åº)</h3>
                    <button x-show="orderChanged" @click="saveOrder" class="app-btn bg-green-600 animate-bounce">ä¿å­˜é¡ºåº</button>
                </div>
                <div class="space-y-3">
                    <template x-for="(rule, index) in rules.distribution_rules" :key="rule.name">
                        <div class="app-card p-4 draggable-source flex flex-col md:flex-row gap-4 md:items-center relative group"
                             draggable="true"
                             @dragstart="dragStart($event, index)"
                             @dragover="dragOver($event)"
                             @drop="drop($event, index)"
                             :class="{'dragging': draggingIndex === index}">
                            
                            <!-- åºå·ä¸æ‹–æ‹½æŠŠæ‰‹ -->
                            <div class="flex items-center gap-3 md:w-16 shrink-0 cursor-grab text-secondary">
                                <span class="text-xl">â‰¡</span>
                                <span class="font-mono font-bold text-lg opacity-50" x-text="'#'+(index+1)"></span>
                            </div>

                            <div class="flex-grow">
                                <div class="flex flex-wrap justify-between items-start mb-2">
                                    <h4 class="font-bold text-lg" x-text="rule.name"></h4>
                                    <div class="flex gap-2">
                                        <button @click="openEditModal(rule)" class="text-xs bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400 px-3 py-1 rounded hover:opacity-80">ç¼–è¾‘</button>
                                        <button @click="removeRule(rule.name)" class="text-xs bg-red-50 text-red-500 dark:bg-red-900/30 dark:text-red-400 px-3 py-1 rounded hover:opacity-80">åˆ é™¤</button>
                                    </div>
                                </div>
                                
                                <div class="flex flex-wrap gap-2 mb-3">
                                    <span class="badge badge-gray" x-text="'To: '+rule.target_identifier"></span>
                                    <span x-show="rule.topic_id" class="badge badge-purple" x-text="'Topic: '+rule.topic_id"></span>
                                </div>

                                <div class="space-y-1 text-xs">
                                    <div x-show="rule.all_keywords?.length" class="flex gap-1 flex-wrap"><span class="text-muted font-bold">AND:</span><template x-for="k in rule.all_keywords"><span class="badge badge-blue py-0" x-text="k"></span></template></div>
                                    <div x-show="rule.any_keywords?.length" class="flex gap-1 flex-wrap"><span class="text-muted font-bold">OR:</span><template x-for="k in rule.any_keywords"><span class="badge badge-purple py-0" x-text="k"></span></template></div>
                                    <div x-show="rule.file_name_patterns?.length" class="flex gap-1 flex-wrap"><span class="text-muted font-bold">FILE:</span><template x-for="k in rule.file_name_patterns"><span class="badge badge-yellow py-0" x-text="k"></span></template></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- é»‘åå• -->
            <div x-show="currentTab==='blacklist'&&!loadingData" class="app-card p-6">
                <div class="flex justify-between mb-4 border-b pb-4" style="border-color: var(--border-color);"><h3 class="font-bold">å¹¿å‘Šè¿‡æ»¤</h3><button @click="saveBlacklist" class="app-btn">ä¿å­˜</button></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-2"><label class="text-sm font-bold text-secondary">ä¸­æ–‡/éƒ¨åˆ†åŒ¹é…</label><textarea x-model="blacklist.substring" rows="5" class="app-input form-textarea font-mono text-xs"></textarea></div><div class="space-y-2"><label class="text-sm font-bold text-secondary">è‹±æ–‡/å…¨è¯åŒ¹é…</label><textarea x-model="blacklist.word" rows="5" class="app-input form-textarea font-mono text-xs"></textarea></div><div class="space-y-2"><label class="text-sm font-bold text-secondary">æ–‡ä»¶åè¿‡æ»¤</label><textarea x-model="blacklist.file" rows="5" class="app-input form-textarea font-mono text-xs"></textarea></div><div class="space-y-2"><label class="text-sm font-bold text-secondary">æ­£åˆ™è¡¨è¾¾å¼</label><textarea x-model="blacklist.regex" rows="5" class="app-input form-textarea font-mono text-xs"></textarea></div></div>
            </div>
            
            <!-- ç™½åå• -->
            <div x-show="currentTab==='whitelist'&&!loadingData" class="app-card p-6 border-l-4 border-green-500"><div class="flex justify-between mb-4 border-b pb-4" style="border-color: var(--border-color);"><h3 class="font-bold">å¿…å‘ç™½åå•</h3><button @click="saveWhitelist" class="app-btn bg-green-600">ä¿å­˜</button></div><textarea x-model="whitelist.keywords" rows="8" class="app-input font-mono text-sm"></textarea></div>
        </main>
    </div>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div x-show="showEditModal" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="app-card p-6 w-full max-w-2xl m-4 relative" @click.outside="showEditModal = false">
            <button @click="showEditModal = false" class="absolute top-4 right-4 text-secondary hover:text-primary">âœ•</button>
            <h3 class="text-lg font-bold mb-4">ç¼–è¾‘è§„åˆ™</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <input x-model="editRuleData.name" placeholder="è§„åˆ™åç§°" class="app-input">
                <input x-model="editRuleData.target" placeholder="ç›®æ ‡ ID" class="app-input">
                <input x-model="editRuleData.topic" type="number" placeholder="Topic" class="app-input">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <textarea x-model="editRuleData.all_kw" rows="4" class="app-input" placeholder="[AND] å…³é”®è¯"></textarea>
                <textarea x-model="editRuleData.any_kw" rows="4" class="app-input" placeholder="[OR] å…³é”®è¯"></textarea>
                <textarea x-model="editRuleData.files" rows="4" class="app-input" placeholder="æ–‡ä»¶å"></textarea>
            </div>
            <div class="flex justify-end gap-2">
                <button @click="showEditModal = false" class="px-4 py-2 rounded border hover:bg-gray-100 dark:hover:bg-zinc-800" style="border-color: var(--border-color)">å–æ¶ˆ</button>
                <button @click="saveEditedRule" class="app-btn">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

</body>
</html>