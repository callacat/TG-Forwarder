<!DOCTYPE html>
<html lang="zh-CN" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG ç»ˆæè½¬å‘å™¨</title>
    
    <!-- 1. å­—ä½“: Inter -->
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    
    <!-- 2. æ ¸å¿ƒæ ·å¼: é™æ€ Tailwind CSS (å…œåº•ç”¨) -->
    <link rel="stylesheet" href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css">

    <!-- 3. è¿è¡Œæ—¶ Tailwind (é«˜çº§ç‰¹æ€§) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        try {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    darkMode: 'class',
                    theme: {
                        extend: {
                            fontFamily: { sans: ['Inter', 'sans-serif'] },
                            colors: {
                                // Zinc è‰²ç³»ï¼Œç”¨äºå¤œé—´æ¨¡å¼çš„é«˜çº§è´¨æ„Ÿ
                                zinc: {
                                    50: '#fafafa', 100: '#f4f4f5', 200: '#e4e4e7', 300: '#d4d4d8',
                                    400: '#a1a1aa', 500: '#71717a', 600: '#52525b', 700: '#3f3f46',
                                    800: '#27272a', 900: '#18181b', 950: '#09090b',
                                }
                            }
                        }
                    }
                }
            }
        } catch (e) { console.warn('Tailwind Runtime Config Failed:', e); }
    </script>

    <!-- 4. è‡ªå®šä¹‰æ ·å¼ (Zinc è‰²ç³»è¡¥å…¨ & ç»„ä»¶æ ·å¼) -->
    <style>
        [x-cloak] { display: none !important; }
        
        /* è¡¥å…¨ Zinc è‰²ç³» (é˜²æ­¢ JS åŠ è½½å¤±è´¥æ—¶ç¼ºå¤±é¢œè‰²) */
        .bg-zinc-50 { background-color: #fafafa; }
        .bg-zinc-100 { background-color: #f4f4f5; }
        .bg-zinc-800 { background-color: #27272a; }
        .bg-zinc-900 { background-color: #18181b; }
        .bg-zinc-950 { background-color: #09090b; }
        
        .text-zinc-400 { color: #a1a1aa; }
        .text-zinc-500 { color: #71717a; }
        
        .border-zinc-200 { border-color: #e4e4e7; }
        .border-zinc-700 { border-color: #3f3f46; }
        .border-zinc-800 { border-color: #27272a; }

        /* å¤œé—´æ¨¡å¼è¦†ç›– */
        .dark .dark\:bg-zinc-900 { background-color: #18181b; }
        .dark .dark\:bg-zinc-950 { background-color: #09090b; }
        .dark .dark\:border-zinc-800 { border-color: #27272a; }
        .dark .dark\:text-zinc-100 { color: #f4f4f5; }
        .dark .dark\:text-zinc-400 { color: #a1a1aa; }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #52525b; }
        
        /* è¾“å…¥æ¡†ç»„ä»¶ */
        .form-input, .form-textarea {
            width: 100%; padding: 0.6rem 1rem; border-radius: 0.5rem;
            border: 1px solid #e4e4e7; background-color: white;
            font-size: 0.875rem; line-height: 1.25rem; outline: none; 
            transition: all 0.15s; color: #18181b;
        }
        .form-input:focus, .form-textarea:focus {
            border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        /* è¾“å…¥æ¡†å¤œé—´æ¨¡å¼ä¿®å¤ï¼šç¡®ä¿èƒŒæ™¯é»‘ã€æ–‡å­—ç™½ã€è¾¹æ¡†ç° */
        .dark .form-input, .dark .form-textarea {
            border-color: #3f3f46; background-color: #18181b; color: #f4f4f5;
        }
        .dark .form-input::placeholder, .dark .form-textarea::placeholder {
            color: #71717a;
        }

        /* å¡ç‰‡æ‚¬åœæ•ˆæœ */
        .hover-card { transition: transform 0.2s, box-shadow 0.2s; }
        .hover-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>

    <!-- 5. åº”ç”¨é€»è¾‘ -->
    <script>
        function app() {
            return {
                authenticated: false,
                password: '',
                loading: false,
                loadingData: false,
                theme: localStorage.getItem('theme') || 'system',
                currentTab: 'status',
                needsReload: false,
                
                // æ•°æ®æ¨¡å‹
                stats: {},
                settings: { dedup_retention_days: 30 },
                rules: { sources: [], distribution_rules: [] },
                
                // ç¼–è¾‘å™¨æ•°æ®
                blacklist: { substring: '', word: '', file: '', regex: '' },
                whitelist: { keywords: '' },
                
                newSource: '',
                newRule: { name: '', target: '', topic: '', keywords: '', files: '' },
                toasts: [],
                
                tabs: [
                    { id: 'status', name: 'ğŸ“Š çŠ¶æ€æ¦‚è§ˆ' },
                    { id: 'sources', name: 'ğŸ“¡ ç›‘æ§æº' },
                    { id: 'rules', name: 'ğŸ”€ è½¬å‘è§„åˆ™' },
                    { id: 'blacklist', name: 'â›” é»‘åå•' },
                    { id: 'whitelist', name: 'âœ… ç™½åå•' }
                ],

                // å·¥å…·å‡½æ•°
                arrayToText(arr) { return (arr || []).join('\n'); },
                textToArray(text) {
                    if (!text) return [];
                    return text.split('\n').map(s => s.trim()).filter(Boolean);
                },

                async initApp() {
                    const savedPwd = localStorage.getItem('tgf_pwd');
                    if (savedPwd) {
                        this.password = savedPwd;
                        await this.login();
                    }
                },

                async login() {
                    this.loading = true;
                    try {
                        const headers = { 'Authorization': 'Basic ' + btoa('admin:' + this.password) };
                        const res = await fetch('/api/rules', { headers });
                        
                        if (res.status === 401) throw new Error('å¯†ç é”™è¯¯');
                        if (!res.ok) throw new Error(`è¿æ¥å¤±è´¥ (${res.status})`);
                        
                        this.authenticated = true;
                        localStorage.setItem('tgf_pwd', this.password);
                        await this.fetchAllData();
                        this.showToast('æ¬¢è¿å›æ¥', 'ç™»å½•æˆåŠŸ', 'success');
                    } catch (e) {
                        if (e.message === 'å¯†ç é”™è¯¯') {
                            this.password = '';
                            localStorage.removeItem('tgf_pwd');
                        }
                        this.showToast('ç™»å½•å¤±è´¥', e.message, 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async api(url, method = 'GET', body = null) {
                    const headers = { 
                        'Authorization': 'Basic ' + btoa('admin:' + this.password),
                        'Content-Type': 'application/json'
                    };
                    const opts = { method, headers };
                    if (body) opts.body = JSON.stringify(body);
                    
                    try {
                        const res = await fetch(url, opts);
                        if (!res.ok) {
                            let errorMsg = `è¯·æ±‚å¤±è´¥ (${res.status})`;
                            try {
                                const err = await res.json();
                                errorMsg = err.detail || errorMsg;
                            } catch (e) {}
                            throw new Error(errorMsg);
                        }
                        return await res.json();
                    } catch (e) {
                        console.error("API Error:", e);
                        throw e;
                    }
                },

                async fetchAllData() {
                    this.loadingData = true;
                    try {
                        const [rules, stats, settings, blacklist, whitelist] = await Promise.all([
                            this.api('/api/rules'),
                            this.api('/api/stats'),
                            this.api('/api/settings/dedup'),
                            this.api('/api/blacklist'), // å•ç‹¬è·å–ä»¥ç¡®ä¿å®Œæ•´
                            this.api('/api/whitelist')
                        ]);
                        this.rules = rules;
                        this.stats = stats;
                        this.settings = settings;
                        
                        // æ˜ å°„é»‘åå•
                        this.blacklist.substring = this.arrayToText(blacklist.keywords_substring);
                        this.blacklist.word = this.arrayToText(blacklist.keywords_word);
                        this.blacklist.file = this.arrayToText(blacklist.file_name_keywords);
                        this.blacklist.regex = this.arrayToText(blacklist.patterns);
                        
                        // æ˜ å°„ç™½åå•
                        this.whitelist.keywords = this.arrayToText(whitelist.keywords);

                    } catch (e) {
                        this.showToast('æ•°æ®åŠ è½½å¤±è´¥', e.message, 'error');
                    } finally {
                        this.loadingData = false;
                    }
                },

                // Actions
                async saveSettings() {
                    try {
                        await this.api('/api/settings/dedup', 'POST', { days: parseInt(this.settings.dedup_retention_days) });
                        this.showToast('å·²ä¿å­˜', 'è®¾ç½®å·²æ›´æ–°');
                    } catch(e) { this.showToast('é”™è¯¯', e.message, 'error'); }
                },

                async addSource() {
                    if (!this.newSource) return;
                    try {
                        await this.api('/api/sources/add', 'POST', { identifier: this.newSource });
                        this.rules.sources.push({ identifier: this.newSource, resolved_id: null });
                        this.newSource = '';
                        this.needsReload = true;
                        this.showToast('æˆåŠŸ', 'ç›‘æ§æºå·²æ·»åŠ ');
                    } catch(e) { this.showToast('é”™è¯¯', e.message, 'error'); }
                },

                async removeSource(id) {
                    if (!confirm('ç¡®è®¤åˆ é™¤è¯¥ç›‘æ§æºå—?')) return;
                    try {
                        await this.api('/api/sources/remove', 'POST', { identifier: id });
                        this.rules.sources = this.rules.sources.filter(s => s.identifier !== id);
                        this.needsReload = true;
                        this.showToast('å·²åˆ é™¤', 'æºå·²ç§»é™¤');
                    } catch(e) { this.showToast('é”™è¯¯', e.message, 'error'); }
                },

                async addRule() {
                    if(!this.newRule.name || !this.newRule.target) return this.showToast('è­¦å‘Š', 'è§„åˆ™åç§°å’Œç›®æ ‡IDå¿…å¡«', 'error');
                    const payload = {
                        name: this.newRule.name,
                        target_identifier: this.newRule.target,
                        topic_id: this.newRule.topic ? parseInt(this.newRule.topic) : null,
                        all_keywords: this.textToArray(this.newRule.keywords),
                        file_name_patterns: this.textToArray(this.newRule.files)
                    };
                    try {
                        await this.api('/api/rules/add', 'POST', payload);
                        this.rules.distribution_rules.push(payload);
                        this.newRule = { name: '', target: '', topic: '', keywords: '', files: '' };
                        this.needsReload = true;
                        this.showToast('æˆåŠŸ', 'è½¬å‘è§„åˆ™å·²æ·»åŠ ');
                    } catch(e) { this.showToast('é”™è¯¯', e.message, 'error'); }
                },

                async removeRule(name) {
                    if(!confirm('ç¡®è®¤åˆ é™¤è¯¥è§„åˆ™å—?')) return;
                    try {
                        await this.api('/api/rules/remove', 'POST', { name });
                        this.rules.distribution_rules = this.rules.distribution_rules.filter(r => r.name !== name);
                        this.needsReload = true;
                        this.showToast('å·²åˆ é™¤', 'è§„åˆ™å·²ç§»é™¤');
                    } catch(e) { this.showToast('é”™è¯¯', e.message, 'error'); }
                },

                async saveBlacklist() {
                    try {
                        const payload = {
                            enable: true,
                            keywords_substring: this.textToArray(this.blacklist.substring),
                            keywords_word: this.textToArray(this.blacklist.word),
                            file_name_keywords: this.textToArray(this.blacklist.file),
                            patterns: this.textToArray(this.blacklist.regex)
                        };
                        await this.api('/api/blacklist/update', 'POST', payload);
                        this.needsReload = true;
                        this.showToast('æˆåŠŸ', 'é»‘åå•é…ç½®å·²æ›´æ–°');
                    } catch(e) { this.showToast('é”™è¯¯', e.message, 'error'); }
                },
                
                async saveWhitelist() {
                    try {
                        const payload = {
                            enable: true,
                            keywords: this.textToArray(this.whitelist.keywords)
                        };
                        await this.api('/api/whitelist/update', 'POST', payload);
                        this.needsReload = true;
                        this.showToast('æˆåŠŸ', 'ç™½åå•é…ç½®å·²æ›´æ–°');
                    } catch(e) { this.showToast('é”™è¯¯', e.message, 'error'); }
                },

                toggleTheme() {
                    const modes = ['light', 'dark', 'system'];
                    const next = modes[(modes.indexOf(this.theme) + 1) % modes.length];
                    this.theme = next;
                    localStorage.setItem('theme', next);
                },

                showToast(title, message, type = 'success') {
                    const id = Date.now();
                    this.toasts.push({ id, title, message, type, visible: true });
                    setTimeout(() => {
                        const t = this.toasts.find(t => t.id === id);
                        if(t) t.visible = false;
                    }, 3000);
                }
            }
        }
    </script>

    <!-- 6. Alpine.js (defer) -->
    <script src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
</head>

<body 
    x-data="app()" 
    x-init="initApp()" 
    class="bg-zinc-50 text-zinc-900 dark:bg-zinc-950 dark:text-zinc-100 transition-colors duration-300 min-h-screen flex flex-col font-sans"
    :class="{ 'dark': theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) }"
>

    <!-- Toast é€šçŸ¥ -->
    <div class="fixed top-4 right-4 z-50 space-y-2 pointer-events-none">
        <template x-for="toast in toasts" :key="toast.id">
            <div 
                x-show="toast.visible"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform translate-x-8"
                x-transition:enter-end="opacity-100 transform translate-x-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform translate-x-0"
                x-transition:leave-end="opacity-0 transform translate-x-8"
                class="pointer-events-auto max-w-xs w-full bg-white dark:bg-zinc-900 shadow-lg rounded-lg ring-1 ring-black ring-opacity-5 overflow-hidden border border-zinc-100 dark:border-zinc-800"
            >
                <div class="p-4 flex items-start">
                    <div class="flex-shrink-0">
                        <svg x-show="toast.type === 'success'" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <svg x-show="toast.type === 'error'" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <div class="ml-3 w-0 flex-1 pt-0.5">
                        <p class="text-sm font-medium text-zinc-900 dark:text-zinc-100" x-text="toast.title"></p>
                        <p class="mt-1 text-xs text-zinc-500 dark:text-zinc-400" x-text="toast.message"></p>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- ç™»å½•é®ç½© (å®Œå…¨æ±‰åŒ–) -->
    <div x-show="!authenticated" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl p-8 w-full max-w-sm border border-zinc-200 dark:border-zinc-800" @click.outside="$refs.pwd.focus()">
            <div class="text-center mb-8">
                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center mx-auto mb-4 text-blue-600 dark:text-blue-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <h2 class="text-xl font-bold text-zinc-900 dark:text-zinc-100">å®‰å…¨éªŒè¯</h2>
                <p class="text-sm text-zinc-500 mt-2">è¯·è¾“å…¥å¯†ç ä»¥ç®¡ç†è½¬å‘å™¨</p>
            </div>
            <form @submit.prevent="login">
                <input x-ref="pwd" type="password" x-model="password" class="form-input mb-4" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç ..." required>
                <button type="submit" :disabled="loading" class="w-full py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-medium transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center shadow-lg shadow-blue-600/20">
                    <span x-show="!loading">è§£é”æ§åˆ¶å°</span>
                    <svg x-show="loading" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </form>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div x-show="authenticated" x-cloak class="flex-grow flex flex-col">
        
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="sticky top-0 z-40 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-md border-b border-zinc-200 dark:border-zinc-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-blue-500/20 text-sm">TG</div>
                        <span class="font-bold text-lg tracking-tight text-zinc-800 dark:text-zinc-100">Forwarder</span>
                    </div>
                    
                    <!-- æ¡Œé¢ Tab -->
                    <div class="hidden md:flex space-x-1 bg-zinc-100 dark:bg-zinc-800 p-1 rounded-xl">
                        <template x-for="tab in tabs" :key="tab.id">
                            <button 
                                @click="currentTab = tab.id" 
                                :class="currentTab === tab.id ? 'bg-white dark:bg-zinc-700 shadow text-zinc-900 dark:text-white' : 'text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-200'"
                                class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all duration-200"
                                x-text="tab.name"
                            ></button>
                        </template>
                    </div>

                    <div class="flex items-center gap-3">
                        <button x-show="needsReload" @click="showToast('æç¤º', 'è¯·åœ¨ Telegram ä¸­å‘é€ /reload ä»¥åº”ç”¨æ›´æ”¹', 'success')" class="text-xs bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 px-3 py-1 rounded-full font-medium animate-pulse border border-amber-200 dark:border-amber-800">
                            é…ç½®å·²å˜æ›´
                        </button>
                        <button @click="toggleTheme" class="p-2 rounded-full hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors text-zinc-500">
                            <span x-show="theme === 'light'">â˜€ï¸</span>
                            <span x-show="theme === 'dark'">ğŸŒ™</span>
                            <span x-show="theme === 'system'">ğŸ’»</span>
                        </button>
                    </div>
                </div>
            </div>
            <!-- ç§»åŠ¨ç«¯ Tab -->
            <div class="md:hidden border-t border-zinc-200 dark:border-zinc-800 overflow-x-auto scrollbar-hide">
                <div class="flex px-4 py-2 space-x-4">
                    <template x-for="tab in tabs" :key="tab.id">
                        <button @click="currentTab = tab.id" :class="currentTab === tab.id ? 'text-blue-600 dark:text-blue-400 font-semibold' : 'text-zinc-500'" class="whitespace-nowrap text-sm py-2" x-text="tab.name"></button>
                    </template>
                </div>
            </div>
        </nav>

        <!-- å†…å®¹åŒºåŸŸ -->
        <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Loading éª¨æ¶å± -->
            <div x-show="loadingData" class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-pulse">
                <div class="h-32 bg-zinc-200 dark:bg-zinc-800 rounded-xl"></div>
                <div class="h-32 bg-zinc-200 dark:bg-zinc-800 rounded-xl"></div>
                <div class="h-32 bg-zinc-200 dark:bg-zinc-800 rounded-xl"></div>
            </div>

            <!-- Tab: çŠ¶æ€æ¦‚è§ˆ (è¡¥å…¨6ä¸ªæŒ‡æ ‡) -->
            <div x-show="currentTab === 'status' && !loadingData" x-transition.opacity class="space-y-6">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-6">
                    <!-- å¡ç‰‡ 1 -->
                    <div class="bg-white dark:bg-zinc-900 p-6 rounded-2xl border border-zinc-200 dark:border-zinc-800 hover-card">
                        <dt class="text-xs font-medium text-zinc-500 uppercase tracking-wider">æ•°æ®åº“å»é‡è®°å½•</dt>
                        <dd class="mt-2 text-3xl font-bold text-zinc-900 dark:text-white" x-text="stats.dedup_hashes || 0"></dd>
                    </div>
                    <!-- å¡ç‰‡ 2 -->
                    <div class="bg-white dark:bg-zinc-900 p-6 rounded-2xl border border-zinc-200 dark:border-zinc-800 hover-card">
                        <dt class="text-xs font-medium text-zinc-500 uppercase tracking-wider">æ´»è·ƒç›‘æ§æº</dt>
                        <dd class="mt-2 text-3xl font-bold text-blue-600 dark:text-blue-400" x-text="stats.sources || 0"></dd>
                    </div>
                    <!-- å¡ç‰‡ 3 -->
                    <div class="bg-white dark:bg-zinc-900 p-6 rounded-2xl border border-zinc-200 dark:border-zinc-800 hover-card">
                        <dt class="text-xs font-medium text-zinc-500 uppercase tracking-wider">åˆ†å‘è§„åˆ™æ•°</dt>
                        <dd class="mt-2 text-3xl font-bold text-purple-600 dark:text-purple-400" x-text="stats.distribution_rules || 0"></dd>
                    </div>
                    <!-- å¡ç‰‡ 4 -->
                    <div class="bg-white dark:bg-zinc-900 p-6 rounded-2xl border border-zinc-200 dark:border-zinc-800 hover-card">
                        <dt class="text-xs font-medium text-zinc-500 uppercase tracking-wider">é»‘åå•å…³é”®è¯</dt>
                        <dd class="mt-2 text-3xl font-bold text-red-500" x-text="(stats.blacklist_substring || 0) + (stats.blacklist_word || 0)"></dd>
                    </div>
                    <!-- å¡ç‰‡ 5 -->
                    <div class="bg-white dark:bg-zinc-900 p-6 rounded-2xl border border-zinc-200 dark:border-zinc-800 hover-card">
                        <dt class="text-xs font-medium text-zinc-500 uppercase tracking-wider">ç™½åå•å…³é”®è¯</dt>
                        <dd class="mt-2 text-3xl font-bold text-green-500" x-text="stats.whitelist_keywords || 0"></dd>
                    </div>
                    <!-- å¡ç‰‡ 6 -->
                    <div class="bg-white dark:bg-zinc-900 p-6 rounded-2xl border border-zinc-200 dark:border-zinc-800 hover-card">
                        <dt class="text-xs font-medium text-zinc-500 uppercase tracking-wider">å¤±æ•ˆé“¾æ¥å‘ç°</dt>
                        <dd class="mt-2 text-3xl font-bold text-amber-500" x-text="stats.invalid_links || 0"></dd>
                    </div>
                </div>

                <div class="bg-white dark:bg-zinc-900 p-8 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm">
                    <h3 class="text-lg font-bold mb-6 text-zinc-900 dark:text-white">ç³»ç»Ÿç»´æŠ¤è®¾ç½®</h3>
                    <div class="max-w-xl">
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">å»é‡è®°å½•ä¿ç•™å¤©æ•°</label>
                            <span class="font-mono font-bold text-blue-600" x-text="settings.dedup_retention_days + ' å¤©'"></span>
                        </div>
                        <input type="range" min="1" max="30" x-model="settings.dedup_retention_days" @change="saveSettings" class="w-full">
                        <p class="mt-2 text-xs text-zinc-400">å‡å°‘å¤©æ•°å¯ç¼©å°æ•°æ®åº“ä½“ç§¯ã€‚ä¿®æ”¹å°†åœ¨ä¸‹ä¸€æ¬¡æ¯æ—¥ç»´æŠ¤ä»»åŠ¡æ—¶ç”Ÿæ•ˆã€‚</p>
                    </div>
                </div>
            </div>

            <!-- Tab: ç›‘æ§æº (ç½‘æ ¼å¸ƒå±€ä¼˜åŒ–) -->
            <div x-show="currentTab === 'sources' && !loadingData" class="space-y-6">
                <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-zinc-100 dark:border-zinc-800 flex flex-col md:flex-row gap-4 justify-between items-center bg-zinc-50/50 dark:bg-zinc-900/50">
                        <h3 class="text-lg font-bold text-zinc-900 dark:text-white">ç›‘æ§æºç®¡ç†</h3>
                        <div class="flex w-full md:w-auto gap-2">
                            <input x-model="newSource" @keyup.enter="addSource" type="text" placeholder="@é¢‘é“å æˆ– -100..." class="form-input md:w-64">
                            <button @click="addSource" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-lg shadow-blue-600/20">æ·»åŠ æº</button>
                        </div>
                    </div>
                    
                    <!-- å“åº”å¼ç½‘æ ¼å¸ƒå±€ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                        <template x-for="source in rules.sources" :key="source.identifier">
                            <div class="p-4 rounded-xl bg-zinc-50 dark:bg-zinc-800/50 border border-zinc-200 dark:border-zinc-700/50 flex justify-between items-start group hover:border-blue-500 dark:hover:border-blue-500 transition-colors">
                                <div class="overflow-hidden">
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono font-bold text-sm text-zinc-800 dark:text-zinc-200 truncate" x-text="source.identifier"></span>
                                    </div>
                                    <div class="flex items-center gap-2 mt-2">
                                        <span x-show="source.resolved_id" class="text-[10px] px-1.5 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded font-bold">æ´»è·ƒ</span>
                                        <span x-show="!source.resolved_id" class="text-[10px] px-1.5 py-0.5 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded font-bold">å¾…è§£æ</span>
                                        <span class="text-xs text-zinc-400 font-mono truncate" x-text="source.resolved_id || 'Waiting...'"></span>
                                    </div>
                                </div>
                                <button @click="removeSource(source.identifier)" class="text-zinc-300 hover:text-red-500 p-1 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </template>
                        <div x-show="rules.sources.length === 0" class="col-span-full p-8 text-center text-zinc-500">æš‚æ— ç›‘æ§æº</div>
                    </div>
                </div>
            </div>

            <!-- Tab: è½¬å‘è§„åˆ™ (å¢å¼ºå¡ç‰‡ä¿¡æ¯) -->
            <div x-show="currentTab === 'rules' && !loadingData" class="space-y-6">
                <!-- æ·»åŠ è§„åˆ™å¡ç‰‡ -->
                <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4 text-zinc-900 dark:text-white">æ·»åŠ åˆ†å‘è§„åˆ™</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input x-model="newRule.name" type="text" placeholder="è§„åˆ™åç§° (å¦‚: æ¬è¿è§†é¢‘)" class="form-input">
                        <input x-model="newRule.target" type="text" placeholder="ç›®æ ‡ ID (-100...)" class="form-input">
                        <input x-model="newRule.topic" type="number" placeholder="è¯é¢˜ ID (å¯é€‰)" class="form-input">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <textarea x-model="newRule.keywords" rows="3" placeholder="åŒ…å«å…³é”®è¯ (æ¯è¡Œä¸€ä¸ªï¼Œæ»¡è¶³æ‰€æœ‰)" class="form-textarea"></textarea>
                        <textarea x-model="newRule.files" rows="3" placeholder="æ–‡ä»¶åæ­£åˆ™ (å¦‚ *.apkï¼Œæ»¡è¶³ä»»ä¸€)" class="form-textarea"></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button @click="addRule" class="bg-zinc-900 dark:bg-white text-white dark:text-black px-6 py-2 rounded-lg font-bold text-sm hover:opacity-90 transition-opacity shadow-lg">ä¿å­˜è§„åˆ™</button>
                    </div>
                </div>

                <!-- è§„åˆ™åˆ—è¡¨ (ç½‘æ ¼å¸ƒå±€) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <template x-for="rule in rules.distribution_rules" :key="rule.name">
                        <div class="bg-white dark:bg-zinc-900 p-5 rounded-xl border border-zinc-200 dark:border-zinc-800 shadow-sm flex flex-col justify-between group hover:border-purple-500 dark:hover:border-purple-500 transition-colors relative overflow-hidden">
                            <div>
                                <div class="flex justify-between items-start">
                                    <h4 class="font-bold text-zinc-900 dark:text-zinc-100 text-lg" x-text="rule.name"></h4>
                                    <button @click="removeRule(rule.name)" class="text-xs text-red-500 bg-red-50 dark:bg-red-900/20 px-2 py-1 rounded hover:bg-red-100 transition-colors">åˆ é™¤</button>
                                </div>
                                
                                <div class="flex flex-wrap gap-2 mt-3">
                                    <span class="bg-zinc-100 dark:bg-zinc-800 px-2 py-1 rounded text-xs font-mono text-zinc-600 dark:text-zinc-300" x-text="'To: ' + rule.target_identifier"></span>
                                    <span x-show="rule.topic_id" class="bg-purple-50 dark:bg-purple-900/20 px-2 py-1 rounded text-xs font-mono text-purple-600 dark:text-purple-300" x-text="'Topic: ' + rule.topic_id"></span>
                                </div>

                                <!-- è§„åˆ™è¯¦æƒ…æ‘˜è¦ -->
                                <div class="mt-4 space-y-2">
                                    <div x-show="rule.all_keywords && rule.all_keywords.length" class="text-xs">
                                        <span class="text-zinc-400">å…³é”®è¯:</span>
                                        <span class="text-zinc-700 dark:text-zinc-300 ml-1" x-text="rule.all_keywords.join(', ')"></span>
                                    </div>
                                    <div x-show="rule.file_name_patterns && rule.file_name_patterns.length" class="text-xs">
                                        <span class="text-zinc-400">æ–‡ä»¶:</span>
                                        <span class="text-zinc-700 dark:text-zinc-300 ml-1" x-text="rule.file_name_patterns.join(', ')"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Tab: é»‘åå• (å®Œæ•´åŠŸèƒ½) -->
            <div x-show="currentTab === 'blacklist' && !loadingData">
                 <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6 border-b border-zinc-100 dark:border-zinc-800 pb-4">
                        <div>
                            <h3 class="text-lg font-bold text-zinc-900 dark:text-white">å¹¿å‘Šè¿‡æ»¤ (é»‘åå•)</h3>
                            <p class="text-sm text-zinc-500">å‘½ä¸­ä»»æ„æ¡ä»¶çš„å¹¿å‘Šå°†è¢«ä¸¢å¼ƒã€‚</p>
                        </div>
                        <button @click="saveBlacklist" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-600/20">ä¿å­˜æ‰€æœ‰æ›´æ”¹</button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">ğŸš« å…³é”®è¯ (ä¸­æ–‡/éƒ¨åˆ†åŒ¹é…)</label>
                            <textarea x-model="blacklist.substring" rows="5" class="form-textarea font-mono text-xs" placeholder="ä¾‹å¦‚ï¼šå‘è´¢å¨±ä¹&#10;è·å®˜"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">ğŸ”¤ å…³é”®è¯ (è‹±æ–‡/å…¨è¯åŒ¹é…)</label>
                            <textarea x-model="blacklist.word" rows="5" class="form-textarea font-mono text-xs" placeholder="ä¾‹å¦‚ï¼šad&#10;promo (ä¸ä¼šåŒ¹é… admin)"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">ğŸ“ æ–‡ä»¶åè¿‡æ»¤</label>
                            <textarea x-model="blacklist.file" rows="5" class="form-textarea font-mono text-xs" placeholder="ä¾‹å¦‚ï¼šèŠ’æœVPN&#10;å«ç¾è‰.apk"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">ğŸ§© æ­£åˆ™è¡¨è¾¾å¼ (é«˜çº§)</label>
                            <textarea x-model="blacklist.regex" rows="5" class="form-textarea font-mono text-xs" placeholder="ä¾‹å¦‚ï¼šgroup[0-9]{5,}"></textarea>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- Tab: ç™½åå• (åŠŸèƒ½å›å½’) -->
            <div x-show="currentTab === 'whitelist' && !loadingData">
                <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm p-6 border-l-4 border-l-green-500">
                   <div class="flex justify-between items-center mb-6 border-b border-zinc-100 dark:border-zinc-800 pb-4">
                       <div>
                           <h3 class="text-lg font-bold text-zinc-900 dark:text-white">å¿…å‘ç™½åå• (æœ€é«˜ä¼˜å…ˆçº§)</h3>
                           <p class="text-sm text-zinc-500">åªè¦æ¶ˆæ¯åŒ…å«ä»¥ä¸‹ä»»ä¸€å…³é”®è¯ï¼Œå³ä½¿è§¦å‘é»‘åå•ä¹Ÿä¼šè¢«å¼ºåˆ¶è½¬å‘ã€‚</p>
                       </div>
                       <button @click="saveWhitelist" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-green-600/20">ä¿å­˜ç™½åå•</button>
                   </div>
                   
                   <div class="space-y-2">
                       <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">âœ… å…³é”®è¯åˆ—è¡¨ (æ¯è¡Œä¸€ä¸ª)</label>
                       <textarea x-model="whitelist.keywords" rows="8" class="form-textarea font-mono text-sm" placeholder="ä¾‹å¦‚ï¼šé‡è¦é€šçŸ¥&#10;è€æ¿&#10;#MustRead"></textarea>
                   </div>
                </div>
           </div>

        </main>
    </div>
</body>
</html>