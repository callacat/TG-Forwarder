<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG Forwarder é…ç½®é¢æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }
        /* æŒ‰é’®å†…çš„ loader é¢œè‰²é€‚é… */
        .btn-loader-blue { border-left-color: #3b82f6; border-color: rgba(59, 130, 246, 0.3); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .nav-link {
             transition: color 0.2s ease, border-color 0.2s ease;
        }
        .panel {
            transition: background-color 0.3s ease;
        }
        .list-item {
            transition: background-color 0.2s ease;
        }
        /* Range slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            background: transparent; 
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e5e7eb;
            border-radius: 2px;
        }
        .dark input[type="range"]::-webkit-slider-runnable-track {
            background: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200 font-sans antialiased transition-colors duration-300">

    <!-- ç™»å½•é®ç½© -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-sm mx-4 border border-gray-200 dark:border-gray-700">
            <div class="text-center mb-6">
                <span class="text-4xl">ğŸ”’</span>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mt-4">éªŒè¯èº«ä»½</h2>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400 text-center mb-6">
                è¯·è¾“å…¥ <code>config.yaml</code> ä¸­è®¾ç½®çš„ <br><code>web_ui.password</code>
            </p>
            <div class="space-y-4">
                <div>
                    <label for="password-input" class="sr-only">å¯†ç </label>
                    <input type="password" id="password-input" class="block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="è¾“å…¥å¯†ç ...">
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center font-medium hidden bg-red-50 dark:bg-red-900/20 py-2 rounded">
                    å¯†ç é”™è¯¯
                </div>
                <button id="login-button" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:opacity-70">
                    <span id="login-button-text">è§£é”é¢æ¿</span>
                    <div id="login-button-loader" class="loader hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨å¤–å£³ (é»˜è®¤éšè—) -->
    <div id="app-shell" class="hidden min-h-screen flex flex-col">
        
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40 transition-colors duration-300">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <!-- Logo & Title -->
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center space-x-2">
                            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            <span class="text-xl font-bold text-gray-900 dark:text-white tracking-tight">TG Forwarder</span>
                        </div>
                        <!-- æ¡Œé¢ç«¯å¯¼èˆª -->
                        <div class="hidden md:ml-10 md:flex md:space-x-8" id="main-nav">
                            <!-- å¯¼èˆªæ ‡ç­¾ JS æ’å…¥ -->
                        </div>
                    </div>
                    
                    <!-- å³ä¾§å·¥å…·æ  -->
                    <div class="flex items-center space-x-4">
                        <!-- é‡è½½æç¤º (ç®€ç‰ˆ) -->
                        <button id="quick-reload-hint" class="hidden text-yellow-600 dark:text-yellow-400 text-xs font-medium bg-yellow-100 dark:bg-yellow-900/30 px-2 py-1 rounded border border-yellow-200 dark:border-yellow-800 cursor-help" title="é…ç½®å·²æ›´æ”¹ï¼Œè¯·åœ¨ Bot ä¸­æ‰§è¡Œ /reload">
                            éœ€è¦ Reload
                        </button>

                        <!-- ä¸»é¢˜åˆ‡æ¢ -->
                        <div class="relative">
                            <button id="theme-toggle-button" type="button" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none transition-colors">
                                <span class="sr-only">åˆ‡æ¢ä¸»é¢˜</span>
                                <span id="theme-icon-light" class="hidden text-xl">â˜€ï¸</span>
                                <span id="theme-icon-dark" class="hidden text-xl">ğŸŒ™</span>
                                <span id="theme-icon-system" class="hidden text-xl">ğŸ’»</span>
                            </button>
                            <!-- ä¸‹æ‹‰èœå• -->
                            <div id="theme-menu" class="absolute right-0 mt-2 w-36 rounded-lg shadow-xl bg-white dark:bg-gray-700 ring-1 ring-black ring-opacity-5 hidden transform opacity-0 scale-95 transition-all duration-200 origin-top-right z-50">
                                <div class="py-1">
                                    <a href="#" class="theme-menu-item flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600" data-theme="light">â˜€ï¸ äº®è‰²æ¨¡å¼</a>
                                    <a href="#" class="theme-menu-item flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600" data-theme="dark">ğŸŒ™ æš—è‰²æ¨¡å¼</a>
                                    <a href="#" class="theme-menu-item flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600" data-theme="system">ğŸ’» è·Ÿéšç³»ç»Ÿ</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ç§»åŠ¨ç«¯å¯¼èˆªå®¹å™¨ (å¯æ‰©å±•) -->
            <div class="md:hidden border-t border-gray-200 dark:border-gray-700 overflow-x-auto scrollbar-hide">
                <div class="flex px-4 space-x-6" id="mobile-nav">
                    <!-- JS å¡«å…… -->
                </div>
            </div>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="flex-grow py-8 bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                
                <!-- "è¯· Reload" çš„å…¨å±€æç¤º -->
                <div id="reload-notice" class="hidden mb-8 transform transition-all duration-500 ease-out translate-y-[-10px] opacity-0" role="alert">
                    <div class="bg-gradient-to-r from-yellow-50 to-white dark:from-gray-800 dark:to-gray-800 border-l-4 border-yellow-500 rounded-r-lg shadow-md p-4 flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        </div>
                        <div class="ml-3 w-full">
                            <h3 class="text-sm font-bold text-yellow-800 dark:text-yellow-300">é…ç½®å·²ä¿å­˜</h3>
                            <div class="mt-1 text-sm text-yellow-700 dark:text-yellow-400">
                                <p>æ›´æ”¹å·²å†™å…¥ <code>rules_db.json</code>ã€‚è¯·åœ¨ Telegram Bot ä¸­å‘é€ <code>/reload</code> å‘½ä»¤ä½¿å…¶ç”Ÿæ•ˆã€‚</p>
                            </div>
                        </div>
                        <div class="ml-auto pl-3">
                            <div class="-mx-1.5 -my-1.5">
                                <button type="button" onclick="hideReloadNotice()" class="inline-flex bg-transparent rounded-md p-1.5 text-yellow-500 hover:bg-yellow-100 dark:hover:bg-gray-700 focus:outline-none">
                                    <span class="sr-only">å…³é—­</span>
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åŠ¨æ€å†…å®¹é¢æ¿ -->
                <div id="content-panels" class="transition-opacity duration-200">
                    <!-- é¢æ¿å°†ç”± JS åŠ¨æ€æ’å…¥ -->
                </div>

            </div>
        </main>
        
        <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 py-6">
            <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-400 dark:text-gray-500">
                TG Forwarder v9.3 &copy; 2024
            </div>
        </footer>

    </div>

    <!-- JS é€»è¾‘ -->
    <script>
        // --- å…¨å±€çŠ¶æ€å’Œ API å¸®åŠ©ç¨‹åº ---
        
        const API_USERNAME = "admin";
        let API_PASSWORD = "";
        let AUTH_HEADER = "";

        async function apiFetch(url, options = {}) {
            if (!AUTH_HEADER) {
                showLoginModal();
                throw new Error("æœªè®¤è¯");
            }
            const defaultHeaders = {
                'Authorization': AUTH_HEADER,
                'Content-Type': 'application/json'
            };
            const config = { ...options, headers: { ...defaultHeaders, ...options.headers } };
            if (options.body) { config.body = JSON.stringify(options.body); }
            try {
                const response = await fetch(url, config);
                if (response.status === 401) {
                    localStorage.removeItem('tgf_password'); 
                    showLoginModal("å¯†ç é”™è¯¯æˆ–ä¼šè¯å·²è¿‡æœŸ");
                    throw new Error("è®¤è¯å¤±è´¥");
                }
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP é”™è¯¯ ${response.status}`);
                }
                const text = await response.text();
                return text ? JSON.parse(text) : {};
            } catch (error) {
                console.error(`API è¯·æ±‚ ${url} å¤±è´¥:`, error);
                throw error;
            }
        }

        // --- ç™»å½•é€»è¾‘ ---
        
        const loginModal = document.getElementById('login-modal');
        const loginButton = document.getElementById('login-button');
        const loginBtnText = document.getElementById('login-button-text');
        const loginBtnLoader = document.getElementById('login-button-loader');
        const passwordInput = document.getElementById('password-input');
        const loginError = document.getElementById('login-error');
        const appShell = document.getElementById('app-shell');

        function showLoginModal(errorMsg = null) {
            loginModal.classList.remove('opacity-0', 'pointer-events-none');
            loginModal.classList.add('opacity-100');
            appShell.classList.add('blur-sm'); // å¢åŠ èƒŒæ™¯æ¨¡ç³Š
            if (errorMsg) {
                loginError.textContent = errorMsg;
                loginError.classList.remove('hidden');
            } else {
                loginError.classList.add('hidden');
            }
            passwordInput.value = "";
            passwordInput.focus();
        }

        function hideLoginModal() {
            loginModal.classList.add('opacity-0', 'pointer-events-none');
            loginModal.classList.remove('opacity-100');
            appShell.classList.remove('blur-sm', 'hidden');
        }
        
        function setLoading(isLoading) {
             if(isLoading) {
                loginBtnText.classList.add('hidden');
                loginBtnLoader.classList.remove('hidden');
                loginButton.disabled = true;
             } else {
                loginBtnText.classList.remove('hidden');
                loginBtnLoader.classList.add('hidden');
                loginButton.disabled = false;
             }
        }

        async function handleLogin(password) {
            setLoading(true);
            loginError.classList.add('hidden');

            if (!password) {
                loginError.textContent = "è¯·è¾“å…¥å¯†ç ";
                loginError.classList.remove('hidden');
                setLoading(false);
                return;
            }

            API_PASSWORD = password;
            AUTH_HEADER = 'Basic ' + btoa(API_USERNAME + ':' + API_PASSWORD);

            try {
                await apiFetch('/api/rules');
                setLoading(false);
                hideLoginModal();
                localStorage.setItem('tgf_password', password); 
                initializeApp(); 
            } catch (error) {
                setLoading(false);
                AUTH_HEADER = ""; 
                localStorage.removeItem('tgf_password'); 
                if(error.message !== "è®¤è¯å¤±è´¥") {
                     loginError.textContent = "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨";
                } else {
                     loginError.textContent = "å¯†ç ä¸æ­£ç¡®";
                }
                loginError.classList.remove('hidden');
            }
        }
        
        loginButton.addEventListener('click', () => handleLogin(passwordInput.value));
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin(passwordInput.value);
        });
        
        async function checkSavedAuth() {
            const savedPassword = localStorage.getItem('tgf_password');
            if (savedPassword) {
                await handleLogin(savedPassword);
            } else {
                showLoginModal(); 
            }
        }

        // --- ä¸»é¢˜åˆ‡æ¢é€»è¾‘ (å·²ä¿®å¤) ---
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const themeMenu = document.getElementById('theme-menu');
        const themeIcons = {
            light: document.getElementById('theme-icon-light'),
            dark: document.getElementById('theme-icon-dark'),
            system: document.getElementById('theme-icon-system'),
        };
        
        // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
        const systemThemeMedia = window.matchMedia('(prefers-color-scheme: dark)');

        function applyTheme(theme) {
            // éšè—æ‰€æœ‰å›¾æ ‡
            Object.values(themeIcons).forEach(el => el.classList.add('hidden'));
            
            // ç§»é™¤å¯èƒ½çš„ç›‘å¬å™¨ (ç®€å•å¤„ç†ï¼šé‡æ–°ç»‘å®šç›‘å¬å™¨æˆæœ¬ä½)
            systemThemeMedia.onchange = null;

            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIcons.dark.classList.remove('hidden');
            } else if (theme === 'light') {
                document.documentElement.classList.remove('dark');
                themeIcons.light.classList.remove('hidden');
            } else { // system
                // åˆå§‹åˆ¤æ–­
                if (systemThemeMedia.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                // ç»‘å®šç›‘å¬
                systemThemeMedia.onchange = (e) => {
                    if (localStorage.getItem('theme') === 'system') {
                        if (e.matches) document.documentElement.classList.add('dark');
                        else document.documentElement.classList.remove('dark');
                    }
                };
                themeIcons.system.classList.remove('hidden');
            }
        }

        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            applyTheme(theme);
            themeMenu.classList.add('hidden', 'opacity-0', 'scale-95');
        }

        // --- ä¸»åº”ç”¨é€»è¾‘ ---
        
        const mainNav = document.getElementById('main-nav');
        const mobileNav = document.getElementById('mobile-nav');
        const contentPanels = document.getElementById('content-panels');
        const reloadNotice = document.getElementById('reload-notice');
        const quickReloadHint = document.getElementById('quick-reload-hint');
        
        let state = { rules: {}, stats: {}, settings: {} }; 
        
        const TABS = {
            'status': "çŠ¶æ€ & è®¾ç½®", 
            'sources': "ç›‘æ§æº",
            'rules': "è½¬å‘è§„åˆ™",
            'blacklist': "é»‘åå•",
            'whitelist': "ç™½åå•"
        };
        
        function showReloadNotice() {
            reloadNotice.classList.remove('hidden');
            // å°åŠ¨ç”»
            setTimeout(() => {
                reloadNotice.classList.remove('translate-y-[-10px]', 'opacity-0');
            }, 10);
            quickReloadHint.classList.remove('hidden');
        }
        
        window.hideReloadNotice = function() {
            reloadNotice.classList.add('translate-y-[-10px]', 'opacity-0');
            setTimeout(() => {
                reloadNotice.classList.add('hidden');
            }, 500);
        }
        
        function arrayToText(arr) {
            if (!arr || arr.length === 0) return "";
            return arr.join('\n');
        }
        
        function textToArray(text) {
            if (!text) return [];
            return text.split('\n')
                       .map(s => s.trim())
                       .filter(Boolean); 
        }

        // --- é¢æ¿æ¸²æŸ“å‡½æ•° ---

        // 1. çŠ¶æ€ & è®¾ç½®
        function renderStatsPanel(stats, settings) {
            const { 
                dedup_hashes = 0, forward_progress_channels = 0, invalid_links = 0,
                sources = 0, distribution_rules = 0, whitelist_keywords = 0,
                blacklist_substring = 0, blacklist_word = 0, blacklist_file = 0, blacklist_regex = 0
            } = stats || {};
            const { dedup_retention_days = 30 } = settings || {};
            const blacklist_total = blacklist_substring + blacklist_word + blacklist_file + blacklist_regex;

            return `
                <div class="grid grid-cols-1 gap-6">
                    <!-- æ¦‚è§ˆå¡ç‰‡ -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                        <h2 class="text-lg font-bold mb-4 text-gray-900 dark:text-gray-100 flex items-center">
                            <span class="mr-2">ğŸ“Š</span> è¿è¡Œç»Ÿè®¡
                        </h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            ${renderStatCard("å»é‡è®°å½•", dedup_hashes, "blue")}
                            ${renderStatCard("è½¬å‘è¿›åº¦", forward_progress_channels, "indigo")}
                            ${renderStatCard("å¤±æ•ˆé“¾æ¥", invalid_links, "red")}
                            ${renderStatCard("ç›‘æ§æº", sources, "green")}
                            ${renderStatCard("è½¬å‘è§„åˆ™", distribution_rules, "purple")}
                            ${renderStatCard("é»‘/ç™½åå•", `${blacklist_total} / ${whitelist_keywords}`, "gray")}
                        </div>
                    </div>

                    <!-- è®¾ç½®å¡ç‰‡ -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                        <h2 class="text-lg font-bold mb-4 text-gray-900 dark:text-gray-100 flex items-center">
                            <span class="mr-2">âš™ï¸</span> æ•°æ®åº“è®¾ç½®
                        </h2>
                        <div class="max-w-lg">
                            <div class="flex justify-between mb-2">
                                <label for="dedup-slider" class="text-sm font-medium text-gray-700 dark:text-gray-300">å»é‡è®°å½•ä¿ç•™æ—¶é—´</label>
                                <span class="text-sm font-bold text-blue-600 dark:text-blue-400"><span id="dedup-days-label">${dedup_retention_days}</span> å¤©</span>
                            </div>
                            <input id="dedup-slider" type="range" min="1" max="30" value="${dedup_retention_days}" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                æ›´çŸ­çš„æ—¶é—´å¯ä»¥å‡å°‘ <code>forwarder.sqlite</code> çš„ä½“ç§¯ã€‚è®¾ç½®å°†åœ¨æ¯å¤©å‡Œæ™¨ 4:05 (UTC) çš„ç»´æŠ¤ä»»åŠ¡ä¸­ç”Ÿæ•ˆã€‚
                            </p>
                            <div class="mt-4">
                                <button id="save-dedup" class="btn-primary inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <span id="save-dedup-text">ä¿å­˜è®¾ç½®</span>
                                    <div id="save-dedup-loader" class="loader hidden ml-2"></div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderStatCard(label, value, color) {
            const colorMap = {
                blue: 'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20',
                red: 'text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20',
                green: 'text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20',
                purple: 'text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/20',
                indigo: 'text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/20',
                gray: 'text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700/50',
            };
            const style = colorMap[color] || colorMap.gray;
            
            return `
                <div class="p-4 rounded-lg ${style.split(' ')[2]} ${style.split(' ')[3]} border border-transparent hover:border-opacity-50 transition-all">
                    <dt class="text-xs font-medium opacity-80 uppercase tracking-wider text-gray-500 dark:text-gray-400">${label}</dt>
                    <dd class="mt-1 text-2xl font-bold ${style.split(' ')[0]} ${style.split(' ')[1]}">${value}</dd>
                </div>
            `;
        }

        // 2. ç›‘æ§æº (ä¿®å¤äº†åˆ é™¤æŒ‰é’®å¸ƒå±€)
        function renderSourcesPanel(data) {
            const sources = data || [];
            return `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">ç›‘æ§æºåˆ—è¡¨</h2>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Bot å°†ç›‘å¬è¿™äº›é¢‘é“çš„æ¶ˆæ¯ã€‚</p>
                        </div>
                        <div class="flex w-full sm:w-auto gap-2">
                            <input type="text" id="new-source-id" class="flex-grow sm:w-64 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="é¢‘é“ID, @username æˆ–é“¾æ¥">
                            <button id="add-source-button" class="flex-shrink-0 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors flex items-center justify-center min-w-[80px]">
                                <span id="add-source-text">æ·»åŠ </span>
                                <div id="add-source-loader" class="loader hidden"></div>
                            </button>
                        </div>
                    </div>

                    <div class="divide-y divide-gray-200 dark:divide-gray-700">
                        ${sources.length === 0 ? '<div class="p-8 text-center text-gray-500 dark:text-gray-400">æš‚æ— ç›‘æ§æº</div>' : ''}
                        ${sources.map(s => `
                            <div class="group flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                <!-- ä¿®å¤ï¼šæ·»åŠ  flex-1 å’Œ min-w-0 ç¡®ä¿æ–‡æœ¬æ­£ç¡®æˆªæ–­ä¸”ä¸æŒ¤å‹æŒ‰é’® -->
                                <div class="flex-1 min-w-0 mr-4">
                                    <div class="flex items-center">
                                        <p class="text-sm font-semibold text-gray-900 dark:text-gray-100 truncate" title="${s.identifier}">${s.identifier}</p>
                                        ${s.resolved_id ? `<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">å·²è§£æ</span>` : 
                                        `<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200" title="è¯· /reload">æœªè§£æ</span>`}
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 font-mono truncate">
                                        ID: ${s.resolved_id || 'Waiting for reload...'}
                                    </p>
                                </div>
                                <button data-id="${s.identifier}" class="remove-source-btn flex-shrink-0 p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-full transition-all focus:outline-none" title="åˆ é™¤">
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // 3. è½¬å‘è§„åˆ™ (å®Œæ•´å®ç°)
        function renderRulesPanel(data) {
            const rules = data || [];
            return `
                <div class="space-y-6">
                    <!-- æ·»åŠ è§„åˆ™å¡ç‰‡ (é»˜è®¤æŠ˜å ) -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <button id="toggle-add-rule" class="w-full px-6 py-4 flex justify-between items-center bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left focus:outline-none">
                            <div>
                                <h2 class="text-lg font-bold text-gray-900 dark:text-gray-100">æ·»åŠ æ–°è½¬å‘è§„åˆ™</h2>
                                <p class="text-xs text-gray-500 dark:text-gray-400">åˆ›å»ºåŸºäºå…³é”®è¯æˆ–æ–‡ä»¶åçš„åˆ†å‘ç­–ç•¥</p>
                            </div>
                            <svg id="add-rule-icon" class="h-5 w-5 text-gray-500 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        </button>
                        
                        <div id="add-rule-form-container" class="hidden border-t border-gray-200 dark:border-gray-700 p-6 space-y-4 bg-white dark:bg-gray-800">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">è§„åˆ™åç§° <span class="text-red-500">*</span></label>
                                    <input type="text" id="rule-name" class="w-full form-input rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm" placeholder="ä¾‹å¦‚: ç”µå½±è½¬å‘">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ç›®æ ‡ ID <span class="text-red-500">*</span></label>
                                    <input type="text" id="rule-target" class="w-full form-input rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm" placeholder="-100... æˆ– @channel">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">è¯é¢˜ ID (Topic ID)</label>
                                    <input type="number" id="rule-topic" class="w-full form-input rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm" placeholder="å¯é€‰ï¼Œä¾‹å¦‚: 1">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-100 dark:border-gray-700 pt-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å¿…é¡»åŒ…å« (All Keywords)</label>
                                    <textarea id="rule-all-kw" rows="3" class="w-full form-textarea rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm font-mono" placeholder="æ¯è¡Œä¸€ä¸ªï¼Œéœ€å…¨éƒ¨åŒ¹é…"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ä»»ä¸€åŒ…å« (Any Keywords)</label>
                                    <textarea id="rule-any-kw" rows="3" class="w-full form-textarea rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm font-mono" placeholder="æ¯è¡Œä¸€ä¸ªï¼Œæ»¡è¶³å…¶ä¸€å³å¯"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æ–‡ä»¶åæ­£åˆ™ (File Patterns)</label>
                                    <textarea id="rule-file-pat" rows="3" class="w-full form-textarea rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm font-mono" placeholder="ä¾‹å¦‚: *.apk&#10;*.exe"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">MIME ç±»å‹ (File Types)</label>
                                    <textarea id="rule-file-types" rows="3" class="w-full form-textarea rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm font-mono" placeholder="ä¾‹å¦‚: video/mp4"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end pt-2">
                                <button id="save-rule-btn" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors flex items-center">
                                    <span id="save-rule-text">æ·»åŠ è§„åˆ™</span>
                                    <div id="save-rule-loader" class="loader hidden ml-2"></div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- è§„åˆ™åˆ—è¡¨ -->
                    <div class="space-y-4">
                         ${rules.length === 0 ? '<div class="text-center py-10 text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">æ²¡æœ‰è®¾ç½®ä»»ä½•è½¬å‘è§„åˆ™ï¼Œæ‰€æœ‰æ¶ˆæ¯å°†è½¬å‘åˆ°é»˜è®¤ç›®æ ‡ã€‚</div>' : ''}
                         ${rules.map((rule, idx) => renderRuleCard(rule, idx)).join('')}
                    </div>
                </div>
            `;
        }

        function renderRuleCard(rule, idx) {
            // ç®€æ˜“æ‘˜è¦ç”Ÿæˆ
            const conditions = [];
            if(rule.all_keywords?.length) conditions.push(`<span class="text-blue-600 dark:text-blue-400">All:</span> ${rule.all_keywords.length}ä¸ª`);
            if(rule.any_keywords?.length) conditions.push(`<span class="text-purple-600 dark:text-purple-400">Any:</span> ${rule.any_keywords.length}ä¸ª`);
            if(rule.file_name_patterns?.length) conditions.push(`<span class="text-green-600 dark:text-green-400">Files:</span> ${rule.file_name_patterns.join(', ')}`);
            
            return `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5 flex flex-col sm:flex-row justify-between items-start gap-4 transition-all hover:shadow-md">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono text-gray-500">#${idx + 1}</span>
                            <h3 class="font-bold text-gray-900 dark:text-gray-100">${rule.name}</h3>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                            <p>ğŸ¯ ç›®æ ‡: <code class="bg-gray-100 dark:bg-gray-900 px-1 rounded text-xs">${rule.target_identifier}</code> ${rule.topic_id ? `(Topic: ${rule.topic_id})` : ''}</p>
                            <p class="text-xs opacity-80">ğŸ” æ¡ä»¶: ${conditions.join(' | ') || 'æ— é™åˆ¶'}</p>
                        </div>
                    </div>
                    <button onclick="handleRemoveRule('${rule.name}')" class="flex-shrink-0 text-sm text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-2 rounded-md transition-colors">
                        åˆ é™¤
                    </button>
                </div>
            `;
        }

        // 4. é»‘åå•
        function renderBlacklistPanel(data) {
            const { keywords_substring, keywords_word, file_name_keywords, patterns } = data || {};
            return `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">å¹¿å‘Šè¿‡æ»¤ (Blacklist)</h2>
                        <button id="save-blacklist" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium flex items-center">
                            <span id="save-blacklist-text">ä¿å­˜æ›´æ”¹</span>
                            <div id="save-blacklist-loader" class="loader hidden ml-2"></div>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${renderTextareaGroup("bl-sub", "å­å­—ç¬¦ä¸²åŒ¹é… (ä¸­æ–‡)", "å¦‚: å‘è´¢å¨±ä¹, èµŒåœº", keywords_substring)}
                        ${renderTextareaGroup("bl-word", "å…¨è¯åŒ¹é… (è‹±æ–‡)", "å¦‚: ad, promo (ä¸åŒ¹é… download)", keywords_word)}
                        ${renderTextareaGroup("bl-file", "æ–‡ä»¶åè¿‡æ»¤", "å¦‚: èŠ’æœVPN, .exe", file_name_keywords)}
                        ${renderTextareaGroup("bl-regex", "æ­£åˆ™è¡¨è¾¾å¼ (é«˜çº§)", "Python Regex Syntax", patterns)}
                    </div>
                </div>
            `;
        }

        // 5. ç™½åå•
        function renderWhitelistPanel(data) {
            const { keywords, enable } = data || {};
            return `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">ç™½åå•æ¨¡å¼</h2>
                        <button id="save-whitelist" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium flex items-center">
                            <span id="save-whitelist-text">ä¿å­˜æ›´æ”¹</span>
                            <div id="save-whitelist-loader" class="loader hidden ml-2"></div>
                        </button>
                    </div>

                    <div class="mb-6 bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg border border-yellow-100 dark:border-yellow-800/30">
                        <div class="flex items-center">
                            <input id="wl-enable" type="checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer" ${enable ? 'checked' : ''}>
                            <label for="wl-enable" class="ml-3 block text-sm font-bold text-gray-900 dark:text-gray-200 cursor-pointer">å¯ç”¨ç™½åå•æ¨¡å¼</label>
                        </div>
                        <p class="mt-2 text-sm text-yellow-700 dark:text-yellow-300 ml-8">
                            âš ï¸ å¯ç”¨åï¼Œåªæœ‰åŒ…å«ä»¥ä¸‹å…³é”®è¯çš„æ¶ˆæ¯æ‰ä¼šè¢«è½¬å‘ï¼Œå…¶ä»–æ‰€æœ‰æ¶ˆæ¯ï¼ˆåŒ…æ‹¬åª’ä½“ï¼‰å°†è¢«ä¸¢å¼ƒã€‚ä¼˜å…ˆçº§é«˜äºé»‘åå•ã€‚
                        </p>
                    </div>
                    
                    ${renderTextareaGroup("wl-keywords", "ç™½åå•å…³é”®è¯", "æ¯è¡Œä¸€ä¸ª", keywords, 8)}
                </div>
            `;
        }

        function renderTextareaGroup(id, label, placeholder, valueArr, rows=5) {
            return `
                <div class="flex flex-col">
                    <label for="${id}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">${label}</label>
                    <textarea id="${id}" rows="${rows}" class="flex-1 form-textarea block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm font-mono resize-y" placeholder="${placeholder}">${arrayToText(valueArr)}</textarea>
                </div>
            `;
        }

        // --- äº¤äº’é€»è¾‘ ---

        function navigateToTab(tabId) {
             // æ›´æ–°æ¡Œé¢å¯¼èˆª
             Array.from(mainNav.children).forEach(el => {
                const isActive = el.dataset.tab === tabId;
                el.className = isActive 
                    ? 'nav-link border-blue-500 text-gray-900 dark:text-gray-100 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium'
                    : 'nav-link border-transparent text-gray-500 dark:text-gray-400 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium cursor-pointer';
             });
             
             // æ›´æ–°ç§»åŠ¨ç«¯å¯¼èˆª
             Array.from(mobileNav.children).forEach(el => {
                const isActive = el.dataset.tab === tabId;
                el.className = isActive 
                    ? 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600 dark:text-blue-400'
                    : 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 cursor-pointer';
             });

             // åˆ‡æ¢é¢æ¿
             Array.from(contentPanels.children).forEach(el => {
                if (el.id === `panel-${tabId}`) {
                    el.classList.remove('hidden');
                    setTimeout(() => el.classList.remove('opacity-0'), 10);
                } else {
                    el.classList.add('hidden', 'opacity-0');
                }
             });
        }

        // --- äº‹ä»¶å¤„ç†å‡½æ•° ---

        // è§„åˆ™é¡µé¢é€»è¾‘
        function bindRulesEvents() {
            const toggleBtn = document.getElementById('toggle-add-rule');
            const formContainer = document.getElementById('add-rule-form-container');
            const icon = document.getElementById('add-rule-icon');
            const saveBtn = document.getElementById('save-rule-btn');

            if(toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    formContainer.classList.toggle('hidden');
                    icon.classList.toggle('rotate-45'); // ç®€å•çš„æ—‹è½¬åŠ¨ç”»è¡¨ç¤ºå¼€å…³
                    if(!formContainer.classList.contains('hidden')) {
                        document.getElementById('rule-name').focus();
                    }
                });
            }

            if(saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    // éªŒè¯
                    const name = document.getElementById('rule-name').value.trim();
                    const target = document.getElementById('rule-target').value.trim();
                    if(!name || !target) {
                        alert("è§„åˆ™åç§°å’Œç›®æ ‡ ID ä¸ºå¿…å¡«é¡¹");
                        return;
                    }
                    
                    const payload = {
                        name: name,
                        target_identifier: target,
                        topic_id: document.getElementById('rule-topic').value.trim() ? parseInt(document.getElementById('rule-topic').value) : null,
                        all_keywords: textToArray(document.getElementById('rule-all-kw').value),
                        any_keywords: textToArray(document.getElementById('rule-any-kw').value),
                        file_name_patterns: textToArray(document.getElementById('rule-file-pat').value),
                        file_types: textToArray(document.getElementById('rule-file-types').value)
                    };

                    const btnText = document.getElementById('save-rule-text');
                    const btnLoader = document.getElementById('save-rule-loader');
                    
                    btnText.classList.add('hidden');
                    btnLoader.classList.remove('hidden');
                    saveBtn.disabled = true;
                    
                    try {
                        await apiFetch('/api/rules/add', { method: 'POST', body: payload });
                        state.rules.distribution_rules.push(payload);
                        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                        document.getElementById('panel-rules').innerHTML = renderRulesPanel(state.rules.distribution_rules);
                        bindRulesEvents(); // é‡æ–°ç»‘å®šäº‹ä»¶
                        showReloadNotice();
                    } catch(e) {
                        alert("æ·»åŠ å¤±è´¥: " + e.message);
                    } finally {
                        // æ¢å¤çŠ¶æ€ (é‡æ–°æ¸²æŸ“åå…¶å®ä¸éœ€è¦æ¢å¤ï¼Œå› ä¸ºDOMå·²ç»æ›¿æ¢)
                    }
                });
            }
        }
        
        // æš´éœ²ç»™å…¨å±€ä»¥ä¾¿ onclick è°ƒç”¨
        window.handleRemoveRule = async function(ruleName) {
            if(!confirm(`ç¡®å®šè¦åˆ é™¤è§„åˆ™ "${ruleName}" å—?`)) return;
            try {
                await apiFetch('/api/rules/remove', { method: 'POST', body: { name: ruleName } });
                state.rules.distribution_rules = state.rules.distribution_rules.filter(r => r.name !== ruleName);
                document.getElementById('panel-rules').innerHTML = renderRulesPanel(state.rules.distribution_rules);
                bindRulesEvents();
                showReloadNotice();
            } catch(e) {
                alert("åˆ é™¤å¤±è´¥: " + e.message);
            }
        }

        // ä¿å­˜é€šç”¨é€»è¾‘
        async function handleSaveButton(btnId, apiPath, payloadBuilder, successMsg) {
            const btn = document.getElementById(btnId);
            if(!btn) return;
            const textSpan = btn.querySelector('span');
            const loader = btn.querySelector('.loader');
            
            textSpan.classList.add('hidden');
            loader.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                const payload = payloadBuilder();
                await apiFetch(apiPath, { method: 'POST', body: payload });
                showReloadNotice();
                // Optional: alert(successMsg);
            } catch(e) {
                alert(`æ“ä½œå¤±è´¥: ${e.message}`);
            } finally {
                textSpan.classList.remove('hidden');
                loader.classList.add('hidden');
                btn.disabled = false;
            }
        }
        
        // æºæ“ä½œé€»è¾‘
        async function handleAddSource() {
            const input = document.getElementById('new-source-id');
            const id = input.value.trim();
            if(!id) return;
            
            const btn = document.getElementById('add-source-button');
            const loader = document.getElementById('add-source-loader');
            const text = document.getElementById('add-source-text');
            
            text.classList.add('hidden');
            loader.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                const payload = { identifier: id };
                await apiFetch('/api/sources/add', { method: 'POST', body: payload });
                state.rules.sources.push(payload);
                
                // å±€éƒ¨åˆ·æ–°
                document.getElementById('panel-sources').innerHTML = renderSourcesPanel(state.rules.sources);
                bindSourcesEvents();
                showReloadNotice();
            } catch(e) {
                alert(e.message);
            } finally {
                text.classList.remove('hidden');
                loader.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function bindSourcesEvents() {
            document.getElementById('add-source-button')?.addEventListener('click', handleAddSource);
            document.querySelectorAll('.remove-source-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    if(!confirm(`åˆ é™¤æº ${id}?`)) return;
                    
                    try {
                        await apiFetch('/api/sources/remove', { method: 'POST', body: { identifier: id } });
                        state.rules.sources = state.rules.sources.filter(s => String(s.identifier) !== String(id));
                        document.getElementById('panel-sources').innerHTML = renderSourcesPanel(state.rules.sources);
                        bindSourcesEvents();
                        showReloadNotice();
                    } catch(err) { alert(err.message); }
                });
            });
        }

        // ç»‘å®šæ‰€æœ‰åŠ¨æ€é¢æ¿äº‹ä»¶
        function attachPanelEvents() {
            // Stats
            const dedupSlider = document.getElementById('dedup-slider');
            if(dedupSlider) {
                dedupSlider.addEventListener('input', e => document.getElementById('dedup-days-label').textContent = e.target.value);
                document.getElementById('save-dedup').addEventListener('click', () => handleSaveButton(
                    'save-dedup', '/api/settings/dedup', 
                    () => ({ days: parseInt(dedupSlider.value) }), "å·²ä¿å­˜"
                ));
            }
            
            // Sources
            bindSourcesEvents();
            
            // Rules
            bindRulesEvents();
            
            // Blacklist
            document.getElementById('save-blacklist')?.addEventListener('click', () => handleSaveButton(
                'save-blacklist', '/api/blacklist/update',
                () => ({
                    enable: true,
                    keywords_substring: textToArray(document.getElementById('bl-sub').value),
                    keywords_word: textToArray(document.getElementById('bl-word').value),
                    file_name_keywords: textToArray(document.getElementById('bl-file').value),
                    patterns: textToArray(document.getElementById('bl-regex').value),
                }), "é»‘åå•å·²ä¿å­˜"
            ));
            
            // Whitelist
            document.getElementById('save-whitelist')?.addEventListener('click', () => handleSaveButton(
                'save-whitelist', '/api/whitelist/update',
                () => ({
                    enable: document.getElementById('wl-enable').checked,
                    keywords: textToArray(document.getElementById('wl-keywords').value),
                }), "ç™½åå•å·²ä¿å­˜"
            ));
        }

        // --- åˆå§‹åŒ– ---

        async function loadAllRulesAndRender() {
            try {
                const [rulesData, statsData, settingsData] = await Promise.all([
                    apiFetch('/api/rules'),
                    apiFetch('/api/stats'),
                    apiFetch('/api/settings/dedup')
                ]);
                
                state = { rules: rulesData, stats: statsData, settings: settingsData };

                document.getElementById('panel-status').innerHTML = renderStatsPanel(state.stats, state.settings);
                document.getElementById('panel-sources').innerHTML = renderSourcesPanel(state.rules.sources);
                document.getElementById('panel-rules').innerHTML = renderRulesPanel(state.rules.distribution_rules);
                document.getElementById('panel-blacklist').innerHTML = renderBlacklistPanel(state.rules.ad_filter);
                document.getElementById('panel-whitelist').innerHTML = renderWhitelistPanel(state.rules.whitelist);
                
                attachPanelEvents();
                
            } catch (error) {
                 console.error("åˆå§‹åŒ–åº”ç”¨å¤±è´¥:", error);
                 if (error.message !== "è®¤è¯å¤±è´¥") {
                    contentPanels.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded">åŠ è½½æ•°æ®å¤±è´¥: ${error.message}</div>`;
                 }
            }
        }

        async function initializeApp() {
            // Render Nav
            const tabsHtml = Object.entries(TABS).map(([id, name]) => `
                <a href="#" data-tab="${id}" class="nav-link">
                    ${name}
                </a>
            `).join('');
            mainNav.innerHTML = tabsHtml;
            mobileNav.innerHTML = tabsHtml; // Mobile nav uses simplified classes dynamically

            // Render Shell Placeholders
            contentPanels.innerHTML = Object.keys(TABS).map(id => `
                <div id="panel-${id}" class="${id === 'status' ? '' : 'hidden opacity-0'} transition-opacity duration-200">
                    <div class="flex justify-center p-12"><div class="loader border-gray-400 border-t-blue-500 w-8 h-8 border-4"></div></div>
                </div>
            `).join('');

            // Bind Nav Events
            [mainNav, mobileNav].forEach(nav => {
                nav.addEventListener('click', (e) => {
                    const tab = e.target.dataset.tab;
                    if(tab) {
                        e.preventDefault();
                        navigateToTab(tab);
                    }
                });
            });
            
            // Theme Menu Toggle
            themeToggleButton.addEventListener('click', (e) => {
                e.stopPropagation();
                themeMenu.classList.toggle('hidden');
                setTimeout(() => {
                    themeMenu.classList.toggle('opacity-0');
                    themeMenu.classList.toggle('scale-95');
                }, 10);
            });
            document.addEventListener('click', () => {
                themeMenu.classList.add('opacity-0', 'scale-95');
                setTimeout(() => themeMenu.classList.add('hidden'), 200);
            });
            document.querySelectorAll('.theme-menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    setTheme(e.target.dataset.theme);
                });
            });

            // Initial Style for Tabs
            navigateToTab('status');

            await loadAllRulesAndRender();
        }
        
        // Boot
        const savedTheme = localStorage.getItem('theme') || 'system';
        setTheme(savedTheme);
        checkSavedAuth();

    </script>
</body>
</html>