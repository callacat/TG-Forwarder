<!DOCTYPE html>
<html lang="zh-CN" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG ç»ˆæè½¬å‘å™¨</title>
    
    <!-- 1. å­—ä½“ -->
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    
    <!-- 2. æ ¸å¿ƒæ ·å¼: ä½¿ç”¨é™æ€ Tailwind CSS v2 (ç¨³å®šï¼Œä¸ä¾èµ– JS) -->
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- 3. æ ¸å¿ƒæ ·å¼è¡¥å…¨ä¸è¦†ç›– -->
    <style>
        /* åŸºç¡€é‡ç½® */
        *, ::before, ::after { box-sizing: border-box; }
        
        /* å˜é‡å®šä¹‰ (æ—¥é—´æ¨¡å¼) */
        :root {
            --bg-body: #fafafa;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --border-color: #e4e4e7;
            --text-primary: #18181b;
            --text-secondary: #71717a;
            --text-muted: #a1a1aa;
            --accent-color: #2563eb;     /* Blue 600 */
            --accent-hover: #1d4ed8;     /* Blue 700 */
            
            /* çŠ¶æ€è‰² */
            --success-bg: #dcfce7; --success-text: #15803d;
            --warning-bg: #fef3c7; --warning-text: #b45309;
            --error-bg: #fee2e2;   --error-text: #b91c1c;
        }

        /* å˜é‡å®šä¹‰ (å¤œé—´æ¨¡å¼) */
        .dark {
            --bg-body: #09090b;        /* Zinc 950 */
            --bg-card: #18181b;        /* Zinc 900 */
            --bg-input: #18181b;       /* Zinc 900 */
            --border-color: #27272a;   /* Zinc 800 */
            --text-primary: #f4f4f5;   /* Zinc 100 */
            --text-secondary: #a1a1aa; /* Zinc 400 */
            --text-muted: #52525b;     /* Zinc 600 */
            --accent-color: #3b82f6;   /* Blue 500 */
            --accent-hover: #60a5fa;   /* Blue 400 */
            
            --success-bg: #14532d; --success-text: #4ade80;
            --warning-bg: #451a03; --warning-text: #fbbf24;
            --error-bg: #7f1d1d;   --error-text: #f87171;
        }

        [x-cloak] { display: none !important; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* === ç»„ä»¶ç±» (æ¨¡æ‹Ÿ Tailwind é«˜çº§ç±») === */
        
        /* å¡ç‰‡ */
        .app-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        /* è¾“å…¥æ¡† */
        .app-input, .form-textarea {
            display: block;
            width: 100%;
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-input);
            color: var(--text-primary);
            font-size: 0.875rem;
            line-height: 1.25rem;
            outline: none;
            transition: all 0.2s;
            /* ä¿®å¤å®½åº¦æº¢å‡ºå…³é”® */
            box-sizing: border-box; 
        }
        .app-input:focus, .form-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        .app-input::placeholder { color: var(--text-muted); }

        /* æŒ‰é’® */
        .app-btn {
            background-color: var(--accent-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: opacity 0.2s;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .app-btn:hover { opacity: 0.9; }
        .app-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* é¢œè‰²å·¥å…·ç±» (å…¼å®¹ç°æœ‰ HTML) */
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-muted { color: var(--text-muted); }
        
        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }

        /* Tailwind å…¼å®¹æ€§è¡¥ä¸ (å› ä¸ºé™æ€æ–‡ä»¶æ²¡æœ‰ dark: ç±») */
        .dark .bg-white { background-color: var(--bg-card) !important; }
        .dark .bg-gray-100 { background-color: #27272a !important; } /* Zinc 800 */
        .dark .border-gray-200 { border-color: var(--border-color) !important; }
        .dark .text-gray-500 { color: var(--text-secondary) !important; }
        .dark .text-gray-900 { color: var(--text-primary) !important; }
        
        /* ä¿®å¤ç½‘æ ¼å¸ƒå±€åœ¨ä½ç‰ˆæœ¬æµè§ˆå™¨çš„è¡¨ç° */
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        
        /* ç‰¹å®šé¢œè‰²æ˜ å°„ */
        .bg-blue-600 { background-color: var(--accent-color) !important; }
        .text-blue-600 { color: var(--accent-color) !important; }
        
        /* ç™»å½•æ¡†ä¸“ç”¨ä¿®å¤ */
        .login-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
        }
    </style>

    <!-- 4. Alpine.js (ä½¿ç”¨ cdnjsï¼Œé€šå¸¸æ¯” unpkg æ›´å°‘è¢«æ‹¦æˆª) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.5/cdn.min.js" defer></script>
    
    <script>
        // 5. é˜²å¾¡æ€§å­˜å‚¨å°è£… (è§£å†³ "Tracking Prevention" å´©æºƒé—®é¢˜)
        const SafeStorage = {
            getItem(key) {
                try { return localStorage.getItem(key); } catch (e) { return null; }
            },
            setItem(key, val) {
                try { localStorage.setItem(key, val); } catch (e) { console.warn('Storage blocked'); }
            },
            removeItem(key) {
                try { localStorage.removeItem(key); } catch (e) {}
            }
        };

        function app() {
            return {
                authenticated: false,
                password: '',
                loading: false,
                loadingData: false,
                theme: SafeStorage.getItem('theme') || 'system',
                currentTab: 'status',
                needsReload: false,
                
                stats: {},
                settings: { dedup_retention_days: 30 },
                rules: { sources: [], distribution_rules: [] },
                blacklist: { substring: '', word: '', file: '', regex: '' },
                whitelist: { keywords: '' },
                newSource: '',
                newRule: { name: '', target: '', topic: '', keywords: '', files: '' },
                toasts: [],
                
                tabs: [
                    { id: 'status', name: 'ğŸ“Š çŠ¶æ€æ¦‚è§ˆ' },
                    { id: 'sources', name: 'ğŸ“¡ ç›‘æ§æº' },
                    { id: 'rules', name: 'ğŸ”€ è½¬å‘è§„åˆ™' },
                    { id: 'blacklist', name: 'â›” é»‘åå•' },
                    { id: 'whitelist', name: 'âœ… ç™½åå•' }
                ],

                // å·¥å…·å‡½æ•°
                arrayToText(arr) { return (arr || []).join('\n'); },
                textToArray(text) {
                    if (!text) return [];
                    return text.split('\n').map(s => s.trim()).filter(Boolean);
                },

                async initApp() {
                    const savedPwd = SafeStorage.getItem('tgf_pwd');
                    if (savedPwd) {
                        this.password = savedPwd;
                        await this.login();
                    }
                },

                async login() {
                    this.loading = true;
                    try {
                        const headers = { 'Authorization': 'Basic ' + btoa('admin:' + this.password) };
                        const res = await fetch('/api/rules', { headers });
                        if (res.status === 401) throw new Error('å¯†ç é”™è¯¯');
                        if (!res.ok) throw new Error(`è¿æ¥å¤±è´¥ (${res.status})`);
                        
                        this.authenticated = true;
                        SafeStorage.setItem('tgf_pwd', this.password);
                        await this.fetchAllData();
                        this.showToast('æ¬¢è¿å›æ¥', 'ç™»å½•æˆåŠŸ');
                    } catch (e) {
                        if (e.message === 'å¯†ç é”™è¯¯') {
                            this.password = '';
                            SafeStorage.removeItem('tgf_pwd');
                        }
                        this.showToast('ç™»å½•å¤±è´¥', e.message, 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async api(url, method = 'GET', body = null) {
                    const headers = { 
                        'Authorization': 'Basic ' + btoa('admin:' + this.password),
                        'Content-Type': 'application/json'
                    };
                    const opts = { method, headers };
                    if (body) opts.body = JSON.stringify(body);
                    
                    try {
                        const res = await fetch(url, opts);
                        if (!res.ok) {
                            let errorMsg = `è¯·æ±‚å¤±è´¥ (${res.status})`;
                            try {
                                const err = await res.json();
                                errorMsg = err.detail || errorMsg;
                            } catch (e) {}
                            throw new Error(errorMsg);
                        }
                        return await res.json();
                    } catch (e) {
                        console.error("API Error:", e);
                        throw e;
                    }
                },

                async fetchAllData() {
                    this.loadingData = true;
                    try {
                        const [rules, stats, settings, blacklist, whitelist] = await Promise.all([
                            this.api('/api/rules'),
                            this.api('/api/stats'),
                            this.api('/api/settings/dedup'),
                            this.api('/api/blacklist'),
                            this.api('/api/whitelist')
                        ]);
                        this.rules = rules;
                        this.stats = stats;
                        this.settings = settings;
                        this.blacklist.substring = this.arrayToText(blacklist.keywords_substring);
                        this.blacklist.word = this.arrayToText(blacklist.keywords_word);
                        this.blacklist.file = this.arrayToText(blacklist.file_name_keywords);
                        this.blacklist.regex = this.arrayToText(blacklist.patterns);
                        this.whitelist.keywords = this.arrayToText(whitelist.keywords);
                    } catch (e) {
                        this.showToast('æ•°æ®åŠ è½½å¤±è´¥', e.message, 'error');
                    } finally {
                        this.loadingData = false;
                    }
                },

                async saveSettings() {
                    try {
                        await this.api('/api/settings/dedup', 'POST', { days: parseInt(this.settings.dedup_retention_days) });
                        this.showToast('è®¾ç½®å·²ä¿å­˜');
                    } catch(e) { this.showToast('ä¿å­˜å¤±è´¥', e.message, 'error'); }
                },

                async addSource() {
                    if (!this.newSource) return;
                    try {
                        await this.api('/api/sources/add', 'POST', { identifier: this.newSource });
                        this.rules.sources.push({ identifier: this.newSource, resolved_id: null });
                        this.newSource = '';
                        this.needsReload = true;
                        this.showToast('ç›‘æ§æºå·²æ·»åŠ ');
                    } catch(e) { this.showToast('æ·»åŠ å¤±è´¥', e.message, 'error'); }
                },

                async removeSource(id) {
                    if (!confirm('ç¡®è®¤åˆ é™¤?')) return;
                    try {
                        await this.api('/api/sources/remove', 'POST', { identifier: id });
                        this.rules.sources = this.rules.sources.filter(s => s.identifier !== id);
                        this.needsReload = true;
                        this.showToast('æºå·²ç§»é™¤');
                    } catch(e) { this.showToast('åˆ é™¤å¤±è´¥', e.message, 'error'); }
                },

                async addRule() {
                    if(!this.newRule.name || !this.newRule.target) return this.showToast('è¯·å¡«å†™å®Œæ•´', 'è§„åˆ™åç§°å’Œç›®æ ‡IDå¿…å¡«', 'error');
                    const payload = {
                        name: this.newRule.name,
                        target_identifier: this.newRule.target,
                        topic_id: this.newRule.topic ? parseInt(this.newRule.topic) : null,
                        all_keywords: this.textToArray(this.newRule.keywords),
                        file_name_patterns: this.textToArray(this.newRule.files)
                    };
                    try {
                        await this.api('/api/rules/add', 'POST', payload);
                        this.rules.distribution_rules.push(payload);
                        this.newRule = { name: '', target: '', topic: '', keywords: '', files: '' };
                        this.needsReload = true;
                        this.showToast('è§„åˆ™å·²æ·»åŠ ');
                    } catch(e) { this.showToast('æ·»åŠ å¤±è´¥', e.message, 'error'); }
                },

                async removeRule(name) {
                    if(!confirm('ç¡®è®¤åˆ é™¤?')) return;
                    try {
                        await this.api('/api/rules/remove', 'POST', { name });
                        this.rules.distribution_rules = this.rules.distribution_rules.filter(r => r.name !== name);
                        this.needsReload = true;
                        this.showToast('è§„åˆ™å·²ç§»é™¤');
                    } catch(e) { this.showToast('åˆ é™¤å¤±è´¥', e.message, 'error'); }
                },

                async saveBlacklist() {
                    try {
                        const payload = {
                            enable: true,
                            keywords_substring: this.textToArray(this.blacklist.substring),
                            keywords_word: this.textToArray(this.blacklist.word),
                            file_name_keywords: this.textToArray(this.blacklist.file),
                            patterns: this.textToArray(this.blacklist.regex)
                        };
                        await this.api('/api/blacklist/update', 'POST', payload);
                        this.needsReload = true;
                        this.showToast('é»‘åå•å·²æ›´æ–°');
                    } catch(e) { this.showToast('ä¿å­˜å¤±è´¥', e.message, 'error'); }
                },
                
                async saveWhitelist() {
                    try {
                        const payload = {
                            enable: true,
                            keywords: this.textToArray(this.whitelist.keywords)
                        };
                        await this.api('/api/whitelist/update', 'POST', payload);
                        this.needsReload = true;
                        this.showToast('ç™½åå•å·²æ›´æ–°');
                    } catch(e) { this.showToast('ä¿å­˜å¤±è´¥', e.message, 'error'); }
                },

                toggleTheme() {
                    const modes = ['light', 'dark', 'system'];
                    const next = modes[(modes.indexOf(this.theme) + 1) % modes.length];
                    this.theme = next;
                    SafeStorage.setItem('theme', next);
                },

                showToast(title, message = '', type = 'success') {
                    const id = Date.now();
                    this.toasts.push({ id, title, message, type, visible: true });
                    setTimeout(() => {
                        const t = this.toasts.find(t => t.id === id);
                        if(t) t.visible = false;
                    }, 3000);
                }
            }
        }
    </script>
</head>

<body 
    x-data="app()" 
    x-init="initApp()" 
    :class="{ 'dark': theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) }"
>

    <!-- Toast -->
    <div class="fixed top-4 right-4 z-50 space-y-2 pointer-events-none">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible" x-transition class="pointer-events-auto max-w-xs w-full app-card p-4 flex items-center gap-3 shadow-lg bg-white dark:bg-zinc-900 border-l-4"
                 :class="toast.type === 'success' ? 'border-green-500' : 'border-red-500'">
                <div :class="toast.type === 'success' ? 'text-green-500' : 'text-red-500'">â—</div>
                <div>
                    <div class="text-sm font-bold" x-text="toast.title"></div>
                    <div class="text-xs text-secondary" x-text="toast.message"></div>
                </div>
            </div>
        </template>
    </div>

    <!-- ç™»å½• (ä¿®å¤å®½åº¦å’Œæ ·å¼) -->
    <div x-show="!authenticated" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center login-overlay">
        <div class="app-card p-8 w-full max-w-sm text-center mx-4">
            <div class="w-12 h-12 bg-blue-100 dark:bg-zinc-800 text-blue-600 rounded-xl flex items-center justify-center mx-auto mb-4">ğŸ”’</div>
            <h2 class="text-xl font-bold mb-2">å®‰å…¨éªŒè¯</h2>
            <p class="text-sm text-secondary mb-6">è¯·è¾“å…¥å¯†ç ä»¥ç»§ç»­</p>
            <form @submit.prevent="login">
                <input x-ref="pwd" type="password" x-model="password" class="app-input mb-4" placeholder="è®¿é—®å¯†ç " required>
                <button type="submit" :disabled="loading" class="app-btn w-full flex justify-center items-center gap-2">
                    <span x-show="!loading">è§£é”</span>
                    <span x-show="loading" class="animate-spin">âŒ›</span>
                </button>
            </form>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div x-show="authenticated" x-cloak class="flex-grow flex flex-col">
        <!-- å¯¼èˆª -->
        <nav class="sticky top-0 z-40 backdrop-blur-md border-b" style="background-color: rgba(var(--bg-body), 0.8); border-color: var(--border-color);">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center font-bold">TG</div>
                    <span class="font-bold text-lg hidden md:block">Forwarder</span>
                </div>
                
                <div class="hidden md:flex gap-1 p-1 rounded-xl" style="background-color: var(--border-color);">
                    <template x-for="tab in tabs" :key="tab.id">
                        <button @click="currentTab = tab.id" 
                                :class="currentTab === tab.id ? 'app-card shadow-sm bg-white dark:bg-zinc-800' : 'text-secondary hover:text-primary'"
                                class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all"
                                x-text="tab.name">
                        </button>
                    </template>
                </div>

                <div class="flex items-center gap-3">
                    <button x-show="needsReload" @click="showToast('æç¤º', '/reload ä»¥ç”Ÿæ•ˆ', 'success')" class="text-xs px-3 py-1 rounded-full font-medium hidden md:block" style="background-color: var(--warning-bg); color: var(--warning-text)">
                        é…ç½®å·²å˜æ›´
                    </button>
                    <button @click="toggleTheme" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors text-secondary">
                        <span x-show="theme === 'light'">â˜€ï¸</span>
                        <span x-show="theme === 'dark'">ğŸŒ™</span>
                        <span x-show="theme === 'system'">ğŸ’»</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- ç§»åŠ¨ç«¯ Tab -->
        <div class="md:hidden border-b overflow-x-auto flex px-4 gap-4" style="border-color: var(--border-color);">
            <template x-for="tab in tabs" :key="tab.id">
                <button @click="currentTab = tab.id" 
                        :class="currentTab === tab.id ? 'border-b-2 border-blue-500 text-blue-500' : 'text-secondary'"
                        class="whitespace-nowrap text-sm py-3 font-medium"
                        x-text="tab.name"></button>
            </template>
        </div>

        <main class="flex-grow max-w-7xl mx-auto w-full px-4 py-8 space-y-6">
            
            <!-- çŠ¶æ€æ¦‚è§ˆ -->
            <div x-show="currentTab === 'status' && !loadingData" class="space-y-6">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="app-card p-6">
                        <dt class="text-xs font-bold text-secondary uppercase">æ•°æ®åº“å»é‡</dt>
                        <dd class="mt-2 text-3xl font-bold" x-text="stats.dedup_hashes || 0"></dd>
                    </div>
                    <div class="app-card p-6">
                        <dt class="text-xs font-bold text-secondary uppercase">æ´»è·ƒç›‘æ§æº</dt>
                        <dd class="mt-2 text-3xl font-bold text-blue-600" x-text="stats.sources || 0"></dd>
                    </div>
                    <div class="app-card p-6">
                        <dt class="text-xs font-bold text-secondary uppercase">åˆ†å‘è§„åˆ™</dt>
                        <dd class="mt-2 text-3xl font-bold text-purple-600" x-text="stats.distribution_rules || 0"></dd>
                    </div>
                    <div class="app-card p-6">
                        <dt class="text-xs font-bold text-secondary uppercase">é»‘åå•è¯æ¡</dt>
                        <dd class="mt-2 text-3xl font-bold text-red-600" x-text="(stats.blacklist_substring || 0) + (stats.blacklist_word || 0)"></dd>
                    </div>
                    <div class="app-card p-6">
                        <dt class="text-xs font-bold text-secondary uppercase">ç™½åå•è¯æ¡</dt>
                        <dd class="mt-2 text-3xl font-bold text-green-600" x-text="stats.whitelist_keywords || 0"></dd>
                    </div>
                    <div class="app-card p-6">
                        <dt class="text-xs font-bold text-secondary uppercase">å¤±æ•ˆé“¾æ¥</dt>
                        <dd class="mt-2 text-3xl font-bold text-yellow-600" x-text="stats.invalid_links || 0"></dd>
                    </div>
                </div>

                <div class="app-card p-8">
                    <h3 class="text-lg font-bold mb-6">ç»´æŠ¤è®¾ç½®</h3>
                    <div class="max-w-xl">
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-secondary">å»é‡è®°å½•ä¿ç•™</label>
                            <span class="font-mono font-bold text-blue-600" x-text="settings.dedup_retention_days + ' å¤©'"></span>
                        </div>
                        <input type="range" min="1" max="30" x-model="settings.dedup_retention_days" @change="saveSettings" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                        <p class="mt-2 text-xs text-secondary">ä¿®æ”¹å°†åœ¨ä¸‹ä¸€æ¬¡æ¯æ—¥ä»»åŠ¡æ—¶ç”Ÿæ•ˆã€‚</p>
                    </div>
                </div>
            </div>

            <!-- ç›‘æ§æº -->
            <div x-show="currentTab === 'sources' && !loadingData">
                <div class="app-card overflow-hidden">
                    <div class="p-6 border-b flex flex-col md:flex-row gap-4 justify-between items-center" style="border-color: var(--border-color);">
                        <h3 class="text-lg font-bold">ç›‘æ§æºç®¡ç†</h3>
                        <div class="flex w-full md:w-auto gap-2">
                            <input x-model="newSource" @keyup.enter="addSource" type="text" placeholder="@é¢‘é“ æˆ– ID" class="app-input md:w-64">
                            <button @click="addSource" class="app-btn">æ·»åŠ </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                        <template x-for="source in rules.sources" :key="source.identifier">
                            <div class="app-card p-4 flex justify-between items-start group hover:border-blue-500 transition-colors shadow-sm">
                                <div class="overflow-hidden">
                                    <div class="font-mono font-bold text-sm truncate" x-text="source.identifier"></div>
                                    <div class="flex items-center gap-2 mt-2">
                                        <span x-show="source.resolved_id" class="text-[10px] px-2 py-0.5 rounded font-bold" style="background-color: var(--success-bg); color: var(--success-text)">æ´»è·ƒ</span>
                                        <span x-show="!source.resolved_id" class="text-[10px] px-2 py-0.5 rounded font-bold" style="background-color: var(--warning-bg); color: var(--warning-text)">å¾…è§£æ</span>
                                        <span class="text-xs text-muted font-mono truncate" x-text="source.resolved_id || 'Waiting...'"></span>
                                    </div>
                                </div>
                                <button @click="removeSource(source.identifier)" class="text-muted hover:text-red-500 p-1">ğŸ—‘ï¸</button>
                            </div>
                        </template>
                        <div x-show="rules.sources.length === 0" class="col-span-full p-8 text-center text-secondary">æš‚æ— ç›‘æ§æº</div>
                    </div>
                </div>
            </div>

            <!-- è½¬å‘è§„åˆ™ -->
            <div x-show="currentTab === 'rules' && !loadingData" class="space-y-6">
                <div class="app-card p-6">
                    <h3 class="text-lg font-bold mb-4">æ·»åŠ è§„åˆ™</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input x-model="newRule.name" type="text" placeholder="è§„åˆ™åç§°" class="app-input">
                        <input x-model="newRule.target" type="text" placeholder="ç›®æ ‡ ID" class="app-input">
                        <input x-model="newRule.topic" type="number" placeholder="è¯é¢˜ ID (é€‰å¡«)" class="app-input">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <textarea x-model="newRule.keywords" rows="3" placeholder="å…³é”®è¯ (æ¯è¡Œä¸€ä¸ªï¼Œéœ€å…¨éƒ¨æ»¡è¶³)" class="app-input form-textarea"></textarea>
                        <textarea x-model="newRule.files" rows="3" placeholder="æ–‡ä»¶åæ­£åˆ™ (å¦‚ *.apk)" class="app-input form-textarea"></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button @click="addRule" class="app-btn">ä¿å­˜è§„åˆ™</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <template x-for="rule in rules.distribution_rules" :key="rule.name">
                        <div class="app-card p-5 flex flex-col justify-between group hover:border-blue-500 transition-colors">
                            <div>
                                <div class="flex justify-between items-start">
                                    <h4 class="font-bold text-lg" x-text="rule.name"></h4>
                                    <button @click="removeRule(rule.name)" class="text-xs text-red-500 px-2 py-1 rounded bg-red-50 dark:bg-red-900/20">åˆ é™¤</button>
                                </div>
                                <div class="flex flex-wrap gap-2 mt-3">
                                    <span class="px-2 py-1 rounded text-xs font-mono bg-gray-100 dark:bg-gray-800 text-secondary" x-text="'To: ' + rule.target_identifier"></span>
                                    <span x-show="rule.topic_id" class="px-2 py-1 rounded text-xs font-mono bg-purple-100 dark:bg-purple-900/20 text-purple-600" x-text="'Topic: ' + rule.topic_id"></span>
                                </div>
                                <div class="mt-4 space-y-1">
                                    <div x-show="rule.all_keywords?.length" class="text-xs">
                                        <span class="text-muted">å…³é”®è¯:</span>
                                        <span class="ml-1" x-text="rule.all_keywords.join(', ')"></span>
                                    </div>
                                    <div x-show="rule.file_name_patterns?.length" class="text-xs">
                                        <span class="text-muted">æ–‡ä»¶:</span>
                                        <span class="ml-1" x-text="rule.file_name_patterns.join(', ')"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- é»‘åå• -->
            <div x-show="currentTab === 'blacklist' && !loadingData">
                 <div class="app-card p-6">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b" style="border-color: var(--border-color);">
                        <div>
                            <h3 class="text-lg font-bold">å¹¿å‘Šè¿‡æ»¤</h3>
                            <p class="text-sm text-secondary">å‘½ä¸­ä»»æ„æ¡ä»¶çš„æ¶ˆæ¯å°†è¢«ä¸¢å¼ƒ</p>
                        </div>
                        <button @click="saveBlacklist" class="app-btn">ä¿å­˜æ›´æ”¹</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-secondary">å…³é”®è¯ (ä¸­æ–‡/éƒ¨åˆ†åŒ¹é…)</label>
                            <textarea x-model="blacklist.substring" rows="5" class="app-input form-textarea font-mono text-xs" placeholder="ä¾‹å¦‚ï¼šå‘è´¢å¨±ä¹&#10;è·å®˜"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-secondary">å…³é”®è¯ (è‹±æ–‡/å…¨è¯åŒ¹é…)</label>
                            <textarea x-model="blacklist.word" rows="5" class="app-input form-textarea font-mono text-xs" placeholder="ä¾‹å¦‚ï¼šad&#10;promo"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-secondary">æ–‡ä»¶åè¿‡æ»¤</label>
                            <textarea x-model="blacklist.file" rows="5" class="app-input form-textarea font-mono text-xs" placeholder="ä¾‹å¦‚ï¼šèŠ’æœVPN&#10;å«ç¾è‰.apk"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-secondary">æ­£åˆ™è¡¨è¾¾å¼</label>
                            <textarea x-model="blacklist.regex" rows="5" class="app-input form-textarea font-mono text-xs" placeholder="ä¾‹å¦‚ï¼šgroup[0-9]{5,}"></textarea>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- ç™½åå• -->
            <div x-show="currentTab === 'whitelist' && !loadingData">
                <div class="app-card p-6 border-l-4 border-green-500">
                   <div class="flex justify-between items-center mb-6 pb-4 border-b" style="border-color: var(--border-color);">
                       <div>
                           <h3 class="text-lg font-bold">å¿…å‘ç™½åå•</h3>
                           <p class="text-sm text-secondary">å³ä½¿è§¦å‘é»‘åå•ä¹Ÿä¼šè¢«å¼ºåˆ¶è½¬å‘</p>
                       </div>
                       <button @click="saveWhitelist" class="app-btn bg-green-600 hover:bg-green-700">ä¿å­˜ç™½åå•</button>
                   </div>
                   <div class="space-y-2">
                       <label class="block text-sm font-medium text-secondary">å…³é”®è¯åˆ—è¡¨</label>
                       <textarea x-model="whitelist.keywords" rows="8" class="app-input form-textarea font-mono text-sm" placeholder="ä¾‹å¦‚ï¼šé‡è¦é€šçŸ¥&#10;è€æ¿"></textarea>
                   </div>
                </div>
           </div>

        </main>
    </div>
</body>
</html>