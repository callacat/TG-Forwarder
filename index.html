<!DOCTYPE html>
<html lang="zh-CN" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG Forwarder Pro</title>
    
    <!-- 1. å­—ä½“: Inter -->
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    
    <!-- 2. æ ¸å¿ƒ: Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#030712',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <!-- 3. è‡ªå®šä¹‰æ ·å¼ (type="text/tailwindcss" ä½¿å¾— @apply ç”Ÿæ•ˆ) -->
    <style type="text/tailwindcss">
        [x-cloak] { display: none !important; }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        
        /* æ»‘å—æ ·å¼é‡ç½® */
        input[type=range] { 
            -webkit-appearance: none; /* VSCode è­¦å‘Šå¯å¿½ç•¥ï¼Œè¿™æ˜¯ Chrome/Safari å¿…éœ€çš„ */
            appearance: none;         /* æ ‡å‡†å±æ€§ */
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; 
            height: 16px; width: 16px; border-radius: 50%;
            background: #3b82f6; cursor: pointer; margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #e5e7eb; border-radius: 2px;
        }
        .dark input[type=range]::-webkit-slider-runnable-track { background: #374151; }

        /* æå–çš„ç»„ä»¶ç±» (éœ€è¦ Tailwind CDN å¤„ç†) */
        .form-input, .form-textarea {
            @apply w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-colors;
        }
    </style>

    <!-- 4. åº”ç”¨é€»è¾‘ (å‰ç½®åŠ è½½ï¼Œè§£å†³ app is not defined é—®é¢˜) -->
    <script>
        // é€šç”¨å·¥å…·å‡½æ•°
        const arrayToText = (arr) => (arr || []).join('\n');
        const textToArray = (text) => text.split('\n').map(s => s.trim()).filter(Boolean);

        function app() {
            return {
                authenticated: false,
                password: '',
                loading: false,
                loadingData: false,
                theme: localStorage.getItem('theme') || 'system',
                currentTab: 'status',
                needsReload: false,
                
                // æ•°æ®æ¨¡å‹
                stats: {},
                settings: { dedup_retention_days: 30 },
                rules: { sources: [], distribution_rules: [] },
                blacklist: { substring: '', word: '' },
                
                // ä¸´æ—¶è¡¨å•æ•°æ®
                newSource: '',
                newRule: { name: '', target: '', topic: '', keywords: '', files: '' },
                
                // Toast ç³»ç»Ÿ
                toasts: [],
                
                // Tab å®šä¹‰
                tabs: [
                    { id: 'status', name: 'çŠ¶æ€æ¦‚è§ˆ' },
                    { id: 'sources', name: 'ç›‘æ§æº' },
                    { id: 'rules', name: 'è½¬å‘è§„åˆ™' },
                    { id: 'blacklist', name: 'è¿‡æ»¤é»‘åå•' }
                ],

                async initApp() {
                    // å°è¯•è‡ªåŠ¨ç™»å½•
                    const savedPwd = localStorage.getItem('tgf_pwd');
                    if (savedPwd) {
                        this.password = savedPwd;
                        await this.login();
                    }
                },

                async login() {
                    this.loading = true;
                    try {
                        const headers = { 'Authorization': 'Basic ' + btoa('admin:' + this.password) };
                        const res = await fetch('/api/rules', { headers });
                        if (!res.ok) throw new Error('è®¤è¯å¤±è´¥');
                        
                        this.authenticated = true;
                        localStorage.setItem('tgf_pwd', this.password);
                        await this.fetchAllData();
                        this.showToast('Welcome', 'ç™»å½•æˆåŠŸ', 'success');
                    } catch (e) {
                        this.password = '';
                        localStorage.removeItem('tgf_pwd');
                        this.showToast('Error', 'å¯†ç é”™è¯¯', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async api(url, method = 'GET', body = null) {
                    const headers = { 
                        'Authorization': 'Basic ' + btoa('admin:' + this.password),
                        'Content-Type': 'application/json'
                    };
                    const opts = { method, headers };
                    if (body) opts.body = JSON.stringify(body);
                    
                    const res = await fetch(url, opts);
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.detail || 'è¯·æ±‚å¤±è´¥');
                    }
                    return res.json();
                },

                async fetchAllData() {
                    this.loadingData = true;
                    try {
                        const [rules, stats, settings] = await Promise.all([
                            this.api('/api/rules'),
                            this.api('/api/stats'),
                            this.api('/api/settings/dedup')
                        ]);
                        this.rules = rules;
                        this.stats = stats;
                        this.settings = settings;
                        
                        // æ˜ å°„é»‘åå•æ•°æ®
                        this.blacklist.substring = arrayToText(rules.ad_filter?.keywords_substring);
                        this.blacklist.word = arrayToText(rules.ad_filter?.keywords_word);
                    } catch (e) {
                        this.showToast('API Error', e.message, 'error');
                    } finally {
                        this.loadingData = false;
                    }
                },

                // --- Actions ---
                
                async saveSettings() {
                    try {
                        await this.api('/api/settings/dedup', 'POST', { days: parseInt(this.settings.dedup_retention_days) });
                        this.showToast('Saved', 'è®¾ç½®å·²ä¿å­˜');
                    } catch(e) { this.showToast('Error', e.message, 'error'); }
                },

                async addSource() {
                    if (!this.newSource) return;
                    try {
                        await this.api('/api/sources/add', 'POST', { identifier: this.newSource });
                        this.rules.sources.push({ identifier: this.newSource, resolved_id: null });
                        this.newSource = '';
                        this.needsReload = true;
                        this.showToast('Success', 'æºå·²æ·»åŠ ');
                    } catch(e) { this.showToast('Error', e.message, 'error'); }
                },

                async removeSource(id) {
                    if (!confirm('ç¡®è®¤åˆ é™¤?')) return;
                    try {
                        await this.api('/api/sources/remove', 'POST', { identifier: id });
                        this.rules.sources = this.rules.sources.filter(s => s.identifier !== id);
                        this.needsReload = true;
                        this.showToast('Deleted', 'æºå·²åˆ é™¤');
                    } catch(e) { this.showToast('Error', e.message, 'error'); }
                },

                async addRule() {
                    if(!this.newRule.name || !this.newRule.target) return this.showToast('Warning', 'åç§°å’Œç›®æ ‡å¿…å¡«', 'error');
                    const payload = {
                        name: this.newRule.name,
                        target_identifier: this.newRule.target,
                        topic_id: this.newRule.topic ? parseInt(this.newRule.topic) : null,
                        all_keywords: textToArray(this.newRule.keywords),
                        file_name_patterns: textToArray(this.newRule.files)
                    };
                    try {
                        await this.api('/api/rules/add', 'POST', payload);
                        this.rules.distribution_rules.push(payload);
                        // Reset form
                        this.newRule = { name: '', target: '', topic: '', keywords: '', files: '' };
                        this.needsReload = true;
                        this.showToast('Success', 'è§„åˆ™å·²æ·»åŠ ');
                    } catch(e) { this.showToast('Error', e.message, 'error'); }
                },

                async removeRule(name) {
                    if(!confirm('åˆ é™¤è§„åˆ™?')) return;
                    try {
                        await this.api('/api/rules/remove', 'POST', { name });
                        this.rules.distribution_rules = this.rules.distribution_rules.filter(r => r.name !== name);
                        this.needsReload = true;
                        this.showToast('Deleted', 'è§„åˆ™å·²ç§»é™¤');
                    } catch(e) { this.showToast('Error', e.message, 'error'); }
                },

                async saveBlacklist() {
                    try {
                        const payload = {
                            enable: true,
                            keywords_substring: textToArray(this.blacklist.substring),
                            keywords_word: textToArray(this.blacklist.word),
                            // ä¿ç•™åŸæœ‰çš„å…¶ä»–å­—æ®µ
                            file_name_keywords: this.rules.ad_filter?.file_name_keywords || [],
                            patterns: this.rules.ad_filter?.patterns || []
                        };
                        await this.api('/api/blacklist/update', 'POST', payload);
                        this.needsReload = true;
                        this.showToast('Success', 'é»‘åå•å·²æ›´æ–°');
                    } catch(e) { this.showToast('Error', e.message, 'error'); }
                },

                // --- Utilities ---
                
                toggleTheme() {
                    const modes = ['light', 'dark', 'system'];
                    const next = modes[(modes.indexOf(this.theme) + 1) % modes.length];
                    this.theme = next;
                    localStorage.setItem('theme', next);
                },

                showToast(title, message, type = 'success') {
                    const id = Date.now();
                    this.toasts.push({ id, title, message, type, visible: true });
                    setTimeout(() => {
                        const t = this.toasts.find(t => t.id === id);
                        if(t) t.visible = false;
                    }, 3000); // 3ç§’åæ¶ˆå¤±
                }
            }
        }
    </script>

    <!-- 5. Alpine.js (defer åŠ è½½ï¼Œç¡®ä¿åœ¨ app å®šä¹‰ä¹‹åè¿è¡Œ) -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js"></script>
</head>

<!-- 
    x-data: å…¨å±€çŠ¶æ€ç®¡ç† 
    Theme: è‡ªåŠ¨è¯»å–æœ¬åœ°å­˜å‚¨
-->
<body 
    x-data="app()" 
    x-init="initApp()" 
    class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 transition-colors duration-300 min-h-screen flex flex-col"
    :class="{ 'dark': theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) }"
>

    <!-- Toast é€šçŸ¥ç³»ç»Ÿ (å³ä¸Šè§’) -->
    <div class="fixed top-4 right-4 z-50 space-y-2 pointer-events-none">
        <template x-for="toast in toasts" :key="toast.id">
            <div 
                x-show="toast.visible"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform translate-x-8"
                x-transition:enter-end="opacity-100 transform translate-x-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform translate-x-0"
                x-transition:leave-end="opacity-0 transform translate-x-8"
                class="pointer-events-auto max-w-xs w-full bg-white dark:bg-gray-800 shadow-lg rounded-lg ring-1 ring-black ring-opacity-5 overflow-hidden"
            >
                <div class="p-4 flex items-start">
                    <div class="flex-shrink-0">
                        <!-- Success Icon -->
                        <svg x-show="toast.type === 'success'" class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <!-- Error Icon -->
                        <svg x-show="toast.type === 'error'" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <div class="ml-3 w-0 flex-1 pt-0.5">
                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100" x-text="toast.title"></p>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400" x-text="toast.message"></p>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- ç™»å½•é®ç½© (Glassmorphism) -->
    <div x-show="!authenticated" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl p-8 w-full max-w-sm border border-gray-200 dark:border-gray-800" @click.outside="$refs.pwd.focus()">
            <div class="text-center mb-8">
                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center mx-auto mb-4 text-blue-600 dark:text-blue-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <h2 class="text-xl font-bold">Welcome Back</h2>
            </div>
            <form @submit.prevent="login">
                <input x-ref="pwd" type="password" x-model="password" class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="Enter password..." required>
                <button type="submit" :disabled="loading" class="mt-4 w-full py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-medium transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center">
                    <span x-show="!loading">Unlock</span>
                    <svg x-show="loading" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </form>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div x-show="authenticated" x-cloak class="flex-grow flex flex-col">
        
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="sticky top-0 z-40 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-blue-500/20">TG</div>
                        <span class="font-bold text-lg tracking-tight">Forwarder</span>
                    </div>
                    
                    <!-- æ¡Œé¢ Tab -->
                    <div class="hidden md:flex space-x-1 bg-gray-100 dark:bg-gray-800 p-1 rounded-xl">
                        <template x-for="tab in tabs" :key="tab.id">
                            <button 
                                @click="currentTab = tab.id" 
                                :class="currentTab === tab.id ? 'bg-white dark:bg-gray-700 shadow text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200'"
                                class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all duration-200"
                                x-text="tab.name"
                            ></button>
                        </template>
                    </div>

                    <div class="flex items-center gap-3">
                        <!-- é‡è½½æŒ‰é’® -->
                        <button x-show="needsReload" @click="showToast('Info', 'è¯·åœ¨ Telegram ä¸­å‘é€ /reload ä»¥åº”ç”¨æ›´æ”¹', 'success')" class="text-xs bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 px-3 py-1 rounded-full font-medium animate-pulse">
                            Config Changed
                        </button>
                        <!-- ä¸»é¢˜åˆ‡æ¢ -->
                        <button @click="toggleTheme" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-gray-500">
                            <span x-show="theme === 'light'">â˜€ï¸</span>
                            <span x-show="theme === 'dark'">ğŸŒ™</span>
                            <span x-show="theme === 'system'">ğŸ’»</span>
                        </button>
                    </div>
                </div>
            </div>
            <!-- ç§»åŠ¨ç«¯ Tab -->
            <div class="md:hidden border-t border-gray-200 dark:border-gray-800 overflow-x-auto scrollbar-hide">
                <div class="flex px-4 py-2 space-x-4">
                    <template x-for="tab in tabs" :key="tab.id">
                        <button @click="currentTab = tab.id" :class="currentTab === tab.id ? 'text-blue-600 dark:text-blue-400 font-semibold' : 'text-gray-500'" class="whitespace-nowrap text-sm py-2" x-text="tab.name"></button>
                    </template>
                </div>
            </div>
        </nav>

        <!-- å†…å®¹åŒºåŸŸ -->
        <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Loading State -->
            <div x-show="loadingData" class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-pulse">
                <div class="h-32 bg-gray-200 dark:bg-gray-800 rounded-xl"></div>
                <div class="h-32 bg-gray-200 dark:bg-gray-800 rounded-xl"></div>
                <div class="h-32 bg-gray-200 dark:bg-gray-800 rounded-xl"></div>
            </div>

            <!-- Tab: Status & Settings -->
            <div x-show="currentTab === 'status' && !loadingData" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-gray-900 p-6 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm hover:shadow-md transition-shadow">
                        <dt class="text-sm font-medium text-gray-500">å»é‡å“ˆå¸Œ (Dedup)</dt>
                        <dd class="mt-2 text-3xl font-bold text-gray-900 dark:text-white" x-text="stats.dedup_hashes || 0"></dd>
                    </div>
                    <div class="bg-white dark:bg-gray-900 p-6 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm hover:shadow-md transition-shadow">
                        <dt class="text-sm font-medium text-gray-500">æ´»è·ƒç›‘æ§æº</dt>
                        <dd class="mt-2 text-3xl font-bold text-gray-900 dark:text-white" x-text="stats.sources || 0"></dd>
                    </div>
                    <div class="bg-white dark:bg-gray-900 p-6 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm hover:shadow-md transition-shadow">
                        <dt class="text-sm font-medium text-gray-500">åˆ†å‘è§„åˆ™</dt>
                        <dd class="mt-2 text-3xl font-bold text-gray-900 dark:text-white" x-text="stats.distribution_rules || 0"></dd>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-900 p-8 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm">
                    <h3 class="text-lg font-bold mb-6">ç³»ç»Ÿè®¾ç½®</h3>
                    <div class="max-w-xl">
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-gray-600 dark:text-gray-400">å“ˆå¸Œä¿ç•™å¤©æ•°</label>
                            <span class="font-mono font-bold text-blue-600" x-text="settings.dedup_retention_days + ' Days'"></span>
                        </div>
                        <input type="range" min="1" max="30" x-model="settings.dedup_retention_days" @change="saveSettings" class="w-full">
                        <p class="mt-2 text-xs text-gray-400">å‡å°‘å¤©æ•°å¯ä¼˜åŒ–æ•°æ®åº“ä½“ç§¯ã€‚å°†åœ¨ä¸‹æ¬¡ç»´æŠ¤ä»»åŠ¡ç”Ÿæ•ˆã€‚</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Sources -->
            <div x-show="currentTab === 'sources' && !loadingData" class="space-y-6">
                <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-gray-100 dark:border-gray-800 flex flex-col md:flex-row gap-4 justify-between items-center bg-gray-50/50 dark:bg-gray-800/50">
                        <h3 class="text-lg font-bold">ç›‘æ§æºç®¡ç†</h3>
                        <div class="flex w-full md:w-auto gap-2">
                            <input x-model="newSource" @keyup.enter="addSource" type="text" placeholder="@channel or ID" class="flex-1 md:w-64 px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                            <button @click="addSource" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">æ·»åŠ </button>
                        </div>
                    </div>
                    <div class="divide-y divide-gray-100 dark:divide-gray-800">
                        <template x-for="source in rules.sources" :key="source.identifier">
                            <div class="p-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors group">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono font-medium text-gray-900 dark:text-gray-100" x-text="source.identifier"></span>
                                        <span x-show="source.resolved_id" class="text-[10px] px-1.5 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded font-bold">ACTIVE</span>
                                        <span x-show="!source.resolved_id" class="text-[10px] px-1.5 py-0.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 rounded font-bold">PENDING</span>
                                    </div>
                                    <div class="text-xs text-gray-400 font-mono mt-1" x-text="'ID: ' + (source.resolved_id || 'Waiting for reload...')"></div>
                                </div>
                                <button @click="removeSource(source.identifier)" class="text-gray-300 hover:text-red-500 p-2 transition-colors opacity-0 group-hover:opacity-100">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </template>
                        <div x-show="rules.sources.length === 0" class="p-8 text-center text-gray-500">æš‚æ— ç›‘æ§æº</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Rules (Forwarding) -->
            <div x-show="currentTab === 'rules' && !loadingData" class="space-y-6">
                <!-- Add Rule Card -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4">æ·»åŠ è½¬å‘è§„åˆ™</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input x-model="newRule.name" type="text" placeholder="è§„åˆ™åç§° (å¦‚: æ¬è¿è§†é¢‘)" class="form-input">
                        <input x-model="newRule.target" type="text" placeholder="ç›®æ ‡ ID (-100...)" class="form-input">
                        <input x-model="newRule.topic" type="number" placeholder="Topic ID (å¯é€‰)" class="form-input">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <textarea x-model="newRule.keywords" rows="3" placeholder="åŒ…å«å…³é”®è¯ (æ¯è¡Œä¸€ä¸ª)" class="form-textarea"></textarea>
                        <textarea x-model="newRule.files" rows="3" placeholder="æ–‡ä»¶åæ­£åˆ™ (å¦‚ *.apk)" class="form-textarea"></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button @click="addRule" class="bg-black dark:bg-white text-white dark:text-black px-6 py-2 rounded-lg font-bold text-sm hover:opacity-80 transition-opacity">ä¿å­˜è§„åˆ™</button>
                    </div>
                </div>

                <!-- Rules List -->
                <div class="grid grid-cols-1 gap-4">
                    <template x-for="rule in rules.distribution_rules" :key="rule.name">
                        <div class="bg-white dark:bg-gray-900 p-5 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex justify-between items-start group">
                            <div>
                                <h4 class="font-bold text-gray-900 dark:text-gray-100" x-text="rule.name"></h4>
                                <div class="flex items-center gap-2 mt-2 text-xs text-gray-500">
                                    <span class="bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded" x-text="'To: ' + rule.target_identifier"></span>
                                    <span x-show="rule.topic_id" class="bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded" x-text="'Topic: ' + rule.topic_id"></span>
                                </div>
                            </div>
                            <button @click="removeRule(rule.name)" class="text-xs text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-1 rounded border border-red-200 dark:border-red-900/50 transition-colors">
                                åˆ é™¤
                            </button>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Tab: Blacklist -->
            <div x-show="currentTab === 'blacklist' && !loadingData">
                 <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold">å¹¿å‘Šè¿‡æ»¤ (Blacklist)</h3>
                        <button @click="saveBlacklist" class="text-blue-600 text-sm font-bold hover:underline">ä¿å­˜æ›´æ”¹</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å…³é”®è¯ (ä¸­æ–‡/å­ä¸²)</label>
                            <textarea x-model="blacklist.substring" rows="6" class="form-textarea font-mono text-sm"></textarea>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å…³é”®è¯ (è‹±æ–‡/å…¨è¯)</label>
                            <textarea x-model="blacklist.word" rows="6" class="form-textarea font-mono text-sm"></textarea>
                        </div>
                    </div>
                 </div>
            </div>

        </main>
    </div>
</body>
</html>