<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Forwarder Pro</title>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f5f5f7; --bg-card: rgba(255, 255, 255, 0.7); --text-main: #1d1d1f; --text-sec: #86868b;
            --accent: #007aff; --success: #34c759; --danger: #ff3b30; --warning: #ff9500;
            --border: rgba(0,0,0,0.05); --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .dark {
            --bg-primary: #000000; --bg-card: rgba(28, 28, 30, 0.6); --text-main: #f5f5f7; --text-sec: #86868b;
            --accent: #0a84ff; --success: #30d158; --danger: #ff453a; --warning: #ff9f0a;
            --border: rgba(255,255,255,0.1); --shadow: 0 4px 30px rgba(0,0,0,0.3);
        }
        body { background-color: var(--bg-primary); color: var(--text-main); font-family: 'Inter', sans-serif; transition: background 0.5s ease; }
        
        /* Glassmorphism */
        .glass {
            background: var(--bg-card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 18px; box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .glass-hover:hover { transform: scale(1.02); box-shadow: 0 8px 30px rgba(0,0,0,0.12); cursor: pointer; z-index: 10; }
        .glass-hover:active { transform: scale(0.98); }
        
        /* Controls */
        .input-field {
            width: 100%; padding: 10px 16px; border-radius: 12px; border: 1px solid var(--border);
            background: rgba(120, 120, 128, 0.1); color: var(--text-main); outline: none; transition: 0.2s;
        }
        .input-field:focus { background: transparent; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0,122,255,0.3); }
        
        .btn {
            padding: 8px 20px; border-radius: 99px; font-weight: 600; border: none; cursor: pointer; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-danger { background: rgba(255, 59, 48, 0.1); color: var(--danger); }
        .btn-danger:hover { background: rgba(255, 59, 48, 0.2); }
        
        /* Animations */
        .pulse-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.7); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(52, 199, 89, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0); } }
        
        /* Layout */
        [x-cloak] { display: none; }
        .page-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.5/cdn.min.js" defer></script>
</head>
<body x-data="app()" x-init="init()" class="min-h-screen flex flex-col">

    <!-- Background Glow -->
    <div class="fixed inset-0 pointer-events-none overflow-hidden">
        <div class="absolute -top-20 -left-20 w-96 h-96 bg-blue-500/20 rounded-full blur-3xl opacity-30 animate-pulse"></div>
        <div class="absolute top-40 right-0 w-72 h-72 bg-purple-500/20 rounded-full blur-3xl opacity-20"></div>
    </div>

    <!-- Login Overlay -->
    <div x-show="!auth" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-md" x-transition.opacity>
        <div class="glass p-8 w-full max-w-sm text-center">
            <div class="text-4xl mb-4">ğŸ”’</div>
            <h2 class="text-2xl font-bold mb-2">Forwarder Pro</h2>
            <p class="text-sm text-gray-500 mb-6">éªŒè¯èº«ä»½ä»¥ç»§ç»­</p>
            <form @submit.prevent="login">
                <input type="password" x-model="password" class="input-field text-center tracking-widest text-lg mb-4" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" required>
                <button class="btn btn-primary w-full py-3">è§£é”æ§åˆ¶å°</button>
            </form>
        </div>
    </div>

    <!-- App Content -->
    <div x-show="auth" x-cloak class="relative z-10 max-w-6xl mx-auto w-full p-6 flex-grow flex flex-col">
        
        <!-- Navbar -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3 cursor-pointer" @click="tab='status'">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg shadow-lg">TG</div>
                <div>
                    <h1 class="font-bold text-xl leading-none">ç»ˆæè½¬å‘å™¨</h1>
                    <span class="text-xs text-gray-500 font-mono">V2.6 PRO</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button @click="refresh(true)" class="w-10 h-10 rounded-full glass flex items-center justify-center hover:bg-white/10 transition" title="åˆ·æ–°"><span class="text-xl" :class="{'animate-spin': loading}">â†»</span></button>
                <button @click="toggleTheme" class="w-10 h-10 rounded-full glass flex items-center justify-center hover:bg-white/10 transition">
                    <span x-show="theme=='light'">â˜€ï¸</span><span x-show="theme=='dark'">ğŸŒ™</span>
                </button>
            </div>
        </header>

        <!-- Tab: Dashboard (Status) -->
        <div x-show="tab==='status'" class="page-enter space-y-6">
            
            <!-- Hero Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Bot Status -->
                <div @click="tab='settings'" class="glass glass-hover p-6 flex flex-col justify-between h-32 relative overflow-hidden group">
                    <div class="flex justify-between items-start z-10">
                        <div class="flex items-center gap-2">
                            <div class="pulse-dot" :class="{'bg-red-500 shadow-red-500/50': !stats.bot_connected}"></div>
                            <span class="font-bold text-sm uppercase tracking-wide" :class="stats.bot_connected?'text-green-500':'text-red-500'" x-text="stats.bot_status||'Checking...'"></span>
                        </div>
                        <span class="text-2xl opacity-50">ğŸ¤–</span>
                    </div>
                    <div class="z-10">
                        <div class="text-xs text-gray-500 uppercase font-semibold">Bot å®ä¾‹</div>
                        <div class="text-lg font-bold truncate">Telegram Bot</div>
                    </div>
                    <div class="absolute right-0 bottom-0 w-24 h-24 bg-green-500/10 rounded-full blur-2xl group-hover:bg-green-500/20 transition"></div>
                </div>

                <!-- User Accounts -->
                <div @click="tab='settings'" class="glass glass-hover p-6 flex flex-col justify-between h-32 relative overflow-hidden group">
                    <div class="flex justify-between items-start z-10">
                        <span class="font-bold text-sm text-blue-500 uppercase tracking-wide">åœ¨çº¿ä¼šè¯</span>
                        <span class="text-2xl opacity-50">ğŸ‘¥</span>
                    </div>
                    <div class="z-10">
                        <div class="text-3xl font-bold font-mono" x-text="stats.user_account_count||0">0</div>
                        <div class="text-xs text-gray-500">Active Accounts</div>
                    </div>
                    <div class="absolute right-0 bottom-0 w-24 h-24 bg-blue-500/10 rounded-full blur-2xl group-hover:bg-blue-500/20 transition"></div>
                </div>

                <!-- Uptime -->
                <div class="glass glass-hover p-6 flex flex-col justify-between h-32 relative overflow-hidden group">
                    <div class="flex justify-between items-start z-10">
                        <span class="font-bold text-sm text-purple-500 uppercase tracking-wide">è¿è¡Œæ—¶é—´</span>
                        <span class="text-2xl opacity-50">â±</span>
                    </div>
                    <div class="z-10">
                        <div class="text-lg font-bold font-mono" x-text="stats.uptime||'0s'">...</div>
                        <div class="text-xs text-gray-500">System Uptime</div>
                    </div>
                    <div class="absolute right-0 bottom-0 w-24 h-24 bg-purple-500/10 rounded-full blur-2xl group-hover:bg-purple-500/20 transition"></div>
                </div>
            </div>

            <!-- Navigation Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Source -->
                <div @click="tab='sources'" class="glass glass-hover p-5 flex flex-col gap-2">
                    <div class="flex justify-between"><span class="text-xs font-bold text-gray-500">ç›‘æ§æº</span><span class="text-blue-500">ğŸ“¡</span></div>
                    <div class="text-2xl font-bold" x-text="stats.sources||0"></div>
                </div>
                <!-- Rules -->
                <div @click="tab='rules'" class="glass glass-hover p-5 flex flex-col gap-2">
                    <div class="flex justify-between"><span class="text-xs font-bold text-gray-500">åˆ†å‘è§„åˆ™</span><span class="text-purple-500">ğŸ”€</span></div>
                    <div class="text-2xl font-bold" x-text="stats.distribution_rules||0"></div>
                </div>
                <!-- Blacklist -->
                <div @click="tab='blacklist'" class="glass glass-hover p-5 flex flex-col gap-2">
                    <div class="flex justify-between"><span class="text-xs font-bold text-gray-500">é»‘åå•</span><span class="text-red-500">â›”</span></div>
                    <div class="text-2xl font-bold" x-text="stats.blacklist_count||0"></div>
                </div>
                <!-- Whitelist -->
                <div @click="tab='whitelist'" class="glass glass-hover p-5 flex flex-col gap-2">
                    <div class="flex justify-between"><span class="text-xs font-bold text-gray-500">ç™½åå•</span><span class="text-green-500">âœ…</span></div>
                    <div class="text-2xl font-bold" x-text="stats.whitelist_count||0"></div>
                </div>
                <!-- Filters -->
                <div @click="tab='filter_replace'" class="glass glass-hover p-5 flex flex-col gap-2">
                    <div class="flex justify-between"><span class="text-xs font-bold text-gray-500">è¿‡æ»¤è¯æ±‡</span><span class="text-indigo-500">ğŸ§¹</span></div>
                    <div class="text-2xl font-bold" x-text="stats.content_filter_count||0"></div>
                </div>
                <!-- Replace -->
                <div @click="tab='filter_replace'" class="glass glass-hover p-5 flex flex-col gap-2">
                    <div class="flex justify-between"><span class="text-xs font-bold text-gray-500">æ–‡æœ¬æ›¿æ¢</span><span class="text-pink-500">ğŸ“</span></div>
                    <div class="text-2xl font-bold" x-text="stats.replacements_count||0"></div>
                </div>
                <!-- Dedup -->
                <div class="glass p-5 flex flex-col gap-2 opacity-80">
                    <div class="flex justify-between"><span class="text-xs font-bold text-gray-500">å·²å»é‡</span><span class="text-gray-400">ğŸ’¾</span></div>
                    <div class="text-2xl font-bold" x-text="stats.dedup_hashes||0"></div>
                </div>
                <!-- Dead Links -->
                <div class="glass p-5 flex flex-col gap-2 opacity-80">
                    <div class="flex justify-between"><span class="text-xs font-bold text-gray-500">å¤±æ•ˆé“¾æ¥</span><span class="text-yellow-500">âš ï¸</span></div>
                    <div class="text-2xl font-bold" x-text="stats.invalid_links||0"></div>
                </div>
            </div>
        </div>

        <!-- Tab: Sources -->
        <div x-show="tab==='sources'" class="page-enter">
            <div class="glass p-4 mb-4 flex gap-2 sticky top-0 z-20 backdrop-blur-xl bg-opacity-80">
                <button @click="tab='status'" class="btn bg-gray-200 dark:bg-gray-700 text-sm">â†</button>
                <input x-model="newSource" @keyup.enter="addSource" placeholder="è¾“å…¥é¢‘é“é“¾æ¥æˆ– @username" class="input-field flex-grow">
                <button @click="addSource" class="btn btn-primary">æ·»åŠ </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <template x-for="s in data.sources" :key="s.identifier">
                    <div class="glass p-4 flex items-center gap-4 group">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold text-lg shadow-lg" x-text="getAvatar(s.identifier)"></div>
                        <div class="flex-grow min-w-0">
                            <div class="font-bold truncate" x-text="s.cached_title || s.identifier"></div>
                            <div class="text-xs text-gray-500 font-mono truncate" x-text="s.resolved_id || 'Pending ID...'"></div>
                        </div>
                        <button @click="removeSource(s.identifier)" class="btn-danger w-8 h-8 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition">âœ•</button>
                    </div>
                </template>
            </div>
        </div>

        <!-- Tab: Rules -->
        <div x-show="tab==='rules'" class="page-enter space-y-6">
            <div class="flex items-center gap-4 mb-4">
                <button @click="tab='status'" class="btn bg-gray-200 dark:bg-gray-700 text-sm">â† è¿”å›</button>
                <h2 class="text-xl font-bold">åˆ†å‘è§„åˆ™</h2>
            </div>
            
            <!-- Default Target -->
            <div class="glass p-6 border-l-4 border-yellow-500">
                <h3 class="text-xs font-bold text-yellow-500 uppercase mb-2">é»˜è®¤è½¬å‘ç›®æ ‡ (Fallback)</h3>
                <div class="flex gap-3">
                    <input x-model="settings.default_target" placeholder="Target ID" class="input-field">
                    <input x-model="settings.default_topic_id" placeholder="Topic ID" type="number" class="input-field w-32">
                    <button @click="saveSettings" class="btn btn-primary bg-yellow-500 hover:bg-yellow-600">ä¿å­˜</button>
                </div>
            </div>

            <!-- Add Rule -->
            <div class="glass p-6">
                <h3 class="font-bold mb-4">æ–°å»ºè§„åˆ™</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    <input x-model="newRule.name" placeholder="è§„åˆ™åç§°" class="input-field">
                    <input x-model="newRule.target" placeholder="Target ID" class="input-field">
                    <input x-model="newRule.topic" placeholder="Topic ID" type="number" class="input-field">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                    <input x-model="newRule.all_kw" placeholder="[AND] å…³é”®è¯ (ç©ºæ ¼åˆ†éš”)" class="input-field">
                    <input x-model="newRule.any_kw" placeholder="[OR] å…³é”®è¯ (ç©ºæ ¼åˆ†éš”)" class="input-field">
                    <input x-model="newRule.files" placeholder="æ–‡ä»¶åæ­£åˆ™ (*.apk)" class="input-field">
                </div>
                <button @click="addRule" class="btn btn-primary w-full">æ·»åŠ è§„åˆ™</button>
            </div>

            <!-- Rule List -->
            <div class="space-y-3">
                <template x-for="(rule, idx) in data.distribution_rules" :key="idx">
                    <div class="glass p-4 flex flex-col md:flex-row gap-4 items-center group">
                        <div class="w-8 text-center font-mono text-gray-400 font-bold" x-text="'#'+(idx+1)"></div>
                        <div class="flex-grow w-full">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-lg" x-text="rule.name"></h4>
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                    <button @click="openEdit(rule)" class="text-blue-500 text-sm font-bold px-2">ç¼–è¾‘</button>
                                    <button @click="removeRule(rule.name)" class="text-red-500 text-sm font-bold px-2">åˆ é™¤</button>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-1 mb-2">
                                <span class="px-2 py-0.5 rounded bg-gray-100 dark:bg-gray-800 text-xs font-mono" x-text="rule.target_identifier"></span>
                                <span x-show="rule.topic_id" class="px-2 py-0.5 rounded bg-purple-500/10 text-purple-500 text-xs font-mono" x-text="'T:'+rule.topic_id"></span>
                            </div>
                            <div class="text-xs text-gray-500 space-x-2">
                                <span x-show="rule.all_keywords.length">AND: <span x-text="rule.all_keywords.join(', ')"></span></span>
                                <span x-show="rule.any_keywords.length">OR: <span x-text="rule.any_keywords.join(', ')"></span></span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Tab: Filter/Replace, Blacklist, Whitelist, Settings (Simplified structure for brevity, logic same) -->
        <div x-show="['blacklist','whitelist','filter_replace','settings'].includes(tab)" class="page-enter">
            <div class="flex items-center gap-4 mb-6">
                <button @click="tab='status'" class="btn bg-gray-200 dark:bg-gray-700 text-sm">â† è¿”å›ä»ªè¡¨ç›˜</button>
                <h2 class="text-xl font-bold capitalize" x-text="tabNameMap[tab]"></h2>
            </div>
            
            <!-- Blacklist -->
            <div x-show="tab==='blacklist'" class="glass p-6">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div><label class="text-xs font-bold text-gray-500">ä¸­æ–‡åŒ¹é…</label><textarea x-model="blacklist.substring" rows="5" class="input-field mt-1"></textarea></div>
                     <div><label class="text-xs font-bold text-gray-500">è‹±æ–‡å…¨è¯</label><textarea x-model="blacklist.word" rows="5" class="input-field mt-1"></textarea></div>
                 </div>
                 <button @click="saveBlacklist" class="btn btn-primary mt-4 w-full bg-red-500 hover:bg-red-600">ä¿å­˜é»‘åå•</button>
            </div>

            <!-- Whitelist -->
            <div x-show="tab==='whitelist'" class="glass p-6">
                <textarea x-model="whitelist.keywords" rows="10" class="input-field" placeholder="æ¯è¡Œä¸€ä¸ªå…³é”®è¯..."></textarea>
                <button @click="saveWhitelist" class="btn btn-primary mt-4 w-full bg-green-500 hover:bg-green-600">ä¿å­˜ç™½åå•</button>
            </div>

            <!-- Filter & Replace -->
            <div x-show="tab==='filter_replace'" class="space-y-6">
                <div class="glass p-6">
                    <h3 class="font-bold mb-3">å†…å®¹è¿‡æ»¤</h3>
                    <div class="flex gap-4 mb-3 items-center">
                        <span class="text-sm">å¯ç”¨:</span> <input type="checkbox" x-model="content_filter.enable" class="w-5 h-5">
                        <span class="text-sm ml-4">æœ€å°é•¿åº¦:</span> <input type="number" x-model="content_filter.min_meaningful_length" class="input-field w-24 py-1">
                    </div>
                    <textarea x-model="content_filter.meaningless_text" rows="3" class="input-field" placeholder="æ— æ„ä¹‰è¯æ±‡ (æ¯è¡Œä¸€ä¸ª)"></textarea>
                    <button @click="saveContentFilter" class="btn btn-primary mt-3 w-full">ä¿å­˜è¿‡æ»¤é…ç½®</button>
                </div>
                <div class="glass p-6">
                    <h3 class="font-bold mb-3">æ–‡æœ¬æ›¿æ¢</h3>
                    <div class="space-y-2 mb-3">
                        <template x-for="(r, i) in replacements_list" :key="i">
                            <div class="flex gap-2">
                                <input x-model="r.key" class="input-field py-1" placeholder="åŸæ–‡æœ¬">
                                <span class="self-center">â†’</span>
                                <input x-model="r.val" class="input-field py-1" placeholder="æ–°æ–‡æœ¬">
                                <button @click="replacements_list.splice(i,1)" class="text-red-500 px-2">Ã—</button>
                            </div>
                        </template>
                    </div>
                    <button @click="replacements_list.push({key:'',val:''})" class="text-sm text-blue-500 font-bold">+ æ·»åŠ è§„åˆ™</button>
                    <button @click="saveReplacements" class="btn btn-primary mt-3 w-full">ä¿å­˜æ›¿æ¢é…ç½®</button>
                </div>
            </div>

            <!-- Settings -->
            <div x-show="tab==='settings'" class="glass p-8 max-w-2xl mx-auto space-y-6">
                <div>
                    <label class="block text-sm font-bold text-gray-500 mb-2">è½¬å‘æ¨¡å¼</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div @click="settings.forwarding_mode='copy'" :class="settings.forwarding_mode=='copy'?'border-blue-500 bg-blue-500/10 text-blue-500':''" class="border-2 border-transparent bg-gray-100 dark:bg-gray-800 p-4 rounded-xl text-center font-bold cursor-pointer transition">Copy (å¤åˆ¶)</div>
                        <div @click="settings.forwarding_mode='forward'" :class="settings.forwarding_mode=='forward'?'border-blue-500 bg-blue-500/10 text-blue-500':''" class="border-2 border-transparent bg-gray-100 dark:bg-gray-800 p-4 rounded-xl text-center font-bold cursor-pointer transition">Forward (è½¬å‘)</div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-500 mb-2">å»é‡è®°å½•ä¿ç•™ (å¤©)</label>
                    <input type="range" min="1" max="60" x-model="settings.dedup_retention_days" class="w-full accent-blue-500">
                    <div class="text-right font-mono text-blue-500 font-bold" x-text="settings.dedup_retention_days"></div>
                </div>
                <div class="space-y-3">
                    <label class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"><span class="font-medium">åªå¤„ç†æ–°æ¶ˆæ¯</span><input type="checkbox" x-model="settings.forward_new_only" class="w-5 h-5"></label>
                    <label class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"><span class="font-medium">æºé¢‘é“è‡ªåŠ¨å·²è¯»</span><input type="checkbox" x-model="settings.mark_as_read" class="w-5 h-5"></label>
                    <label class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"><span class="font-medium">ç›®æ ‡é¢‘é“è‡ªåŠ¨å·²è¯»</span><input type="checkbox" x-model="settings.mark_target_as_read" class="w-5 h-5"></label>
                </div>
                <button @click="saveSettings" class="btn btn-primary w-full py-3 text-lg">ä¿å­˜ç³»ç»Ÿè®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div x-show="editModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-transition.opacity>
        <div class="glass p-8 w-full max-w-2xl relative">
            <h3 class="text-2xl font-bold mb-6">ç¼–è¾‘è§„åˆ™</h3>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <input x-model="editRule.name" placeholder="åç§°" class="input-field">
                <input x-model="editRule.target" placeholder="Target ID" class="input-field">
                <input x-model="editRule.topic" placeholder="Topic" class="input-field">
            </div>
            <div class="grid grid-cols-3 gap-4 mb-6">
                <textarea x-model="editRule.all_kw" class="input-field h-24" placeholder="AND Keywords"></textarea>
                <textarea x-model="editRule.any_kw" class="input-field h-24" placeholder="OR Keywords"></textarea>
                <textarea x-model="editRule.files" class="input-field h-24" placeholder="Files"></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button @click="editModal=false" class="btn bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300">å–æ¶ˆ</button>
                <button @click="doSaveRule" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        const api = {
            get: async (url) => (await fetch(url, { headers: { 'Authorization': 'Basic ' + btoa('admin:' + localStorage.getItem('pwd')) } })).json(),
            post: async (url, data) => (await fetch(url, { method: 'POST', headers: { 'Authorization': 'Basic ' + btoa('admin:' + localStorage.getItem('pwd')), 'Content-Type': 'application/json' }, body: JSON.stringify(data) })).json()
        };

        function app() {
            return {
                auth: false, password: '', loading: false, theme: 'dark', tab: 'status', editModal: false,
                stats: {}, data: { sources: [], distribution_rules: [] }, settings: {},
                blacklist: {substring:'', word:'', file:'', regex:''}, whitelist: {keywords:''}, 
                content_filter: {enable:true, meaningless_text:'', min_meaningful_length:5},
                replacements_list: [],
                newSource: '', newRule: {name:'', target:'', topic:'', all_kw:'', any_kw:'', files:''},
                editRule: {}, editOriginalName: '',
                
                tabNameMap: {'blacklist':'é»‘åå•', 'whitelist':'ç™½åå•', 'filter_replace':'è¿‡æ»¤ä¸æ›¿æ¢', 'settings':'ç³»ç»Ÿè®¾ç½®'},

                async init() {
                    const saved = localStorage.getItem('pwd');
                    this.theme = localStorage.getItem('theme') || 'dark';
                    this.applyTheme();
                    if (saved) { this.password = saved; await this.login(); }
                    
                    // Auto refresh
                    setInterval(() => { if(this.auth && !document.hidden) this.refresh(false); }, 5000);
                },

                applyTheme() { document.documentElement.className = this.theme; },
                toggleTheme() { this.theme = this.theme === 'dark' ? 'light' : 'dark'; localStorage.setItem('theme', this.theme); this.applyTheme(); },

                async login() {
                    this.loading = true;
                    try {
                        await api.get('/api/rules'); // Test auth
                        this.auth = true;
                        localStorage.setItem('pwd', this.password);
                        await this.refresh(true);
                    } catch(e) { alert('Login Failed'); localStorage.removeItem('pwd'); }
                    this.loading = false;
                },

                async refresh(full=false) {
                    if(full) this.loading = true;
                    try {
                        const [s, r, sett, bl, wl, cf, rep] = await Promise.all([
                            api.get('/api/stats'), api.get('/api/rules'), api.get('/api/settings'),
                            api.get('/api/blacklist'), api.get('/api/whitelist'), 
                            api.get('/api/content_filter'), api.get('/api/replacements')
                        ]);
                        this.stats = s; this.data = r; this.settings = sett;
                        
                        // Map complex objects to flat strings for textareas
                        const join = (arr) => (arr||[]).join('\n');
                        this.blacklist = { substring: join(bl.keywords_substring), word: join(bl.keywords_word), file: join(bl.file_name_keywords), regex: join(bl.patterns) };
                        this.whitelist.keywords = join(wl.keywords);
                        this.content_filter = { ...cf, meaningless_text: join(cf.meaningless_words) };
                        this.replacements_list = Object.entries(rep).map(([k,v]) => ({key:k, val:v}));
                        
                    } catch(e) { console.error(e); }
                    if(full) this.loading = false;
                },
                
                getAvatar(id) { return (id||'?').substring(0,2).toUpperCase(); },
                
                // Actions
                async addSource() { await api.post('/api/sources/add', { identifier: this.newSource }); this.newSource=''; this.refresh(); },
                async removeSource(id) { if(confirm('Del?')) { await api.post('/api/sources/remove', { identifier: id }); this.refresh(); } },
                
                async addRule() { 
                    const payload = this.fmtRule(this.newRule); 
                    await api.post('/api/rules/add', payload); 
                    this.newRule = {name:'', target:'', topic:'', all_kw:'', any_kw:'', files:''}; 
                    this.refresh(); 
                },
                
                openEdit(rule) {
                    const join = (arr) => (arr||[]).join('\n');
                    this.editRule = { 
                        name: rule.name, target: rule.target_identifier, topic: rule.topic_id,
                        all_kw: join(rule.all_keywords), any_kw: join(rule.any_keywords), files: join(rule.file_name_patterns)
                    };
                    this.editOriginalName = rule.name;
                    this.editModal = true;
                },
                
                async doSaveRule() {
                    const payload = this.fmtRule(this.editRule);
                    await api.post(`/api/rules/update_single?name_to_replace=${encodeURIComponent(this.editOriginalName)}`, payload);
                    this.editModal = false;
                    this.refresh();
                },
                
                async removeRule(name) { if(confirm('Del?')) { await api.post('/api/rules/remove', {name}); this.refresh(); } },
                
                fmtRule(d) {
                    const split = (s) => (s||'').split('\n').map(x=>x.trim()).filter(x=>x);
                    return {
                        name: d.name, target_identifier: d.target, topic_id: parseInt(d.topic)||null,
                        all_keywords: split(d.all_kw), any_keywords: split(d.any_kw), file_name_patterns: split(d.files)
                    };
                },

                async saveBlacklist() {
                    const split = (s) => (s||'').split('\n').map(x=>x.trim()).filter(x=>x);
                    const payload = { enable:true, keywords_substring: split(this.blacklist.substring), keywords_word: split(this.blacklist.word), file_name_keywords: split(this.blacklist.file), patterns: split(this.blacklist.regex) };
                    await api.post('/api/blacklist/update', payload); this.refresh();
                },
                async saveWhitelist() {
                    await api.post('/api/whitelist/update', { enable:true, keywords: (this.whitelist.keywords||'').split('\n').filter(x=>x) }); this.refresh();
                },
                async saveContentFilter() {
                    const payload = { ...this.content_filter, meaningless_words: (this.content_filter.meaningless_text||'').split('\n').filter(x=>x) };
                    await api.post('/api/content_filter/update', payload); this.refresh();
                },
                async saveReplacements() {
                    const map = {}; this.replacements_list.forEach(x => { if(x.key) map[x.key] = x.val; });
                    await api.post('/api/replacements/update', map); this.refresh();
                },
                async saveSettings() {
                    await api.post('/api/settings/update', this.settings); this.refresh();
                }
            }
        }
    </script>
</body>
</html>