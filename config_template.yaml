# config_template.yaml
# TG Ultimate Forwarder - 终极转发器 配置文件

# --- (新) 全局配置 ---
docker_container_name: "tgf" # 你 `docker run --name` 时使用的容器名，用于登录提示

# --- (新) Bot 服务配置 ---
bot_service:
  enabled: true
  # 从 @BotFather 获取你的 Token
  bot_token: "123456:ABC-DEF1234567890"
  # (重要!) 你的个人 Telegram 数字 ID (可以从 @userinfobot 获取)
  # 只有列表中的用户才能使用 Bot 命令
  admin_user_ids:
    - 123456789 # 替换为你自己的 ID

# --- 1. 代理配置 (可选) ---
# proxy:
#   enabled: false
#   proxy_type: "socks5" # "socks5", "socks4", "http"
#   addr: "127.0.0.1"
#   port: 1080
#   username: ""
#   password: ""

# --- 2. 账号配置 (必需) ---
# (新) 这是你的 *用户* 账号，用于监控和转发，不是 Bot 账号
accounts:
  # --- 方式 A: 会话文件 (推荐 Docker / 本地) ---
  # (程序启动时会要求你交互式登录，文件会保存在 /app/data 中)
  - api_id: 123456
    api_hash: "0123456789abcdef0123456789abcdef"
    session_name: "account_1" # 会话文件名 (例如 "account_1")
    enabled: true
  
  # (新) 你可以添加多个用户账号，程序会自动轮换
  # - api_id: 123457
  #   api_hash: "0123456789abcdef0123456789abcde0"
  #   session_name: "account_2"
  #   enabled: true

# --- 3. 监控源 (必需) ---
# (新) `identifier` 支持三种格式:
#   1. 数字 ID: -1001234567890
#   2. 用户名: "@MyChannelName"
#   3. 链接: "https://t.me/MyChannelName"
# (重要!) 你的 `accounts` 中的账号 *必须* 加入这些频道才能监控
sources:
  - identifier: -1001234567890 # (必需) 源频道/群组 标识符
    check_replies: true    # (可选) 是否检查此频道的评论区 (TODO)
    replies_limit: 5       # (可选) 检查评论区的最后5条
    forward_new_only: null # (可选) 覆盖全局设置, true/false
  # - identifier: "@SomeOtherChannel"
  # - identifier: "https://t.me/AnotherPublicChannel"

# --- 4. 转发目标 (必需) ---
targets:
  # (新) 默认目标，同样支持三种格式
  default_target: -1009876543210
  
  # (已更新) 规则按 *优先级* (从上到下) 匹配，第一个命中的规则生效。
  
  # (新) 规则逻辑:
  # 匹配 = (满足 *所有* all_keywords [AND]) 
  #       AND 
  #       (满足 *任一* any_keywords [OR] 满足 *任一* file_types [OR] 满足 *任一* file_name_patterns)
  
  # 建议: 从最具体到最笼统排序
  distribution_rules:
    # --- 平台与类型组合 (最具体) ---
    - name: "Windows 工具"
      all_keywords: ["工具", "软件", "app"]   # [AND] 必须包含"工具"
      any_keywords: ["Windows", "PC", "Win"] # [OR] 包含 "Windows"
      target_identifier: -1009876543210 
      topic_id: 10 # 假设是 "Windows 软件" 话题

    - name: "Android 工具"
      all_keywords: ["工具", "软件", "app"]     # [AND] 必须包含"工具"
      any_keywords: ["Android", "安卓", "APK"] # [OR] 包含 "Android"
      target_identifier: -1009876543210 
      topic_id: 11 # 假设是 "Android 软件" 话题

    - name: "iOS 工具"
      all_keywords: ["工具", "软件", "app"] # [AND] 必须包含"工具"
      any_keywords: ["iOS", "iPhone", "iPad", "ipa"] # [OR] 包含 "iOS"
      target_identifier: -1009876543210 
      topic_id: 12 # 假设是 "iOS 软件" 话题
      
    # --- 类型 (子类) ---
    - name: "动漫 (影视子类)"
      any_keywords: ["动漫", "新番", "BDRip"]
      target_identifier: -1009876543210
      topic_id: 20 # 假设是 "动漫" 话题

    - name: "电影 (影视子类)"
      any_keywords: ["电影", "BluRay", "4K", "REMUX"]
      target_identifier: -1009876543210
      topic_id: 21 # 假设是 "电影" 话题

    - name: "剧集 (影视子类)"
      any_keywords: ["剧集", "S01E", "第一季", "更新至"]
      target_identifier: -1009876543210
      topic_id: 22 # 假设是 "剧集" 话题

    # --- 类型 (通用) ---
    - name: "通用影视 (兜底)"
      any_keywords: ["#影视", "预告", "片"] # 匹配上面没匹配到的
      target_identifier: -1009876543210
      topic_id: 23 # 假设是 "其他影视" 话题

    - name: "通用工具 (兜底)"
      any_keywords: ["#工具", "#软件", "App"] # 匹配上面没匹配到的
      target_identifier: -1009876543210
      topic_id: 13 # 假设是 "其他工具" 话题

    # --- 文件类型分发 ---
    - name: "视频文件"
      file_types: ["video/mp4", "video/x-mkv"] # 匹配 MIME Type
      file_name_patterns: ["*.mkv", "*.rmvb", "*.mp4"] # 匹配文件名
      target_identifier: -1009876543210
      topic_id: 20 # 也发到 "动漫" 话题 (示例)

    # --- 其他类型 ---
    - name: "新闻"
      any_keywords: ["#新闻", "快讯", "报道"]
      target_identifier: -10011112222333 # (示例) 转发到另一个频道

    # (注意) "日常碎碎念"类 不需要规则，它们会自动进入 `default_target`

# --- 5. 转发行为 ---
forwarding:
  # 转发模式:
  # "forward" = 转发 (保留来源，但如果源频道禁止转发则失败)
  # "copy"    = 复制 (作为新消息发送，可突破转发限制)
  mode: "forward"
  # 是否只转发新消息:
  # true  = (默认) 只处理程序启动后收到的新消息。
  # false = 程序启动时，会回溯所有源频道的历史消息 (从上次停止的地方开始)。
  forward_new_only: true

# --- 6. 过滤器 (可选) ---
#
# 过滤逻辑优先级:
# 1. 白名单 (Whitelist):
#    - 如果 `whitelist: enable: true`:
#    - 只有 *命中* 白名单的消息会 [通过]，并跳过所有黑名单。
#    - 未命中白名单的消息会被 [过滤]。
# 2. 黑名单 (Ad/Content Filter):
#    - 如果 `whitelist: enable: false`:
#    - 消息默认 [通过]。
#    - 但如果 *命中* `ad_filter` 或 `content_filter`，消息会被 [过滤]。
# 3. 默认:
#    - 如果所有过滤器都 `enable: false`，所有消息 [通过]。
#
ad_filter:
  enable: true
  keywords:
    - "广告"
    - "推广"
    - "t.me/ad_channel"
  patterns: # 正则表达式
    - "group[0-9]{3,}"

content_filter:
  enable: true
  meaningless_words: ["顶", "up", "1", "mark"]
  min_meaningful_length: 10 # 纯文本消息的最小长度 (无媒体时)

whitelist:
  enable: false
  keywords:
    - "#MyKeep"
    - "重要"

# --- 7. 内容处理 ---
deduplication:
  enable: true
  db_path: "/app/data/dedup_db.json" # 存储哈希的JSON文件路径

link_extraction:
  check_hyperlinks: false # 是否解析 telegra.ph 和机器人超链接 (TODO)
  check_bots: false       # 是否模拟点击机器人按钮 (TODO)

replacements:
  # "目标内容": "源内容"
  "": "#ad" # 删除 #ad 标签 
  "TG 终极转发器": "TG Bot"
  "t.me/some_other_channel": "" 

# --- 8. 失效链接检测器 (可选) ---
# (新) 可以通过 Bot 的 /run_checklinks 命令触发
link_checker:
  enabled: true
  # "log"    = 只在日志中报告
  # "edit"   = 编辑原消息，标注 [链接已失效]
  # "delete" = 删除包含失效链接的消息
  mode: "edit"
  schedule: "0 3 * * *" # (TODO) 定时任务尚未实现, 请使用 Bot 手动触发